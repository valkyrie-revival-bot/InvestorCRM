---
phase: 04.5-contact-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["04.5-01"]
files_modified:
  - lib/csv/parser.ts
  - lib/csv/company-normalizer.ts
  - app/actions/linkedin.ts
  - app/(dashboard)/linkedin/import/page.tsx
  - app/(dashboard)/linkedin/import/_components/csv-uploader.tsx
  - app/(dashboard)/linkedin/import/_components/import-results.tsx
  - app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /linkedin/import from the dashboard sidebar"
    - "User can select a team member name and upload a LinkedIn CSV file"
    - "System parses the CSV (including LinkedIn's 'Notes' preamble lines), validates rows, and shows import count"
    - "System stores validated contacts in linkedin_contacts table with normalized company names"
    - "System handles duplicate imports gracefully (skips existing linkedin_url + team_member_name pairs)"
    - "User sees clear success/error feedback with counts (imported, skipped, errors)"
  artifacts:
    - path: "lib/csv/parser.ts"
      provides: "PapaParse wrapper that handles LinkedIn CSV format including Notes preamble"
      exports: ["parseLinkedInCSV"]
    - path: "lib/csv/company-normalizer.ts"
      provides: "Company name normalization (remove legal suffixes, lowercase, trim)"
      exports: ["normalizeCompanyName"]
    - path: "app/actions/linkedin.ts"
      provides: "Server actions for LinkedIn CSV import"
      exports: ["importLinkedInCSV", "getLinkedInImportStats"]
    - path: "app/(dashboard)/linkedin/import/page.tsx"
      provides: "LinkedIn import page UI"
    - path: "app/(dashboard)/linkedin/import/_components/csv-uploader.tsx"
      provides: "CSV file upload form component with team member selection"
    - path: "app/(dashboard)/linkedin/import/_components/import-results.tsx"
      provides: "Import results display with counts and errors"
  key_links:
    - from: "app/(dashboard)/linkedin/import/_components/csv-uploader.tsx"
      to: "app/actions/linkedin.ts"
      via: "form action"
      pattern: "importLinkedInCSV"
    - from: "app/actions/linkedin.ts"
      to: "lib/csv/parser.ts"
      via: "function call"
      pattern: "parseLinkedInCSV"
    - from: "app/actions/linkedin.ts"
      to: "lib/csv/company-normalizer.ts"
      via: "function call"
      pattern: "normalizeCompanyName"
    - from: "app/actions/linkedin.ts"
      to: "lib/validations/linkedin-schema.ts"
      via: "function call"
      pattern: "validateLinkedInRows"
    - from: "app/(dashboard)/layout.tsx"
      to: "app/(dashboard)/linkedin/import/page.tsx"
      via: "sidebar navigation link"
      pattern: "/linkedin/import"
---

<objective>
Build the complete LinkedIn CSV import pipeline — from file upload UI to database storage.

Purpose: Users need to import their LinkedIn connections (4 team members, ~26K total contacts) so the system can later detect relationships with investors. This is the data ingestion vertical slice.
Output: Working /linkedin/import page where users select a team member, upload a CSV, and see import results with counts.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.5-contact-intelligence/04.5-RESEARCH.md
@.planning/phases/04.5-contact-intelligence/04.5-01-SUMMARY.md

Existing patterns:
@app/actions/investors.ts — Server action pattern (auth check, Supabase operations, error handling)
@app/(dashboard)/layout.tsx — Dashboard layout with sidebar navigation
@lib/validations/linkedin-schema.ts — Zod schema from Plan 01
@types/linkedin.ts — Type definitions from Plan 01

LinkedIn CSV format (CRITICAL):
- Files start with 2 lines of "Notes" before headers
- Line 1: "Notes:"
- Line 2: "When exporting your connection data..." (quoted string)
- Line 3: empty line (sometimes)
- Line 4: "First Name,Last Name,URL,Email Address,Company,Position,Connected On"
- Data rows follow
- Date format: "10 Feb 2026"
- Email is often empty
- Total: ~26K contacts across 4 files (Jackson alone has ~19K)
</context>

<tasks>

<task type="auto">
  <name>Task 1: CSV parser and company normalizer utilities</name>
  <files>
    lib/csv/parser.ts
    lib/csv/company-normalizer.ts
  </files>
  <action>
    **lib/csv/company-normalizer.ts:**
    Create a company name normalizer function. This is critical for matching LinkedIn contacts to investor firms. Follow the research recommendation:

    ```typescript
    export function normalizeCompanyName(name: string): string {
      if (!name) return '';
      return name
        .toLowerCase()
        .trim()
        // Remove common legal entity suffixes (with optional trailing period)
        .replace(/\b(inc|incorporated|corp|corporation|llc|llp|ltd|limited|co|company|pllc|lp|plc|group|partners|holdings|capital|management|advisors|advisory)\b\.?\s*$/gi, '')
        // Remove trailing punctuation left after suffix removal
        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]+$/, '')
        // Remove internal punctuation but keep spaces
        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, ' ')
        // Normalize whitespace
        .replace(/\s+/g, ' ')
        .trim();
    }
    ```

    **lib/csv/parser.ts:**
    Create a PapaParse wrapper that handles the LinkedIn CSV format. CRITICAL: LinkedIn CSVs have 2-3 lines of "Notes" preamble before the actual header row. The parser must:

    1. Read the file as text
    2. Find the actual header line by scanning for "First Name" (skips Notes preamble)
    3. Parse only from the header line onward using PapaParse
    4. Transform headers to snake_case to match our Zod schema field names

    ```typescript
    import Papa from 'papaparse';

    // Header mapping: LinkedIn CSV header -> our schema field name
    const HEADER_MAP: Record<string, string> = {
      'First Name': 'first_name',
      'Last Name': 'last_name',
      'URL': 'linkedin_url',
      'Email Address': 'email',
      'Company': 'company',
      'Position': 'position',
      'Connected On': 'connected_on',
    };

    export function parseLinkedInCSV(csvText: string): {
      data: Record<string, string>[];
      errors: Papa.ParseError[];
      totalRows: number;
    } {
      // Find the header line (skip LinkedIn "Notes:" preamble)
      const lines = csvText.split('\n');
      let headerLineIndex = 0;
      for (let i = 0; i < Math.min(lines.length, 10); i++) {
        if (lines[i].startsWith('First Name,')) {
          headerLineIndex = i;
          break;
        }
      }

      // Rejoin from header line onward
      const cleanCSV = lines.slice(headerLineIndex).join('\n');

      const result = Papa.parse<Record<string, string>>(cleanCSV, {
        header: true,
        dynamicTyping: false,
        skipEmptyLines: 'greedy',
        transformHeader: (header: string) => {
          return HEADER_MAP[header.trim()] || header.toLowerCase().replace(/ /g, '_');
        },
      });

      return {
        data: result.data,
        errors: result.errors,
        totalRows: result.data.length,
      };
    }
    ```

    **Why text-based preamble stripping:** PapaParse's `beforeFirstChunk` callback could also work, but explicit line scanning is more readable and testable. The "Notes:" preamble varies slightly between CSV exports (sometimes 2 lines, sometimes 3 with empty line), so scanning for "First Name," is the most robust approach.
  </action>
  <verify>
    - Both files compile: `npx tsc --noEmit`
    - Test normalizer mentally: "Microsoft Corporation" -> "microsoft", "Sequoia Capital" -> "sequoia", "Goldman Sachs Group" -> "goldman sachs"
    - Parser correctly strips Notes preamble by finding "First Name," header line
  </verify>
  <done>
    CSV parser handles LinkedIn's Notes preamble and transforms headers to snake_case. Company normalizer strips legal suffixes (inc, llc, corp, etc.) and normalizes whitespace/punctuation. Both export clean TypeScript functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Import server action and LinkedIn import UI page</name>
  <files>
    app/actions/linkedin.ts
    app/(dashboard)/linkedin/import/page.tsx
    app/(dashboard)/linkedin/import/_components/csv-uploader.tsx
    app/(dashboard)/linkedin/import/_components/import-results.tsx
    app/(dashboard)/layout.tsx
  </files>
  <action>
    **app/actions/linkedin.ts:**
    Create server actions following the pattern in app/actions/investors.ts (auth check, Supabase client, error handling). Two actions:

    1. `importLinkedInCSV(formData: FormData)`:
       - Get `csv_file` (File) and `team_member_name` (string) from FormData
       - Validate file exists, is .csv, is under 10MB
       - Read file as text: `await file.text()`
       - Parse with `parseLinkedInCSV(text)` from lib/csv/parser.ts
       - Validate rows with `validateLinkedInRows(parsedData)` from lib/validations/linkedin-schema.ts
       - For each validated row, compute `normalized_company` using `normalizeCompanyName(row.company)`
       - Batch insert into `linkedin_contacts` table using Supabase `.insert()` with `onConflict: 'linkedin_url,team_member_name'` to handle duplicates (upsert behavior — skip existing)
       - IMPORTANT: Insert in batches of 500 to avoid request size limits (Jackson has 19K contacts)
       - Return `ImportResult` type: { success, imported, skipped, errors, relationships_detected: 0 }
       - Use `revalidatePath('/linkedin')` after successful import

    2. `getLinkedInImportStats()`:
       - Return count of linkedin_contacts grouped by team_member_name
       - Used to show import status on the import page
       - Query: `SELECT team_member_name, COUNT(*) as count FROM linkedin_contacts GROUP BY team_member_name`

    **app/(dashboard)/linkedin/import/page.tsx:**
    Server component page for the LinkedIn import flow:
    - Title: "LinkedIn Network Import"
    - Subtitle: "Import team LinkedIn connections to map warm introduction paths to investors"
    - Show import stats (how many contacts per team member already imported) using `getLinkedInImportStats()`
    - Render CSVUploader client component

    **app/(dashboard)/linkedin/import/_components/csv-uploader.tsx:**
    Client component ("use client") for the upload form:
    - Team member dropdown (select from TEAM_MEMBERS constant)
    - File input accepting .csv files only
    - Upload button with loading state (useTransition or useActionState)
    - On submit: create FormData, call importLinkedInCSV server action
    - Show ImportResults component with the result
    - Use shadcn/ui components: Button, Select (or native select), Input
    - File input should accept drag-and-drop (use standard HTML5 drag events or just a styled file input)
    - Show file name after selection

    **app/(dashboard)/linkedin/import/_components/import-results.tsx:**
    Client component to display import results:
    - Success state: green banner with "Imported X contacts for [team member]"
    - Error state: red banner with error message
    - Partial success: yellow banner with "Imported X, skipped Y, Z errors"
    - If validation errors exist, show collapsible list of first 20 errors (row number, field, message)
    - Use shadcn/ui Alert or custom styled div

    **app/(dashboard)/layout.tsx:**
    Add "LinkedIn" navigation link to the sidebar. Add it after the "Investors" link:
    - Label: "LinkedIn"
    - href: "/linkedin/import"
    - Icon: Use `Users` or `Share2` from lucide-react (or `Linkedin` icon if available)

    **IMPORTANT performance note:** Jackson's file has ~19K rows. The server action MUST:
    1. Process on the server (not client-side)
    2. Batch inserts in groups of 500
    3. Handle the full import in a single request (Next.js Server Actions support large payloads)
    4. The 10MB file size limit is sufficient (19K CSV rows ~ 2-3MB)
  </action>
  <verify>
    1. Navigate to /linkedin/import — page loads with team member selection and file upload
    2. Upload one of the smaller CSV files (Morino — ~1460 rows) to test:
       - Select "Morino" from dropdown
       - Upload "Morino LinkedIn Connections.csv"
       - Should see "Imported ~1460 contacts for Morino"
    3. Re-upload same file — should show "Skipped" count (no duplicates)
    4. Check database: `SELECT COUNT(*) FROM linkedin_contacts WHERE team_member_name = 'Morino';` returns expected count
    5. Sidebar shows "LinkedIn" navigation link
    6. `npx tsc --noEmit` passes
  </verify>
  <done>
    User can navigate to /linkedin/import, select a team member, upload a LinkedIn CSV, and see results. System parses the CSV (handling Notes preamble), validates rows via Zod, normalizes company names, and batch-inserts into linkedin_contacts. Duplicate imports are handled via unique constraint. Import stats show per-team-member counts.
  </done>
</task>

</tasks>

<verification>
1. `/linkedin/import` page accessible from dashboard sidebar
2. Upload smallest CSV (Morino) — import succeeds with correct count
3. Re-upload same file — duplicates are skipped (no errors, skipped count shown)
4. Database has correct records with normalized_company populated
5. Upload larger file (Todd ~1700 rows) — completes without timeout
6. All 4 team member names available in dropdown
7. TypeScript compiles cleanly
</verification>

<success_criteria>
- User can import LinkedIn CSV files for all 4 team members
- System stores contacts in linkedin_contacts table with normalized company names
- Duplicate imports are handled gracefully (upsert/skip)
- Import page shows stats of previously imported contacts per team member
- Dashboard sidebar includes LinkedIn navigation link
</success_criteria>

<output>
After completion, create `.planning/phases/04.5-contact-intelligence/04.5-02-SUMMARY.md`
</output>
