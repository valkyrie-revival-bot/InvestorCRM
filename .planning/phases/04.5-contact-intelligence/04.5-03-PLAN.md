---
phase: 04.5-contact-intelligence
plan: 03
type: execute
wave: 3
depends_on: ["04.5-01", "04.5-02"]
files_modified:
  - lib/matching/fuzzy-matcher.ts
  - lib/matching/relationship-detector.ts
  - app/actions/linkedin.ts
  - app/(dashboard)/investors/[id]/page.tsx
  - components/investors/investor-connections-tab.tsx
  - components/investors/connection-card.tsx
autonomous: false

must_haves:
  truths:
    - "System automatically detects company-name matches between LinkedIn contacts and investor firms"
    - "System maps relationship types (works_at, industry_overlap, etc.) based on company similarity"
    - "System calculates warm introduction path strength scores (0.0-1.0) with recency multiplier"
    - "User sees Connections section on investor detail page showing related LinkedIn contacts"
    - "Each connection card shows contact name, company, position, team member who knows them, relationship type, and strength badge"
    - "Connections sorted by path_strength descending (strongest intros first)"
  artifacts:
    - path: "lib/matching/fuzzy-matcher.ts"
      provides: "Fuse.js-based fuzzy company name matcher with normalization"
      exports: ["createCompanyMatcher", "CompanyMatch"]
    - path: "lib/matching/relationship-detector.ts"
      provides: "Relationship detection, type classification, and strength scoring"
      exports: ["detectRelationships", "calculatePathStrength", "classifyStrength"]
    - path: "app/actions/linkedin.ts"
      provides: "Server actions extended with detectAndStoreRelationships and getInvestorConnections"
      exports: ["detectAndStoreRelationships", "getInvestorConnections"]
    - path: "components/investors/investor-connections-tab.tsx"
      provides: "Connections section component for investor detail page"
    - path: "components/investors/connection-card.tsx"
      provides: "Individual connection card with strength badge"
  key_links:
    - from: "lib/matching/relationship-detector.ts"
      to: "lib/matching/fuzzy-matcher.ts"
      via: "function call"
      pattern: "createCompanyMatcher"
    - from: "lib/matching/relationship-detector.ts"
      to: "lib/csv/company-normalizer.ts"
      via: "function call"
      pattern: "normalizeCompanyName"
    - from: "app/actions/linkedin.ts"
      to: "lib/matching/relationship-detector.ts"
      via: "function call"
      pattern: "detectRelationships"
    - from: "app/(dashboard)/investors/[id]/page.tsx"
      to: "app/actions/linkedin.ts"
      via: "server action call"
      pattern: "getInvestorConnections"
    - from: "components/investors/investor-connections-tab.tsx"
      to: "components/investors/connection-card.tsx"
      via: "child component"
      pattern: "ConnectionCard"
---

<objective>
Build the relationship intelligence engine and display warm introduction paths on the investor detail page.

Purpose: This is the core value proposition of Phase 4.5 — automatically detecting that a team member's LinkedIn contact works at (or has a relationship with) an investor firm, and surfacing warm intro paths with strength scores. Without this, imported LinkedIn contacts are just data sitting in a table.
Output: Working relationship detection that matches LinkedIn contacts to investors, strength-scored intro paths, and a "Connections" section on the investor detail page.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.5-contact-intelligence/04.5-RESEARCH.md
@.planning/phases/04.5-contact-intelligence/04.5-01-SUMMARY.md
@.planning/phases/04.5-contact-intelligence/04.5-02-SUMMARY.md

Existing patterns:
@app/actions/investors.ts — Server action pattern (auth check, error handling)
@app/(dashboard)/investors/[id]/page.tsx — Investor detail page structure
@components/investors/investor-form-sections.tsx — Section component pattern
@types/linkedin.ts — Types from Plan 01
@lib/csv/company-normalizer.ts — Company normalization from Plan 02
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fuzzy matching engine and relationship detector</name>
  <files>
    lib/matching/fuzzy-matcher.ts
    lib/matching/relationship-detector.ts
    app/actions/linkedin.ts
  </files>
  <action>
    **lib/matching/fuzzy-matcher.ts:**
    Create Fuse.js-based company name matcher. This compares normalized LinkedIn contact companies against normalized investor firm names.

    ```typescript
    import Fuse from 'fuse.js';
    import { normalizeCompanyName } from '@/lib/csv/company-normalizer';

    export interface CompanyMatch {
      investor_id: string;
      firm_name: string;
      similarity_score: number; // 0-1 where 1 is perfect
    }

    interface InvestorEntry {
      id: string;
      firm_name: string;
      normalized: string;
    }

    export function createCompanyMatcher(investors: Array<{ id: string; firm_name: string }>) {
      const entries: InvestorEntry[] = investors.map(inv => ({
        id: inv.id,
        firm_name: inv.firm_name,
        normalized: normalizeCompanyName(inv.firm_name),
      }));

      const fuse = new Fuse(entries, {
        keys: ['normalized'],
        threshold: 0.3,         // 0.0 = perfect match, 1.0 = match anything
        distance: 100,
        includeScore: true,
        minMatchCharLength: 3,
        ignoreLocation: true,
      });

      return {
        findMatches(companyName: string): CompanyMatch[] {
          const normalized = normalizeCompanyName(companyName);
          if (!normalized || normalized.length < 3) return [];

          const results = fuse.search(normalized);
          return results
            .filter(r => r.score !== undefined && r.score < 0.3)
            .map(r => ({
              investor_id: r.item.id,
              firm_name: r.item.firm_name,
              similarity_score: 1 - (r.score ?? 1),
            }));
        },
      };
    }
    ```

    **lib/matching/relationship-detector.ts:**
    Create the relationship detection and scoring engine. This is the intelligence layer.

    Functions to implement:

    1. `calculatePathStrength(relationshipType, connectedOnDate)`:
       - Base strengths: works_at=1.0, former_colleague=0.7, knows_decision_maker=0.6, industry_overlap=0.3, geographic_proximity=0.2
       - Recency multiplier based on `connected_on` date: <30 days=1.2x, 30-90 days=1.0x, 90-365 days=0.9x, >365 days=0.8x
       - Cap at 1.0
       - Return the final score

    2. `classifyStrength(score)`:
       - score >= 0.7 -> 'strong'
       - score >= 0.4 -> 'medium'
       - score < 0.4 -> 'weak'

    3. `detectRelationships(linkedinContacts, investors)`:
       - Takes array of LinkedInContact rows and array of Investor rows
       - Creates a company matcher from investors
       - For each LinkedIn contact with a company:
         - Run fuzzy match against investor firms
         - For each match, determine relationship type:
           - similarity_score >= 0.8 AND contact has current position -> 'works_at'
           - similarity_score >= 0.5 -> 'industry_overlap' (conservative — could be same company but different dept)
           - similarity_score >= 0.3 -> 'industry_overlap'
         - Calculate path_strength using calculatePathStrength
         - Build a human-readable path_description: "{contact_name} ({position}) at {company} — knows {team_member_name} (connected {connected_on})"
       - Return array of InvestorRelationshipInsert objects ready for database insert

    **app/actions/linkedin.ts (EXTEND — do not overwrite existing functions):**
    Add two new server actions to the existing file:

    1. `detectAndStoreRelationships(teamMemberName?: string)`:
       - Auth check (same pattern as existing actions)
       - Fetch all investors (non-deleted): `supabase.from('investors').select('id, firm_name').is('deleted_at', null)`
       - Fetch LinkedIn contacts (optionally filtered by team_member_name)
       - Call `detectRelationships(contacts, investors)` to get relationship data
       - Clear existing auto-detected relationships for these contacts: DELETE WHERE detected_via = 'company_match' AND linkedin_contact_id IN (...)
       - Insert new relationships using `.upsert()` on unique constraint (investor_id, linkedin_contact_id, relationship_type)
       - Return count of relationships detected
       - IMPORTANT: Call this automatically at the end of `importLinkedInCSV` (add call after batch insert completes)

    2. `getInvestorConnections(investorId: string)`:
       - Auth check
       - Query investor_relationships joined with linkedin_contacts:
         ```sql
         SELECT ir.*, lc.first_name, lc.last_name, lc.full_name, lc.company, lc.position,
                lc.team_member_name, lc.linkedin_url, lc.connected_on
         FROM investor_relationships ir
         JOIN linkedin_contacts lc ON ir.linkedin_contact_id = lc.id
         WHERE ir.investor_id = $1
         ORDER BY ir.path_strength DESC
         ```
       - Transform results into IntroPath[] type
       - Return { data: IntroPath[] } or { error: string }

    **Also update importLinkedInCSV** (in the same file) to call `detectAndStoreRelationships(teamMemberName)` after successful import, and include `relationships_detected` count in the return value.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - After importing LinkedIn contacts (from Plan 02), run detectAndStoreRelationships and verify investor_relationships table has rows
    - Query: `SELECT COUNT(*) FROM investor_relationships;` should be > 0 if any LinkedIn contacts work at companies matching investor firms
    - Spot-check: if a LinkedIn contact works at "Goldman Sachs" and there's an investor named "Goldman Sachs Group", relationship should be detected
  </verify>
  <done>
    Fuzzy matching engine detects company name similarities between LinkedIn contacts and investor firms. Relationship detector classifies relationship types and calculates strength scores. Server actions store relationships in database and retrieve intro paths for any investor. Import pipeline triggers relationship detection automatically.
  </done>
</task>

<task type="auto">
  <name>Task 2: Connections section on investor detail page</name>
  <files>
    components/investors/investor-connections-tab.tsx
    components/investors/connection-card.tsx
    app/(dashboard)/investors/[id]/page.tsx
  </files>
  <action>
    **components/investors/connection-card.tsx:**
    Client component that renders a single connection/warm intro path. Design for dark theme (project default).

    Props: `{ introPath: IntroPath }`

    Layout:
    - Left side: Contact info
      - Name (bold): "{first_name} {last_name}"
      - Position + Company (muted text): "{position} at {company}"
      - Team member badge: "via {team_member_name}" in a small Badge component
      - LinkedIn URL: small link icon that opens profile in new tab (only if linkedin_url exists)
    - Right side: Strength indicator
      - Badge with color based on strength_label:
        - 'strong' -> green badge "Strong" (bg-green-500/20 text-green-400)
        - 'medium' -> yellow badge "Medium" (bg-yellow-500/20 text-yellow-400)
        - 'weak' -> gray badge "Weak" (bg-gray-500/20 text-gray-400)
      - Relationship type text below badge (e.g., "Works at firm", "Industry overlap")
    - Bottom: path_description in muted small text

    Use shadcn/ui Badge component and existing dark theme patterns from other investor components.

    **components/investors/investor-connections-tab.tsx:**
    Server or client component that shows all connections for an investor.

    Props: `{ connections: IntroPath[] }`

    Layout:
    - If no connections: show empty state message "No connections found yet. Import LinkedIn contacts to discover warm introduction paths."
    - If connections exist:
      - Header: "Warm Introductions ({count})"
      - Summary stats: "{strong_count} strong, {medium_count} medium, {weak_count} weak"
      - Grid/list of ConnectionCard components, sorted by strength (already sorted from query)
      - Use space-y-3 for vertical spacing between cards

    **app/(dashboard)/investors/[id]/page.tsx (MODIFY):**
    Add the Connections section to the investor detail page. Insert it between the Contacts section and the Activity History section:

    1. Import `getInvestorConnections` from `@/app/actions/linkedin`
    2. Import `InvestorConnectionsTab` from `@/components/investors/investor-connections-tab`
    3. After fetching investor data, also fetch connections: `const connectionsResult = await getInvestorConnections(id);`
    4. Extract connections: `const connections = connectionsResult.data || [];`
    5. Add new section between Contacts and Activity History:
       ```tsx
       {/* LinkedIn Connections */}
       <div className="rounded-lg border bg-card p-6">
         <h2 className="text-lg font-semibold mb-4">
           LinkedIn Connections
           {connections.length > 0 && (
             <span className="ml-2 text-sm font-normal text-muted-foreground">
               ({connections.length})
             </span>
           )}
         </h2>
         <InvestorConnectionsTab connections={connections} />
       </div>
       ```

    **Styling notes:**
    - Follow the existing card pattern from investor-form-sections.tsx (rounded-lg border bg-card p-6)
    - Dark theme: use /20 opacity backgrounds for strength badges, /400 text colors
    - Match the typography scale used in other investor detail sections
    - LinkedIn icon from lucide-react: `import { Linkedin, ExternalLink } from 'lucide-react';`
  </action>
  <verify>
    1. Navigate to any investor detail page (e.g., /investors/{id})
    2. "LinkedIn Connections" section appears between Contacts and Activity History
    3. If relationships were detected (from Task 1), connection cards display with:
       - Contact name, position, company
       - Team member badge (via Todd, via Jeff, etc.)
       - Strength badge (Strong/Medium/Weak) with correct color
       - Relationship type description
    4. If no relationships, empty state message shows
    5. Cards sorted by strength (strongest first)
    6. LinkedIn profile links open in new tab
    7. Page loads without errors even if no LinkedIn contacts imported yet
  </verify>
  <done>
    Investor detail page shows "LinkedIn Connections" section with warm introduction paths. Each connection shows the LinkedIn contact's info, which team member knows them, the relationship type, and a strength score badge. Connections are sorted strongest-first. Empty state handled gracefully.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete LinkedIn contact intelligence system:
    1. LinkedIn CSV import page (/linkedin/import) with team member selection and file upload
    2. Relationship detection engine that matches LinkedIn contacts to investor firms using fuzzy company name matching
    3. Warm introduction paths with strength scoring on investor detail pages
  </what-built>
  <how-to-verify>
    1. Go to http://localhost:3003/linkedin/import
    2. Select "Morino" and upload "Morino LinkedIn Connections.csv"
    3. Verify import succeeds with contact count
    4. Navigate to an investor detail page (pick one whose firm name might match a LinkedIn contact's company)
    5. Scroll to "LinkedIn Connections" section
    6. Verify connection cards display with strength badges
    7. Try importing another team member's CSV (Todd — ~1700 contacts)
    8. Return to investor detail and verify additional connections appear
    9. Verify strength scoring makes sense (contacts who work at the investor firm should show "Strong")
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Fuzzy matching: "Goldman Sachs" LinkedIn contact matches "Goldman Sachs Group" investor
2. Relationship types correctly classified (works_at for high similarity + current position)
3. Strength scores calculated with recency multiplier (recent connections stronger)
4. Investor detail page shows connections sorted by strength
5. Connection cards display all required info (name, company, position, team member, strength, type)
6. Empty state handled when no LinkedIn contacts imported
7. Full import -> detect -> display pipeline works end-to-end
8. TypeScript compiles cleanly
</verification>

<success_criteria>
- System automatically detects commonalities between LinkedIn contacts and investor firms
- User sees warm introduction paths with strength scoring on investor detail pages
- System maps relationship types based on company name similarity
- Connections section shows contact info, team member, and strength badge
- Import triggers relationship detection automatically
- All 6 Phase 4.5 success criteria are met
</success_criteria>

<output>
After completion, create `.planning/phases/04.5-contact-intelligence/04.5-03-SUMMARY.md`
</output>
