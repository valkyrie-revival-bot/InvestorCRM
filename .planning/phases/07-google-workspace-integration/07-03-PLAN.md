---
phase: 07-google-workspace-integration
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - app/actions/google/gmail-actions.ts
  - app/actions/google/calendar-actions.ts
  - components/investors/email-logger.tsx
  - components/investors/meeting-scheduler.tsx
autonomous: true

must_haves:
  truths:
    - "User can search recent Gmail messages and log one to an investor record"
    - "Logged emails display with subject, sender, date in the investor email section"
    - "User can schedule a Google Calendar meeting linked to an investor"
    - "Scheduled meetings display with date, time, summary, and link to Google Calendar event"
    - "Both email logging and meeting scheduling create activity entries in investor timeline"
  artifacts:
    - path: "app/actions/google/gmail-actions.ts"
      provides: "Server actions for Gmail operations"
      exports: ["searchEmails", "logEmailToInvestor", "getEmailLogs"]
    - path: "app/actions/google/calendar-actions.ts"
      provides: "Server actions for Calendar operations"
      exports: ["scheduleInvestorMeeting", "getCalendarEvents"]
    - path: "components/investors/email-logger.tsx"
      provides: "Gmail email search and logging UI"
      min_lines: 60
    - path: "components/investors/meeting-scheduler.tsx"
      provides: "Calendar meeting scheduling form"
      min_lines: 80
  key_links:
    - from: "app/actions/google/gmail-actions.ts"
      to: "lib/google/client.ts"
      via: "createGoogleClient for Gmail API auth"
      pattern: "createGoogleClient"
    - from: "app/actions/google/calendar-actions.ts"
      to: "lib/google/client.ts"
      via: "createGoogleClient for Calendar API auth"
      pattern: "createGoogleClient"
    - from: "app/actions/google/gmail-actions.ts"
      to: "activities table"
      via: "Activity logging on email log"
      pattern: "activities.*insert"
    - from: "app/actions/google/calendar-actions.ts"
      to: "activities table"
      via: "Activity logging on meeting schedule"
      pattern: "activities.*insert"
---

<objective>
Build Gmail and Calendar integrations: server actions for searching/logging emails and scheduling meetings, with corresponding UI components for email search/selection and meeting scheduling forms.

Purpose: Enable users to associate email communications and meetings with investor records, creating a comprehensive interaction history. Gmail integration tracks email correspondence; Calendar integration manages meeting scheduling directly from the CRM.

Output: Gmail server actions + EmailLogger component, Calendar server actions + MeetingScheduler component. All ready to be wired into investor detail page in Plan 04.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-google-workspace-integration/07-RESEARCH.md
@.planning/phases/07-google-workspace-integration/07-01-SUMMARY.md
@lib/google/client.ts
@lib/google/retry.ts
@types/google.ts
@types/investors.ts
@lib/supabase/auth-helpers.ts
@lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gmail server actions and EmailLogger component</name>
  <files>
    app/actions/google/gmail-actions.ts
    components/investors/email-logger.tsx
  </files>
  <action>
    **app/actions/google/gmail-actions.ts:**
    Mark as 'use server'. Import { google } from 'googleapis', createGoogleClient and hasGoogleTokens from @/lib/google/client, withRetry from @/lib/google/retry, createClient from @/lib/supabase/server, getCurrentUser from @/lib/supabase/auth-helpers, types from @/types/google.

    **searchEmails(params: { query: string; maxResults?: number }):**
    - Get current user, throw if not auth
    - Create Google client via createGoogleClient(user.id)
    - Create gmail instance: google.gmail({ version: 'v1', auth: oauth2Client })
    - Wrap in withRetry: call gmail.users.messages.list({ userId: 'me', q: params.query, maxResults: params.maxResults || 10 })
    - For each message ID returned, fetch metadata with withRetry: gmail.users.messages.get({ userId: 'me', id: msgId, format: 'metadata', metadataHeaders: ['From', 'To', 'Subject', 'Date'] })
    - Use `format: 'metadata'` (NOT 'full') to conserve Gmail API quota per research
    - Extract headers (From, To, Subject, Date) and snippet from each message
    - Return array of { messageId, threadId, from, to, subject, date, snippet }
    - On error: if error includes "invalid_grant" or token error, return { error: 'google_auth_required' } instead of throwing

    **logEmailToInvestor(params: { investorId: string; messageId: string; threadId?: string; from: string; to: string; subject: string; sentDate: string; snippet?: string }):**
    - Get current user, throw if not auth
    - Insert into email_logs table using Supabase client
    - Log activity: activity_type='email', description=`Email: ${subject}`, metadata={ message_id, thread_id, from, to, date: sentDate }
    - revalidatePath(`/investors/${investorId}`)
    - Return { success: true }

    **getEmailLogs(investorId: string):**
    - Select all from email_logs where investor_id, order by sent_date desc
    - Return { data: EmailLog[] } or { error: string }

    **components/investors/email-logger.tsx:**
    - 'use client' component
    - Props: { investorId: string; investorName: string; disabled?: boolean }
    - State: searchQuery (string), searchResults (array), isSearching (boolean), isOpen (boolean for dialog/collapsible)
    - UI: Button "Log Email" that opens a dialog (use shadcn Dialog or inline collapsible)
    - Inside dialog:
      - Search input with placeholder "Search Gmail (e.g., from:investor@firm.com)"
      - Pre-fill search with investor firm name for convenience
      - Search button that calls searchEmails server action
      - Results list showing: subject (bold), from, date (relative), snippet (truncated)
      - Each result has "Log" button that calls logEmailToInvestor
      - Show toast.success on log, close dialog
    - Handle google_auth_required error: show message "Connect Google account to log emails" with link to authorize
    - If disabled prop true, show disabled button with tooltip
    - Use Tailwind dark theme compatible styles, match existing modal patterns (see QuickAddActivityModal)
  </action>
  <verify>
    - `npx tsc --noEmit --pretty 2>&1 | head -20` passes
    - gmail-actions.ts exports searchEmails, logEmailToInvestor, getEmailLogs
    - email-logger.tsx is 'use client' and renders search UI with log action
    - searchEmails uses format: 'metadata' (not 'full')
    - withRetry wraps all Google API calls
  </verify>
  <done>
    Gmail server actions search emails via metadata format (quota-efficient), log selected emails to database with activity tracking. EmailLogger component provides search-and-select UI with pre-filled investor name query, result display, and one-click logging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Calendar server actions and MeetingScheduler component</name>
  <files>
    app/actions/google/calendar-actions.ts
    components/investors/meeting-scheduler.tsx
  </files>
  <action>
    **app/actions/google/calendar-actions.ts:**
    Mark as 'use server'. Import same Google and Supabase utilities as gmail-actions.

    **scheduleInvestorMeeting(params: { investorId: string; summary: string; description?: string; startTime: string; endTime: string; attendees?: string[]; timezone?: string }):**
    - Get current user, throw if not auth
    - Create Google client via createGoogleClient(user.id)
    - Create calendar instance: google.calendar({ version: 'v3', auth: oauth2Client })
    - Wrap in withRetry: calendar.events.insert with requestBody containing summary, description, start (dateTime + timeZone), end (dateTime + timeZone), attendees (map emails to { email } objects)
    - Default timezone to 'America/New_York' if not provided
    - Store in calendar_events table: investor_id, event_id, summary, description, start_time, end_time, event_url (from event.htmlLink), attendees (array of emails), created_by
    - Log activity: activity_type='meeting', description=`Scheduled: ${summary}`, metadata={ event_id, start_time, end_time, attendees, event_url }
    - revalidatePath(`/investors/${investorId}`)
    - Return { success: true, eventUrl: event.htmlLink }
    - Handle invalid_grant like gmail-actions

    **getCalendarEvents(investorId: string):**
    - Select all from calendar_events where investor_id, order by start_time desc
    - Return { data: CalendarEvent[] } or { error: string }

    **components/investors/meeting-scheduler.tsx:**
    - 'use client' component
    - Props: { investorId: string; investorName: string; disabled?: boolean }
    - State: form fields (summary, description, startDate, startTime, endDate, endTime, attendeeEmails), isOpen (dialog), isSubmitting
    - UI: Button "Schedule Meeting" that opens a Dialog (use shadcn Dialog)
    - Inside dialog, form with:
      - Summary input (pre-fill with "Meeting with {investorName}")
      - Description textarea (optional)
      - Start date + time inputs (use native date and time inputs for simplicity, or shadcn Calendar if installed)
      - End date + time inputs (default to 1 hour after start)
      - Attendees input (comma-separated emails, optional)
    - On submit: combine date+time into ISO 8601 dateTime strings, call scheduleInvestorMeeting
    - Show toast.success with "Meeting scheduled!" and link to Google Calendar event
    - Show toast.error on failure
    - Handle google_auth_required error like EmailLogger
    - If disabled prop true, show disabled button
    - Use react-hook-form with zod validation: summary required (3-200 chars), startTime required, endTime required and after startTime
    - Match existing modal patterns in the project
  </action>
  <verify>
    - `npx tsc --noEmit --pretty 2>&1 | head -20` passes
    - calendar-actions.ts exports scheduleInvestorMeeting, getCalendarEvents
    - meeting-scheduler.tsx is 'use client' and renders scheduling form in dialog
    - Calendar event creation uses withRetry wrapper
    - Activity logging includes meeting metadata
  </verify>
  <done>
    Calendar server actions create Google Calendar events linked to investors with activity logging. MeetingScheduler component provides form dialog with pre-filled investor name, date/time pickers, optional attendees, and direct link to created event.
  </done>
</task>

</tasks>

<verification>
- All 4 files compile without TypeScript errors
- Gmail actions use metadata-only format for quota efficiency
- Calendar actions include timezone handling
- Both services use withRetry for rate limiting
- Both services log activities to investor timeline
- Components handle auth errors gracefully (google_auth_required)
- Components follow existing project patterns (dark theme, shadcn Dialog, sonner toast)
</verification>

<success_criteria>
Gmail and Calendar integrations are fully implemented: users can search Gmail and log emails to investors, schedule Calendar meetings linked to investors, and both operations create activity timeline entries. Components are self-contained and ready for integration into investor detail page.
</success_criteria>

<output>
After completion, create `.planning/phases/07-google-workspace-integration/07-03-SUMMARY.md`
</output>
