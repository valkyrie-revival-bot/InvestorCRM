---
phase: 07-google-workspace-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/database/migrations/020-google-oauth-tokens.sql
  - lib/database/migrations/021-drive-links.sql
  - lib/database/migrations/022-email-logs.sql
  - lib/database/migrations/023-calendar-events.sql
  - types/google.ts
  - lib/google/scopes.ts
  - lib/google/retry.ts
  - lib/google/client.ts
  - app/api/google-oauth/callback/route.ts
  - .env.example
autonomous: false

user_setup:
  - service: google-cloud-console
    why: "Google Workspace API access for Drive, Gmail, Calendar"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
      - name: NEXT_PUBLIC_GOOGLE_API_KEY
        source: "Google Cloud Console -> APIs & Services -> Credentials -> API Keys"
      - name: NEXT_PUBLIC_GOOGLE_CLIENT_ID
        source: "Same as GOOGLE_CLIENT_ID (needed client-side for Picker)"
    dashboard_config:
      - task: "Enable Google Drive API, Gmail API, Google Calendar API, Google Picker API"
        location: "Google Cloud Console -> APIs & Services -> Library"
      - task: "Add OAuth redirect URI: {NEXT_PUBLIC_URL}/api/google-oauth/callback"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth client -> Authorized redirect URIs"
      - task: "Add authorized JavaScript origin for Picker: {NEXT_PUBLIC_URL}"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth client -> Authorized JavaScript origins"

must_haves:
  truths:
    - "Database tables exist for storing Google OAuth tokens, Drive file links, email logs, and calendar events"
    - "OAuth callback route exchanges authorization code for tokens and stores refresh token in database"
    - "Google API client factory creates authenticated OAuth2Client with stored refresh token"
    - "Exponential backoff wrapper retries Google API calls on 429/503 errors"
  artifacts:
    - path: "lib/database/migrations/020-google-oauth-tokens.sql"
      provides: "Secure token storage with service-role-only access"
      contains: "google_oauth_tokens"
    - path: "lib/database/migrations/021-drive-links.sql"
      provides: "Drive file links table"
      contains: "drive_links"
    - path: "lib/database/migrations/022-email-logs.sql"
      provides: "Email log entries table"
      contains: "email_logs"
    - path: "lib/database/migrations/023-calendar-events.sql"
      provides: "Calendar event links table"
      contains: "calendar_events"
    - path: "types/google.ts"
      provides: "TypeScript types for all Google Workspace data"
      exports: ["DriveLink", "EmailLog", "CalendarEvent", "GoogleOAuthToken"]
    - path: "lib/google/client.ts"
      provides: "OAuth2Client factory with token loading"
      exports: ["createGoogleClient", "getGoogleAuthUrl"]
    - path: "lib/google/retry.ts"
      provides: "Exponential backoff wrapper"
      exports: ["withRetry"]
    - path: "app/api/google-oauth/callback/route.ts"
      provides: "OAuth callback for Google Workspace scopes"
      exports: ["GET"]
  key_links:
    - from: "lib/google/client.ts"
      to: "google_oauth_tokens table"
      via: "Supabase admin client loads refresh token"
      pattern: "from.*google_oauth_tokens"
    - from: "app/api/google-oauth/callback/route.ts"
      to: "google_oauth_tokens table"
      via: "Stores refresh token after code exchange"
      pattern: "google_oauth_tokens.*upsert|insert"
---

<objective>
Create the Google Workspace integration foundation: database schema for OAuth tokens and external resource links (Drive, Gmail, Calendar), TypeScript type definitions, Google API library modules (client factory, retry wrapper, scope definitions), and OAuth callback route for acquiring Google Workspace permissions.

Purpose: Establish the infrastructure layer that all three Google service integrations (Drive, Gmail, Calendar) depend on. Without this foundation, no Google API calls can be authenticated or retried.

Output: 4 SQL migration files, TypeScript types, 3 Google library modules, OAuth callback API route, updated .env.example.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-google-workspace-integration/07-RESEARCH.md
@lib/supabase/server.ts
@lib/supabase/auth-helpers.ts
@types/investors.ts
@app/(auth)/auth/callback/route.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migrations and TypeScript types</name>
  <files>
    lib/database/migrations/020-google-oauth-tokens.sql
    lib/database/migrations/021-drive-links.sql
    lib/database/migrations/022-email-logs.sql
    lib/database/migrations/023-calendar-events.sql
    types/google.ts
  </files>
  <action>
    Create 4 SQL migration files following the project's established migration pattern (manual execution in Supabase SQL Editor):

    **020-google-oauth-tokens.sql:**
    - Table `google_oauth_tokens` with columns: id (uuid PK default gen_random_uuid()), user_id (uuid NOT NULL REFERENCES auth.users ON DELETE CASCADE, UNIQUE), refresh_token (text NOT NULL), access_token (text NULL for caching), token_expiry (timestamptz NULL), scopes (text[] NULL), created_at (timestamptz DEFAULT now()), updated_at (timestamptz DEFAULT now())
    - NO RLS policies on this table (service-role-only access pattern per research findings)
    - REVOKE ALL ON google_oauth_tokens FROM public, anon, authenticated
    - GRANT ALL ON google_oauth_tokens TO service_role
    - Add comment: "OAuth tokens accessible via service role only - never exposed to client"

    **021-drive-links.sql:**
    - Table `drive_links` with columns: id (uuid PK default gen_random_uuid()), investor_id (uuid NOT NULL REFERENCES investors ON DELETE CASCADE), file_id (text NOT NULL), file_name (text NOT NULL), file_url (text NOT NULL), mime_type (text NULL), thumbnail_url (text NULL), linked_by (uuid REFERENCES auth.users), created_at (timestamptz DEFAULT now())
    - Unique constraint on (investor_id, file_id) to prevent duplicate links
    - Index on investor_id for fast lookup
    - Enable RLS with policies: SELECT for authenticated (investor not soft-deleted), INSERT for authenticated, DELETE for authenticated (own links only via linked_by)

    **022-email-logs.sql:**
    - Table `email_logs` with columns: id (uuid PK default gen_random_uuid()), investor_id (uuid NOT NULL REFERENCES investors ON DELETE CASCADE), message_id (text NOT NULL), thread_id (text NULL), from_address (text NOT NULL), to_address (text NOT NULL), subject (text NOT NULL), sent_date (timestamptz NOT NULL), snippet (text NULL), logged_by (uuid REFERENCES auth.users), created_at (timestamptz DEFAULT now())
    - Unique constraint on (investor_id, message_id) to prevent duplicate logs
    - Index on investor_id
    - Enable RLS with similar policies as drive_links

    **023-calendar-events.sql:**
    - Table `calendar_events` with columns: id (uuid PK default gen_random_uuid()), investor_id (uuid NOT NULL REFERENCES investors ON DELETE CASCADE), event_id (text NOT NULL), summary (text NOT NULL), description (text NULL), start_time (timestamptz NOT NULL), end_time (timestamptz NOT NULL), event_url (text NULL), attendees (text[] NULL), created_by (uuid REFERENCES auth.users), created_at (timestamptz DEFAULT now())
    - Unique constraint on (investor_id, event_id) to prevent duplicates
    - Index on investor_id
    - Enable RLS with similar policies as drive_links

    **types/google.ts:**
    - Export interfaces: GoogleOAuthToken (matches DB columns), DriveLink (matches DB), EmailLog (matches DB), CalendarEvent (matches DB)
    - Export insert types: DriveLinkInsert, EmailLogInsert, CalendarEventInsert (Omit id/created_at)
    - Export GoogleWorkspaceStatus type: { hasTokens: boolean; scopes: string[] | null; connectedAt: string | null }
  </action>
  <verify>
    - All 4 SQL files exist in lib/database/migrations/
    - Each SQL file has CREATE TABLE, proper constraints, and RLS policies (except tokens table)
    - types/google.ts exports all required interfaces
    - TypeScript compilation passes: `npx tsc --noEmit --pretty 2>&1 | head -20`
  </verify>
  <done>
    4 migration files ready for manual execution in Supabase SQL Editor. TypeScript types defined for all Google Workspace database entities. Token table uses service-role-only access pattern. Link tables use RLS with authenticated user policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Google API library modules and OAuth callback route</name>
  <files>
    lib/google/scopes.ts
    lib/google/retry.ts
    lib/google/client.ts
    app/api/google-oauth/callback/route.ts
    .env.example
  </files>
  <action>
    Create 3 Google library modules and 1 API route:

    **lib/google/scopes.ts:**
    - Export GOOGLE_SCOPES array: ['https://www.googleapis.com/auth/drive.file', 'https://www.googleapis.com/auth/gmail.readonly', 'https://www.googleapis.com/auth/calendar.events']
    - Export SCOPE_DESCRIPTIONS record mapping each scope to human-readable label
    - Use `drive.file` (non-sensitive, user-selected files only per research)

    **lib/google/retry.ts:**
    - Export `withRetry<T>(fn: () => Promise<T>, options?: RetryOptions): Promise<T>`
    - RetryOptions: { maxRetries?: number (default 5), baseDelay?: number (default 1000), maxDelay?: number (default 32000) }
    - Retry on error codes 429 and 503 only (check error.code and error.response?.status)
    - Formula: `min(2^attempt * baseDelay + random(0-1000), maxDelay)` with jitter
    - Console.log retry attempts for debugging
    - Throw original error on non-retryable errors or after max retries exhausted

    **lib/google/client.ts:**
    - Import { google } from 'googleapis' and createAdminClient from '@/lib/supabase/server'
    - Export `createGoogleClient(userId: string): Promise<OAuth2Client>` - loads refresh token from google_oauth_tokens table using admin client (service role), creates OAuth2Client with credentials, listens for token refresh events to update stored tokens
    - Export `getGoogleAuthUrl(redirectUrl?: string): string` - generates OAuth2 authorization URL with offline access, consent prompt, and GOOGLE_SCOPES. Include state parameter with redirectUrl for post-auth navigation
    - Export `hasGoogleTokens(userId: string): Promise<boolean>` - checks if user has stored refresh token
    - Use env vars: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, NEXT_PUBLIC_URL for redirect URI
    - Token table operations use admin client (createAdminClient) to bypass RLS

    **app/api/google-oauth/callback/route.ts:**
    - Export GET handler that:
      1. Extracts `code` and `state` from URL params
      2. Gets current user from Supabase session (using createClient from server.ts)
      3. Exchanges code for tokens using google.auth.OAuth2 getToken()
      4. Stores refresh_token in google_oauth_tokens table using admin client (upsert on user_id)
      5. Redirects to state parameter URL or /investors on success
      6. Redirects to /investors?error=google_auth_failed on failure
    - Log errors with context for debugging

    **Update .env.example:**
    - Uncomment the existing GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET entries
    - Add: NEXT_PUBLIC_GOOGLE_API_KEY and NEXT_PUBLIC_GOOGLE_CLIENT_ID with descriptions
  </action>
  <verify>
    - `npx tsc --noEmit --pretty 2>&1 | head -20` passes without Google-related errors
    - lib/google/client.ts imports googleapis and creates OAuth2Client
    - app/api/google-oauth/callback/route.ts exports GET function
    - .env.example has all 4 Google env vars documented
  </verify>
  <done>
    Google API client factory creates authenticated clients per user from stored refresh tokens. Retry wrapper implements exponential backoff with jitter for 429/503 errors. OAuth callback route handles token exchange and storage. All env vars documented.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Execute SQL migrations 020-023 in Supabase SQL Editor</action>
  <instructions>
    Run the following migration files in order in Supabase SQL Editor (Dashboard -> SQL Editor -> New Query):
    1. `lib/database/migrations/020-google-oauth-tokens.sql`
    2. `lib/database/migrations/021-drive-links.sql`
    3. `lib/database/migrations/022-email-logs.sql`
    4. `lib/database/migrations/023-calendar-events.sql`

    After running, verify tables exist by running:
    ```sql
    SELECT table_name FROM information_schema.tables
    WHERE table_schema = 'public'
    AND table_name IN ('google_oauth_tokens', 'drive_links', 'email_logs', 'calendar_events');
    ```
    Expected: 4 rows returned.
  </instructions>
  <resume-signal>Type "migrations done" when all 4 tables are created in Supabase</resume-signal>
</task>

</tasks>

<verification>
- 4 SQL migration files exist with proper schema
- types/google.ts compiles and exports required interfaces
- lib/google/ has client.ts, retry.ts, scopes.ts
- app/api/google-oauth/callback/route.ts handles OAuth code exchange
- .env.example documents all Google env vars
- TypeScript compilation passes
</verification>

<success_criteria>
Google Workspace foundation is complete: database tables created, TypeScript types defined, OAuth client factory operational, retry wrapper implemented, OAuth callback route ready. All three service integrations (Drive, Gmail, Calendar) can build on this foundation.
</success_criteria>

<output>
After completion, create `.planning/phases/07-google-workspace-integration/07-01-SUMMARY.md`
</output>
