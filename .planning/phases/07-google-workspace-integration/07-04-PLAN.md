---
phase: 07-google-workspace-integration
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - app/(dashboard)/investors/[id]/page.tsx
  - components/investors/google-workspace-section.tsx
  - components/investors/google-connect-banner.tsx
autonomous: false

must_haves:
  truths:
    - "Investor detail page shows Google Workspace section with Drive, Email, and Calendar tabs"
    - "Users without Google tokens see a 'Connect Google Account' banner with authorization link"
    - "Linked Drive documents, logged emails, and scheduled meetings all display correctly on investor page"
    - "All Google Workspace actions (link doc, log email, schedule meeting) are accessible from investor detail"
    - "Activity timeline shows entries for all Google Workspace interactions"
  artifacts:
    - path: "components/investors/google-workspace-section.tsx"
      provides: "Tabbed container for all Google Workspace integrations"
      min_lines: 60
    - path: "components/investors/google-connect-banner.tsx"
      provides: "Banner prompting user to connect Google account"
      min_lines: 20
    - path: "app/(dashboard)/investors/[id]/page.tsx"
      provides: "Updated investor detail page with Google Workspace section"
      contains: "GoogleWorkspaceSection"
  key_links:
    - from: "app/(dashboard)/investors/[id]/page.tsx"
      to: "components/investors/google-workspace-section.tsx"
      via: "Renders GoogleWorkspaceSection with investor data and Google status"
      pattern: "GoogleWorkspaceSection"
    - from: "components/investors/google-workspace-section.tsx"
      to: "components/investors/drive-file-picker.tsx"
      via: "Renders DriveFilePicker in Documents tab"
      pattern: "DriveFilePicker"
    - from: "components/investors/google-workspace-section.tsx"
      to: "components/investors/email-logger.tsx"
      via: "Renders EmailLogger in Emails tab"
      pattern: "EmailLogger"
    - from: "components/investors/google-workspace-section.tsx"
      to: "components/investors/meeting-scheduler.tsx"
      via: "Renders MeetingScheduler in Meetings tab"
      pattern: "MeetingScheduler"
---

<objective>
Wire all Google Workspace components into the investor detail page: create a tabbed GoogleWorkspaceSection that contains Drive documents, Gmail emails, and Calendar meetings, add a Google account connection banner for users who haven't authorized, and update the investor detail page to fetch and display Google Workspace data.

Purpose: Complete the user-facing integration by assembling all Google Workspace features into a cohesive section on the investor detail page, with proper auth state handling and data fetching.

Output: GoogleWorkspaceSection component, GoogleConnectBanner component, updated investor detail page.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-google-workspace-integration/07-01-SUMMARY.md
@.planning/phases/07-google-workspace-integration/07-02-SUMMARY.md
@.planning/phases/07-google-workspace-integration/07-03-SUMMARY.md
@app/(dashboard)/investors/[id]/page.tsx
@components/investors/drive-file-picker.tsx
@components/investors/linked-documents.tsx
@components/investors/email-logger.tsx
@components/investors/meeting-scheduler.tsx
@lib/google/client.ts
@app/actions/google/drive-actions.ts
@app/actions/google/gmail-actions.ts
@app/actions/google/calendar-actions.ts
@types/google.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: GoogleWorkspaceSection and GoogleConnectBanner components</name>
  <files>
    components/investors/google-workspace-section.tsx
    components/investors/google-connect-banner.tsx
  </files>
  <action>
    **components/investors/google-connect-banner.tsx:**
    - 'use client' component
    - Props: { authUrl: string }
    - Render a subtle banner/card with:
      - Google icon (or Cloud icon from lucide-react)
      - Text: "Connect your Google account to link documents, log emails, and schedule meetings"
      - Button: "Connect Google Account" that navigates to authUrl (use <a> tag or router.push)
    - Style: bg-muted/50 border rounded-lg p-4 flex items-center gap-3, match existing card patterns
    - Keep it compact, not intrusive

    **components/investors/google-workspace-section.tsx:**
    - 'use client' component (needs tab state management)
    - Props: { investorId: string; investorName: string; hasGoogleTokens: boolean; googleAuthUrl: string; driveLinks: DriveLink[]; emailLogs: EmailLog[]; calendarEvents: CalendarEvent[] }
    - If !hasGoogleTokens: render GoogleConnectBanner with authUrl, then render the section with all action buttons disabled
    - Tab structure with 3 tabs using simple button-based tabs (not full shadcn Tabs unless already installed). Active tab has border-bottom highlight.
      - Tab 1: "Documents" (count badge from driveLinks.length)
        - DriveFilePicker button + LinkedDocuments list
      - Tab 2: "Emails" (count badge from emailLogs.length)
        - EmailLogger button + email list display
        - Email list: for each EmailLog, show subject (bold), from, sent_date (relative), snippet (truncated 100 chars)
        - Each email row is a simple flex layout, no interactivity beyond display
      - Tab 3: "Meetings" (count badge from calendarEvents.length)
        - MeetingScheduler button + meetings list display
        - Meetings list: for each CalendarEvent, show summary (bold), date range (formatted nicely), attendees count, link to Google Calendar (external link icon)
        - Past meetings shown with muted styling, upcoming meetings with normal styling
    - Pass disabled={!hasGoogleTokens} to DriveFilePicker, EmailLogger, MeetingScheduler
    - Use Tailwind classes matching existing section patterns: rounded-lg border bg-card p-6
    - Section header: "Google Workspace" with h2 styling matching other sections
    - Import all child components: DriveFilePicker, LinkedDocuments, EmailLogger, MeetingScheduler, GoogleConnectBanner
  </action>
  <verify>
    - `npx tsc --noEmit --pretty 2>&1 | head -20` passes
    - GoogleWorkspaceSection renders 3 tabs with proper content
    - GoogleConnectBanner renders auth link
    - Disabled state properly gates actions when no tokens
  </verify>
  <done>
    GoogleWorkspaceSection provides tabbed interface for all Google integrations with connection status awareness. Unauthenticated users see connect banner and disabled buttons. Authenticated users have full access to Drive linking, email logging, and meeting scheduling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire GoogleWorkspaceSection into investor detail page</name>
  <files>
    app/(dashboard)/investors/[id]/page.tsx
  </files>
  <action>
    Update the investor detail page server component to:

    1. Import hasGoogleTokens and getGoogleAuthUrl from @/lib/google/client
    2. Import getDriveLinks from @/app/actions/google/drive-actions
    3. Import getEmailLogs from @/app/actions/google/gmail-actions
    4. Import getCalendarEvents from @/app/actions/google/calendar-actions
    5. Import GoogleWorkspaceSection from @/components/investors/google-workspace-section

    6. In the async function body, after fetching investor + activities + connections:
       - Get current user via getCurrentUser()
       - Check Google tokens: const googleConnected = user ? await hasGoogleTokens(user.id) : false
       - Get Google auth URL: const googleAuthUrl = getGoogleAuthUrl(`/investors/${id}`)
       - Fetch Google data (only if connected, to avoid unnecessary calls):
         ```
         const [driveLinksResult, emailLogsResult, calendarEventsResult] = googleConnected
           ? await Promise.all([getDriveLinks(id), getEmailLogs(id), getCalendarEvents(id)])
           : [{ data: [] }, { data: [] }, { data: [] }];
         ```

    7. Add GoogleWorkspaceSection between LinkedIn Connections and Activity History sections:
       ```tsx
       {/* Google Workspace */}
       <GoogleWorkspaceSection
         investorId={investor.id}
         investorName={investor.firm_name}
         hasGoogleTokens={googleConnected}
         googleAuthUrl={googleAuthUrl}
         driveLinks={driveLinksResult.data || []}
         emailLogs={emailLogsResult.data || []}
         calendarEvents={calendarEventsResult.data || []}
       />
       ```

    Keep all existing sections (InvestorFormSections, ContactList, InvestorConnectionsTab, QuickAddActivityModal, InvestorActivityTimeline) unchanged. Only add the new Google Workspace section.
  </action>
  <verify>
    - `npx tsc --noEmit --pretty 2>&1 | head -20` passes
    - Investor detail page imports GoogleWorkspaceSection
    - Page fetches Google data conditionally (only when tokens exist)
    - GoogleWorkspaceSection renders between LinkedIn Connections and Activity History
    - Dev server starts without errors: `npm run dev` (check for build errors)
  </verify>
  <done>
    Investor detail page integrates Google Workspace section with conditional data fetching. Users see Drive documents, Gmail emails, and Calendar meetings for each investor. Non-connected users see a banner to authorize Google access.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Google Workspace integration on investor detail page:
    - Google account connection banner (if not connected)
    - Google Drive document linking via Picker
    - Gmail email search and logging
    - Google Calendar meeting scheduling
    - All actions log to activity timeline
  </what-built>
  <how-to-verify>
    1. Navigate to any investor detail page (e.g., /investors/{id})
    2. Verify "Google Workspace" section appears with 3 tabs (Documents, Emails, Meetings)
    3. If Google not connected: verify "Connect Google Account" banner appears with authorization link
    4. Click "Connect Google Account" and complete Google OAuth flow
    5. After connecting, verify:
       a. Documents tab: "Link Document" button opens Google Picker, selecting a file links it
       b. Emails tab: "Log Email" button opens search, searching finds Gmail messages, logging one adds it
       c. Meetings tab: "Schedule Meeting" opens form, submitting creates Calendar event
    6. Verify Activity History shows entries for linked doc, logged email, and scheduled meeting
    7. Verify all UI matches dark theme and existing design patterns
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Investor detail page loads without errors
- GoogleWorkspaceSection renders with 3 tabs
- Connection state properly detected and banner shown/hidden
- Drive file picker integration functional
- Gmail email search and logging functional
- Calendar meeting scheduling functional
- Activity timeline entries created for all workspace actions
- Dark theme and existing design patterns maintained
- TypeScript compilation passes
</verification>

<success_criteria>
Google Workspace integration is complete and visible on investor detail page. Users can connect their Google account, link Drive documents, log Gmail emails, and schedule Calendar meetings - all from the investor detail page. Every action is logged to the activity timeline for comprehensive audit trail.
</success_criteria>

<output>
After completion, create `.planning/phases/07-google-workspace-integration/07-04-SUMMARY.md`
</output>
