---
phase: 07-google-workspace-integration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - app/actions/google/drive-actions.ts
  - components/investors/drive-file-picker.tsx
  - components/investors/linked-documents.tsx
autonomous: true

must_haves:
  truths:
    - "User can open Google Picker and select a Drive file to link to an investor"
    - "Linked Drive files appear in a dedicated section with file name, type icon, and link to open in Google"
    - "Linking a file logs an activity to the investor timeline"
    - "User can unlink a Drive file from an investor"
  artifacts:
    - path: "app/actions/google/drive-actions.ts"
      provides: "Server actions for Drive file operations"
      exports: ["linkDriveFileToInvestor", "unlinkDriveFile", "getDriveLinks"]
    - path: "components/investors/drive-file-picker.tsx"
      provides: "Google Picker integration for file selection"
      min_lines: 40
    - path: "components/investors/linked-documents.tsx"
      provides: "Display linked Drive files with unlink action"
      min_lines: 50
  key_links:
    - from: "components/investors/drive-file-picker.tsx"
      to: "app/actions/google/drive-actions.ts"
      via: "linkDriveFileToInvestor server action call"
      pattern: "linkDriveFileToInvestor"
    - from: "app/actions/google/drive-actions.ts"
      to: "activities table"
      via: "Activity logging on link/unlink"
      pattern: "activities.*insert"
---

<objective>
Build Google Drive integration: server actions for linking/unlinking Drive files to investor records, Google Picker component for file selection, and LinkedDocuments display component showing linked files with metadata.

Purpose: Enable users to associate Google Drive documents (pitch decks, term sheets, due diligence materials) with specific investor records, creating a document trail accessible from the investor detail page.

Output: Drive server actions file, Picker component, LinkedDocuments component. All ready to be wired into investor detail page in Plan 04.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-google-workspace-integration/07-RESEARCH.md
@.planning/phases/07-google-workspace-integration/07-01-SUMMARY.md
@lib/google/client.ts
@lib/google/retry.ts
@types/google.ts
@types/investors.ts
@lib/supabase/auth-helpers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Drive server actions with activity logging</name>
  <files>
    app/actions/google/drive-actions.ts
  </files>
  <action>
    Create server actions file for Google Drive operations. Mark as 'use server'.

    **linkDriveFileToInvestor(params: { investorId: string; fileId: string; fileName: string; fileUrl: string; mimeType: string; thumbnailUrl?: string }):**
    - Get current user via getCurrentUser() from auth-helpers
    - Throw if not authenticated
    - Insert into drive_links table: investor_id, file_id, file_name, file_url, mime_type, thumbnail_url, linked_by (user.id)
    - Log activity to activities table: investor_id, activity_type='note', description=`Linked document: ${fileName}`, metadata={ type: 'drive_link', file_id, file_url, mime_type }, created_by (user.id)
    - Use regular supabase client (not admin) since drive_links has RLS for authenticated users
    - Return { success: true } or throw on error
    - Wrap with revalidatePath(`/investors/${params.investorId}`) after successful insert

    **unlinkDriveFile(params: { linkId: string; investorId: string; fileName: string }):**
    - Get current user, throw if not authenticated
    - Delete from drive_links where id = linkId
    - Log activity: activity_type='note', description=`Unlinked document: ${fileName}`, metadata={ type: 'drive_unlink' }
    - revalidatePath after success

    **getDriveLinks(investorId: string):**
    - Get current user, throw if not authenticated
    - Select all from drive_links where investor_id, order by created_at desc
    - Return { data: DriveLink[] } or { error: string }

    Import types from @/types/google. Use createClient from @/lib/supabase/server.
  </action>
  <verify>
    - `npx tsc --noEmit --pretty 2>&1 | head -20` passes
    - File exports linkDriveFileToInvestor, unlinkDriveFile, getDriveLinks
    - All functions marked 'use server' via file-level directive
  </verify>
  <done>
    Drive server actions handle linking/unlinking files with activity logging and path revalidation. All operations use authenticated Supabase client with RLS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Google Picker component and LinkedDocuments display</name>
  <files>
    components/investors/drive-file-picker.tsx
    components/investors/linked-documents.tsx
  </files>
  <action>
    Install react-google-drive-picker: `npm install react-google-drive-picker`

    **components/investors/drive-file-picker.tsx:**
    - 'use client' component
    - Import useDrivePicker from 'react-google-drive-picker'
    - Import { linkDriveFileToInvestor } from '@/app/actions/google/drive-actions'
    - Import { useRouter } from 'next/navigation'
    - Props: { investorId: string; disabled?: boolean }
    - On click: open Google Picker with:
      - clientId from process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID
      - developerKey from process.env.NEXT_PUBLIC_GOOGLE_API_KEY
      - viewId: 'DOCS' (all document types)
      - showUploadView: false, showUploadFolders: false
      - supportDrives: true (include shared drives per research)
      - multiselect: false
    - On file picked (data.action === 'picked'):
      - Call linkDriveFileToInvestor with file metadata (id, name, url, mimeType)
      - Show toast on success via sonner (toast.success(`Linked: ${fileName}`))
      - Show toast.error on failure
    - Render as a Button (from shadcn) with Paperclip icon from lucide-react, text "Link Document"
    - If disabled prop true, show disabled button with tooltip "Connect Google account first"

    **components/investors/linked-documents.tsx:**
    - 'use client' component (needs interactivity for unlink)
    - Props: { links: DriveLink[]; investorId: string }
    - If no links: show muted text "No documents linked yet"
    - For each link, render a row with:
      - File type icon based on mime_type (use FileText for docs, FileSpreadsheet for sheets, Presentation for slides, File for other - all from lucide-react)
      - File name as a link (target="_blank" rel="noopener noreferrer" to file_url)
      - Relative time since linked (use existing formatRelativeTime from lib/utils.ts if available, or simple date)
      - Unlink button (X icon) that calls unlinkDriveFile server action with confirmation
    - Use Tailwind for dark theme compatible styling matching existing card patterns
    - Import { unlinkDriveFile } from '@/app/actions/google/drive-actions'
  </action>
  <verify>
    - `npx tsc --noEmit --pretty 2>&1 | head -20` passes
    - react-google-drive-picker is in package.json dependencies
    - Both components exist and are 'use client'
    - DriveFilePicker renders a button that opens Google Picker
    - LinkedDocuments renders a list of file links with unlink action
  </verify>
  <done>
    DriveFilePicker component opens Google Picker for file selection and calls server action to link. LinkedDocuments displays all linked files with metadata and unlink capability. Both components ready for integration into investor detail page.
  </done>
</task>

</tasks>

<verification>
- npm install succeeded for react-google-drive-picker
- All 3 files compile without TypeScript errors
- Server actions properly import Google types and auth helpers
- Components properly import and call server actions
- Activity logging included in link/unlink operations
</verification>

<success_criteria>
Google Drive integration is fully implemented: users can select Drive files via Google Picker, files are linked to investor records with metadata stored in database, linked files display with type icons and open-in-Google links, unlinking removes the association and logs the action. All operations log to activity timeline.
</success_criteria>

<output>
After completion, create `.planning/phases/07-google-workspace-integration/07-02-SUMMARY.md`
</output>
