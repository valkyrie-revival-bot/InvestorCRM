---
phase: 09-ai-bdr-agent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/ai/tools/query-pipeline.ts
  - lib/ai/tools/get-investor-detail.ts
  - lib/ai/tools/strategy-advisor.ts
  - lib/ai/tools/index.ts
  - lib/ai/system-prompt.ts
  - lib/ai/security.ts
  - app/api/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "Chat API endpoint accepts POST with messages array and returns streaming response"
    - "AI agent can query investor pipeline data (stalled, by stage, high value, recent activity)"
    - "AI agent can fetch detailed investor information including contacts and activities"
    - "AI agent can provide strategy recommendations based on pipeline data"
    - "All tools use Zod schemas for input validation"
    - "Tools return sanitized data (no raw SQL, no sensitive field exposure)"
  artifacts:
    - path: "app/api/chat/route.ts"
      provides: "Chat API endpoint with streamText and tool calling"
      exports: ["POST"]
    - path: "lib/ai/tools/query-pipeline.ts"
      provides: "Read-only pipeline query tool with allowlisted query types"
      exports: ["queryPipelineTool"]
    - path: "lib/ai/tools/get-investor-detail.ts"
      provides: "Read-only investor detail lookup tool"
      exports: ["getInvestorDetailTool"]
    - path: "lib/ai/tools/strategy-advisor.ts"
      provides: "Strategy recommendation tool using pipeline context"
      exports: ["strategyAdvisorTool"]
    - path: "lib/ai/tools/index.ts"
      provides: "Tool registry exporting all tools"
      exports: ["readOnlyTools", "allTools"]
    - path: "lib/ai/system-prompt.ts"
      provides: "BDR agent system prompt with role definition and security constraints"
      exports: ["BDR_SYSTEM_PROMPT"]
    - path: "lib/ai/security.ts"
      provides: "Input validation and sanitization utilities"
      exports: ["validateUserInput", "sanitizeToolOutput"]
  key_links:
    - from: "app/api/chat/route.ts"
      to: "lib/ai/tools/index.ts"
      via: "import tools registry"
      pattern: "import.*tools.*from.*lib/ai/tools"
    - from: "app/api/chat/route.ts"
      to: "lib/ai/system-prompt.ts"
      via: "import system prompt"
      pattern: "import.*BDR_SYSTEM_PROMPT"
    - from: "lib/ai/tools/query-pipeline.ts"
      to: "lib/supabase/server.ts"
      via: "Supabase server client for DB queries"
      pattern: "createClient.*from.*supabase/server"
---

<objective>
Create the AI BDR agent backend: chat API endpoint with Claude Sonnet 4.5, read-only CRM tools (pipeline queries, investor detail, strategy advisor), system prompt, and input security.

Purpose: This is the AI brain of the BDR agent. It enables natural language pipeline queries and strategic recommendations -- the competitive differentiator for the Friday demo.

Output: Working `/api/chat` endpoint that accepts messages and streams AI responses with tool-calling support. All read-only tools functional.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ai-bdr-agent/09-RESEARCH.md

Key existing files to reference:
@types/investors.ts — Investor, Contact, Activity types, InvestorStage, AllocatorType
@app/actions/investors.ts — getInvestors(), getInvestor(), getActivities(), updateInvestorField()
@lib/supabase/server.ts — createClient() for authenticated Supabase access
@lib/stage-definitions.ts — STAGE_DEFINITIONS, STAGE_ORDER, computeIsStalled()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI tools and system prompt</name>
  <files>
    lib/ai/tools/query-pipeline.ts
    lib/ai/tools/get-investor-detail.ts
    lib/ai/tools/strategy-advisor.ts
    lib/ai/tools/index.ts
    lib/ai/system-prompt.ts
    lib/ai/security.ts
  </files>
  <action>
Create the AI tool infrastructure:

**lib/ai/security.ts** — Input validation utilities:
- `validateUserInput(input: string): { valid: boolean; sanitized: string; reason?: string }` — Check for prompt injection patterns (meta-instructions like "ignore previous", "for each X do Y", excessive length >2000 chars). Sanitize by stripping control characters. Return sanitized input.
- `sanitizeToolOutput(data: any, redactFields?: string[]): any` — Remove sensitive fields (email, phone) from tool output before returning to model. Keep firm_name, stage, est_value, dates, conviction, strategy notes.

**lib/ai/tools/query-pipeline.ts** — Read-only pipeline query tool:
- Use `tool()` from 'ai' package with Zod inputSchema
- Accept `intent` enum: 'stalled_investors' | 'investors_by_stage' | 'high_value_pipeline' | 'recent_activity' | 'pipeline_summary' | 'upcoming_actions'
- Accept optional `filters` object: `{ stage?: string, minValue?: number, timeframeDays?: number, conviction?: string }`
- Execute function: use `createClient()` from '@/lib/supabase/server' to query investors table directly (NOT through server actions, since this runs in API route context)
- Filter by `is('deleted_at', null)` always
- For 'stalled_investors': use `computeIsStalled()` from '@/lib/stage-definitions' on results (compute client-side, not SQL)
- For 'pipeline_summary': return count by stage (group in JS after fetch)
- For 'upcoming_actions': filter where next_action_date is within next 7 days
- Limit results to 50 records max
- Sanitize output: return firm_name, stage, est_value, last_action_date (as days ago), internal_conviction, next_action, next_action_date, stalled status. Do NOT return raw emails or phone numbers.
- Return `{ count, investors, summary }` where summary is a human-readable sentence

**lib/ai/tools/get-investor-detail.ts** — Single investor lookup:
- Accept `{ firmName: string }` (NOT UUID — the AI works with names, not IDs)
- Use Supabase `.ilike('firm_name', `%${firmName}%`)` for fuzzy matching
- If multiple matches, return all matches with a note to clarify
- If single match, fetch contacts and recent activities (last 10) for that investor
- Return investor details + contacts (name, title only) + recent activity summaries
- Sanitize: redact email/phone from contacts, only show name and title

**lib/ai/tools/strategy-advisor.ts** — Strategy recommendation tool:
- Accept `{ investorId: string, requestType: 'next_steps' | 'risk_assessment' | 'prioritization' | 'objection_handling' }`
- Fetch investor data including current_strategy_notes, last_strategy_notes, key_objection_risk, stage, activities
- Return structured context that helps Claude reason about strategy:
  - Current stage and days in stage
  - Current strategy notes
  - Key objections/risks
  - Recent activity summary (last 5)
  - Next action and date
  - Stalled status
- Do NOT generate the recommendation in the tool — let Claude reason from the data. The tool provides context, the model provides insight.

**lib/ai/tools/index.ts** — Tool registry:
- Export `readOnlyTools` object containing queryPipeline, getInvestorDetail, strategyAdvisor
- Export `allTools` (same for now, write tools added in Plan 03)

**lib/ai/system-prompt.ts** — BDR agent system prompt:
- Define the agent's role: AI BDR assistant for Prytaneum's investor CRM (Valkyrie)
- Explain available tools and when to use each
- Security constraints: read-only access by default, never fabricate investor data, always cite which investors data comes from
- Personality: professional, concise, data-driven. Use investor/fundraising terminology.
- Pipeline context: explain stage progression (Not Yet Approached through Won/Lost/Delayed), what "stalled" means (30+ days no action)
- Include the STAGE_ORDER as reference so Claude understands pipeline stages
- Instruct: if user asks to update records, explain that write access requires confirmation (will be added in Plan 03)
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all files compile without errors. Check that imports resolve correctly.
  </verify>
  <done>
All 6 files exist, compile, and export their documented interfaces. Tool schemas validate with Zod. Security utilities handle edge cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chat API route with streaming</name>
  <files>
    app/api/chat/route.ts
  </files>
  <action>
Create the chat API endpoint at `app/api/chat/route.ts`:

```typescript
import { streamText, convertToModelMessages, UIMessage, stepCountIs } from 'ai';
import { anthropic } from '@ai-sdk/anthropic';
import { createClient } from '@/lib/supabase/server';
import { BDR_SYSTEM_PROMPT } from '@/lib/ai/system-prompt';
import { allTools } from '@/lib/ai/tools';
import { validateUserInput } from '@/lib/ai/security';
```

Implementation:
- `export const maxDuration = 60;` — Allow up to 60 seconds for streaming responses
- POST handler:
  1. Parse `{ messages }: { messages: UIMessage[] }` from request body
  2. Authenticate user via `createClient()` → `supabase.auth.getUser()`. Return 401 if not authenticated.
  3. Extract latest user message text. Run through `validateUserInput()`. If invalid, return 400 with reason.
  4. Call `streamText()` with:
     - `model: anthropic('claude-sonnet-4-5')` — Use Sonnet 4.5 for cost-effective operations
     - `system: BDR_SYSTEM_PROMPT`
     - `messages: await convertToModelMessages(messages)`
     - `tools: allTools`
     - `stopWhen: stepCountIs(5)` — Prevent infinite tool calling loops (max 5 steps per turn)
  5. Return `result.toUIMessageStreamResponse()`

IMPORTANT API patterns (from AI SDK v6 docs verified via Context7):
- Use `convertToModelMessages()` to convert UIMessage[] to model format
- Use `streamText()` (NOT generateText) for streaming
- Use `toUIMessageStreamResponse()` to return streaming response
- Tools are defined with `tool()` function and `inputSchema` (Zod), NOT `parameters`
- Use `stepCountIs(5)` from 'ai' package for the stopWhen parameter

Do NOT use:
- `ToolLoopAgent` (research mentioned this but it's not in the verified API — use `streamText` with `stopWhen` instead)
- `useCompletion` (deprecated, use `useChat` on client)
- Any Redis/Upstash for rate limiting (defer to Phase 10 if needed)
  </action>
  <verify>
Run `npx tsc --noEmit` to verify the route compiles. Test with `curl -X POST http://localhost:3000/api/chat -H "Content-Type: application/json" -d '{"messages":[{"role":"user","content":"Hello"}]}'` (will get 401 without auth, but confirms route exists and parses).
  </verify>
  <done>
Chat API route exists at /api/chat, accepts POST with messages, authenticates user, validates input, streams Claude responses with tool calling, and limits to 5 steps per turn.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors in new files
2. All tool files export their documented functions
3. System prompt contains role definition, security constraints, and stage context
4. Security module validates input and sanitizes output
5. Chat API route authenticates, validates, streams, and limits steps
</verification>

<success_criteria>
- 7 new files created and compiling
- Chat API endpoint functional at /api/chat
- 3 read-only tools with Zod schemas
- System prompt with BDR role and security constraints
- Input validation prevents prompt injection patterns
- Tool outputs sanitize sensitive fields
</success_criteria>

<output>
After completion, create `.planning/phases/09-ai-bdr-agent/09-01-SUMMARY.md`
</output>
