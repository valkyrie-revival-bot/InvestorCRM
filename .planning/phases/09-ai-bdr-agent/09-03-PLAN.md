---
phase: 09-ai-bdr-agent
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - lib/ai/tools/update-investor.ts
  - lib/ai/tools/log-activity.ts
  - lib/ai/tools/index.ts
  - app/api/chat/route.ts
  - app/(dashboard)/layout.tsx
  - components/ai/dashboard-chat-wrapper.tsx
  - components/ai/chat-panel.tsx
autonomous: false

must_haves:
  truths:
    - "User can ask AI to update investor records and sees confirmation before execution"
    - "User can ask AI to log activities for investors"
    - "AI agent operates with read-only access by default, escalates to write with confirmation"
    - "Chat panel is accessible from the dashboard navigation via a toggle button"
    - "All AI-initiated write operations are logged in activity audit trail"
    - "Input validation prevents prompt injection patterns"
  artifacts:
    - path: "lib/ai/tools/update-investor.ts"
      provides: "Write tool that returns confirmation request, not direct mutation"
      exports: ["updateInvestorTool"]
    - path: "lib/ai/tools/log-activity.ts"
      provides: "Activity logging tool for AI-initiated activity creation"
      exports: ["logActivityTool"]
    - path: "app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with AI chat toggle button in header"
      contains: "ChatPanel"
  key_links:
    - from: "app/(dashboard)/layout.tsx"
      to: "components/ai/chat-panel.tsx"
      via: "renders ChatPanel with isOpen state"
      pattern: "ChatPanel.*isOpen"
    - from: "lib/ai/tools/update-investor.ts"
      to: "app/actions/investors.ts"
      via: "calls updateInvestorField for confirmed updates"
      pattern: "updateInvestorField"
    - from: "lib/ai/tools/log-activity.ts"
      to: "app/actions/investors.ts"
      via: "calls createActivity for AI-logged activities"
      pattern: "createActivity"
---

<objective>
Add write tools (update investor, log activity) with human-in-the-loop confirmation, wire the chat panel into the dashboard layout, and verify the complete AI BDR agent flow.

Purpose: This completes the AI BDR agent by enabling conversational record updates (with safety controls) and making the chat accessible from the main dashboard. This is the final step before the Friday demo.

Output: Fully functional AI BDR agent accessible from dashboard with read + write capabilities, security controls, and human verification.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ai-bdr-agent/09-RESEARCH.md
@.planning/phases/09-ai-bdr-agent/09-01-SUMMARY.md
@.planning/phases/09-ai-bdr-agent/09-02-SUMMARY.md

Key existing files:
@app/actions/investors.ts — updateInvestorField(), createActivity()
@app/(dashboard)/layout.tsx — Dashboard layout (will add chat button)
@components/ai/chat-panel.tsx — Chat panel (will add confirmation handling)
@lib/ai/tools/index.ts — Tool registry (will add write tools)
@lib/ai/security.ts — Input validation utilities
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create write tools and update registry</name>
  <files>
    lib/ai/tools/update-investor.ts
    lib/ai/tools/log-activity.ts
    lib/ai/tools/index.ts
  </files>
  <action>
**lib/ai/tools/update-investor.ts** — Write tool with confirmation pattern:
- Use `tool()` from 'ai' with Zod inputSchema
- Accept: `{ firmName: string, field: enum['stage', 'internal_conviction', 'est_value', 'next_action', 'next_action_date', 'current_strategy_notes', 'key_objection_risk'], newValue: string | number, reason: string (min 5 chars) }`
- Execute function does NOT perform the update directly. Instead:
  1. Look up investor by firmName using ilike match (same pattern as get-investor-detail tool)
  2. If no match or multiple matches, return error/clarification message
  3. If single match found, return a confirmation object:
     ```
     { status: 'confirmation_required', investorId, firmName, field, currentValue, newValue, reason }
     ```
  4. The AI will present this to the user as "I'd like to update X. Here's what will change: [field] from [current] to [new]. Reason: [reason]. Shall I proceed?"
- The actual update is NOT executed by this tool. The client-side confirmation handling will call `updateInvestorField()` directly as a server action when user approves.
- This implements the privilege minimization pattern: tool proposes, human disposes.

**lib/ai/tools/log-activity.ts** — Activity logging tool:
- Accept: `{ firmName: string, activityType: enum['note', 'call', 'email', 'meeting'], description: string (min 5 chars, max 500 chars) }`
- Look up investor by firmName
- Call createActivity server action directly (activity logging is lower risk than record mutation)
- Return success/failure result
- NOTE: This is a direct-execute tool (no confirmation needed) because activities are append-only audit trail — they can't corrupt existing data

**Update lib/ai/tools/index.ts:**
- Add updateInvestor and logActivity to the tool registry
- Export `allTools` including all 5 tools (3 read + 2 write)
- Export `writeTools` separately for documentation
  </action>
  <verify>
Run `npx tsc --noEmit` — verify new tool files compile. Run `grep -r "updateInvestorTool\|logActivityTool" lib/ai/tools/index.ts` to confirm both tools are registered in the index.
  </verify>
  <done>
Two write tools created (update-investor with confirmation pattern, log-activity with direct execution). Tool registry updated to export all 5 tools. All files compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire chat panel into dashboard layout with toggle</name>
  <files>
    app/api/chat/route.ts
    app/(dashboard)/layout.tsx
    components/ai/dashboard-chat-wrapper.tsx
  </files>
  <action>
**Update app/api/chat/route.ts:**
- Import updated `allTools` (no other changes needed — tools auto-register)
- Add audit logging: after streaming completes, log the conversation turn to activities table with activity_type 'note', description 'AI BDR agent conversation', metadata containing user message summary. Use a background operation (don't block response).

**Create components/ai/dashboard-chat-wrapper.tsx** — Client wrapper for chat state:
- 'use client' component
- Accepts `children: React.ReactNode` and `userEmail: string` props
- Manages `isChatOpen` boolean state
- Renders the existing header nav structure (preserving current nav links, user email display, sign out)
- Adds a chat toggle button in the header (right side, before user email): Lucide `Bot` icon, toggles `isChatOpen`
- Renders ChatPanel with `isOpen={isChatOpen}` and `onClose={() => setIsChatOpen(false)}`
- Renders `{children}` as the main content area

**Update app/(dashboard)/layout.tsx:**
- This is a server component — delegate interactive header rendering to `DashboardChatWrapper`
- Import `DashboardChatWrapper` from `@/components/ai/dashboard-chat-wrapper`
- Wrap the existing layout content inside `<DashboardChatWrapper userEmail={email}>{children}</DashboardChatWrapper>`
- Remove header rendering from the server component (moved into the client wrapper)
  </action>
  <verify>
Run `npx tsc --noEmit` — verify layout and wrapper compile. Run `grep -r "DashboardChatWrapper" app/\(dashboard\)/layout.tsx` to confirm wrapper is imported and used. Run `grep -r "ChatPanel" components/ai/dashboard-chat-wrapper.tsx` to confirm ChatPanel is rendered.
  </verify>
  <done>
Chat panel accessible from dashboard via toggle button in header. Client wrapper manages open/close state. Server layout delegates to client component for interactivity. API route uses updated tool registry.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add confirmation handling to chat panel</name>
  <files>
    components/ai/chat-panel.tsx
  </files>
  <action>
**Update components/ai/chat-panel.tsx** — Add confirmation UI for write tool results:
- When a message part contains a tool result with `status: 'confirmation_required'`, render a confirmation card with:
  - "Confirm Update" heading
  - Field, current value, new value, reason displayed clearly
  - "Approve" (green) and "Reject" (muted) buttons
- On approve: call `updateInvestorField(investorId, field, newValue)` server action directly (import from `@/app/actions/investors`)
- On reject: append a user message saying "No, cancel that update" to continue conversation
- After confirm/reject, the confirmation card becomes non-interactive (show "Approved" or "Rejected" badge)
- Track confirmation state per tool invocation using a Map or state object keyed by toolCallId
  </action>
  <verify>
Run `npx tsc --noEmit` — verify chat-panel compiles with confirmation handling. Run `grep -r "confirmation_required\|updateInvestorField" components/ai/chat-panel.tsx` to confirm both the detection pattern and server action import are present.
  </verify>
  <done>
Chat panel renders confirmation cards for update-investor tool results. Approve calls server action to execute the update. Reject continues conversation. Cards become non-interactive after user decision.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete AI BDR agent with conversational pipeline queries, strategy recommendations, record updates with confirmation, and activity logging — accessible from dashboard navigation.</what-built>
  <how-to-verify>
1. Open the application at http://localhost:3000/investors
2. Verify a chat icon/button appears in the top navigation header
3. Click the chat icon — a slide-out panel should appear on the right
4. In the chat panel, you should see suggested prompts (e.g., "Show me stalled investors")
5. Click "Show me stalled investors" or type it — verify AI responds with pipeline data
6. Type "Pipeline summary by stage" — verify AI shows stage breakdown
7. Type "Tell me about [an investor name]" — verify detailed investor info appears
8. Type "What strategy should we use for [investor]?" — verify strategic recommendation
9. Type "Update [investor] conviction to High" — verify confirmation dialog appears
10. Approve or reject the update — verify it works correctly
11. Close the panel — verify it slides away and dashboard is fully usable
12. Verify the chat works with dark theme styling

Type "approved" if all checks pass, or describe issues found.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all modified files
2. Chat toggle button visible in dashboard header
3. Chat panel opens/closes with animation
4. AI responds to pipeline queries with formatted tool results
5. AI responds to strategy questions with contextual recommendations
6. Update tool shows confirmation before executing
7. Activity logging works without confirmation (append-only)
8. Input validation rejects suspicious prompts
9. All tool outputs sanitize sensitive fields
</verification>

<success_criteria>
- All 8 AI requirements (AI-01 through AI-08) addressed:
  - AI-01: Chat interface accessible from main UI (toggle in header)
  - AI-02: Natural language pipeline queries ("Show me stalled investors")
  - AI-03: Strategy suggestions based on pipeline data
  - AI-04: Conversational record updates with confirmation
  - AI-05: Relevant investor context surfaced automatically (get-investor-detail tool)
  - AI-06: Prioritization and next action recommendations (strategy-advisor tool + upcoming_actions query)
  - AI-07: Input validation prevents prompt injection
  - AI-08: Read-only by default, write requires confirmation
- Human verification confirms full flow works
</success_criteria>

<output>
After completion, create `.planning/phases/09-ai-bdr-agent/09-03-SUMMARY.md`
</output>
