---
phase: 04-pipeline-views-and-search
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - components/investors/investor-kanban-board.tsx
  - components/investors/kanban-card.tsx
  - components/investors/pipeline-view-switcher.tsx
autonomous: true

must_haves:
  truths:
    - "User can view investor pipeline in kanban board format with columns for each stage"
    - "User can drag an investor card from one stage column to another"
    - "Stage change from drag-and-drop persists to database"
    - "Kanban board shows all 12 stages as scrollable columns"
    - "Empty stage columns show 'No investors in this stage' message"
    - "Kanban cards display firm name, primary contact, estimated value, and stalled badge"
  artifacts:
    - path: "components/investors/investor-kanban-board.tsx"
      provides: "Kanban board with drag-and-drop using @hello-pangea/dnd"
      min_lines: 80
    - path: "components/investors/kanban-card.tsx"
      provides: "Memoized kanban card component"
      min_lines: 40
    - path: "components/investors/pipeline-view-switcher.tsx"
      provides: "Updated view switcher with kanban tab wired to real board"
      min_lines: 80
  key_links:
    - from: "components/investors/investor-kanban-board.tsx"
      to: "app/actions/investors.ts"
      via: "updateInvestorField server action for stage changes"
      pattern: "updateInvestorField.*stage"
    - from: "components/investors/investor-kanban-board.tsx"
      to: "@hello-pangea/dnd"
      via: "DragDropContext, Droppable, Draggable"
      pattern: "DragDropContext"
    - from: "components/investors/pipeline-view-switcher.tsx"
      to: "components/investors/investor-kanban-board.tsx"
      via: "renders kanban in Board tab"
      pattern: "<InvestorKanbanBoard"
---

<objective>
Build the kanban board view for the investor pipeline. Implements drag-and-drop stage transitions using @hello-pangea/dnd, memoized card components for performance, and optimistic UI updates with error rollback.

Purpose: Provides a visual pipeline management view organized by stage, allowing quick stage transitions via drag-and-drop.
Output: Kanban board component integrated into the PipelineViewSwitcher Board tab.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pipeline-views-and-search/04-RESEARCH.md
@.planning/phases/04-pipeline-views-and-search/04-01-SUMMARY.md

@types/investors.ts
@app/actions/investors.ts
@components/investors/pipeline-view-switcher.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @hello-pangea/dnd and create kanban board with drag-and-drop</name>
  <files>
    components/investors/investor-kanban-board.tsx
    components/investors/kanban-card.tsx
  </files>
  <action>
    1. Install @hello-pangea/dnd:
       ```bash
       cd "/Users/RAZER/Documents/projects/sales tracking" && npm install @hello-pangea/dnd
       ```

    2. Create `components/investors/kanban-card.tsx`:
       - 'use client' component
       - Use React.memo with custom comparison function for performance
       - Props: `{ investor: InvestorWithContacts }`
       - Card displays:
         - **Firm name** (font-medium, leading-tight)
         - **Primary contact name** (text-sm text-muted-foreground) if exists
         - **Estimated value** formatted as currency (text-xs font-medium) if exists
         - **Stalled badge** (orange, outline variant) if investor.stalled is true
         - **Next action date** (text-xs text-muted-foreground, "Next: Feb 15") if exists
       - Card is a Link to `/investors/${investor.id}` — clicking navigates to detail
       - Styling: rounded-lg border bg-card p-3 shadow-sm hover:shadow-md transition-shadow
       - Custom memo comparison: only re-render if id, firm_name, est_value, stalled, next_action_date, or primary_contact.name changed
       - Import Badge from @/components/ui/badge
       - Use formatCurrency helper (inline or import):
         ```typescript
         function formatCurrency(value: number): string {
           return new Intl.NumberFormat('en-US', {
             style: 'currency', currency: 'USD',
             minimumFractionDigits: 0, maximumFractionDigits: 0,
           }).format(value);
         }
         ```

    3. Create `components/investors/investor-kanban-board.tsx`:
       - 'use client' component
       - Props:
         ```typescript
         interface KanbanBoardProps {
           investors: InvestorWithContacts[];
           onStageChange?: (investorId: string, newStage: string) => void;
         }
         ```
       - Define STAGES constant (all 12 stages in pipeline order):
         ```typescript
         const STAGES = [
           'Not Yet Approached', 'Initial Contact', 'First Conversation Held',
           'Materials Shared', 'NDA / Data Room', 'Active Due Diligence',
           'LPA / Legal', 'Won', 'Committed', 'Lost', 'Passed', 'Delayed'
         ];
         ```
       - State: `columns` — Record<string, InvestorWithContacts[]> initialized by grouping investors by stage
       - IMPORTANT: Re-sync columns when investors prop changes (useEffect or useMemo pattern):
         ```typescript
         useEffect(() => {
           const grouped: Record<string, InvestorWithContacts[]> = {};
           STAGES.forEach(stage => {
             grouped[stage] = investors.filter(inv => inv.stage === stage);
           });
           setColumns(grouped);
         }, [investors]);
         ```
       - handleDragEnd implementation:
         a. Extract source, destination, draggableId from DropResult
         b. Early return if no destination or same position
         c. Save previous columns state for rollback
         d. Optimistic update: move investor between columns in local state
         e. If stage changed (source.droppableId !== destination.droppableId):
            - Call `updateInvestorField(draggableId, 'stage', destination.droppableId)`
            - On error: revert to previousColumns, show toast.error('Failed to update stage')
            - On success: show toast.success(`Moved to ${destination.droppableId}`), then call `router.refresh()` to revalidate server data so that switching to Table tab reflects the updated stage
         f. Import `updateInvestorField` from '@/app/actions/investors'
         g. Import `toast` from 'sonner'
         h. Import `useRouter` from 'next/navigation' and call `const router = useRouter()` at top of component
       - Layout:
         ```
         <DragDropContext onDragEnd={handleDragEnd}>
           <div className="flex gap-3 overflow-x-auto pb-4 -mx-2 px-2">
             {STAGES.map(stage => (
               <div className="min-w-[260px] max-w-[260px] flex-shrink-0">
                 <div className="sticky top-0 mb-2 flex items-center justify-between bg-background/95 backdrop-blur px-1">
                   <h3 className="text-sm font-semibold truncate">{stage}</h3>
                   <span className="text-xs text-muted-foreground tabular-nums">
                     {columns[stage]?.length || 0}
                   </span>
                 </div>
                 <Droppable droppableId={stage}>
                   {(provided, snapshot) => (
                     <div
                       ref={provided.innerRef}
                       {...provided.droppableProps}
                       className={`space-y-2 rounded-lg border p-2 min-h-[200px] transition-colors ${
                         snapshot.isDraggingOver ? 'bg-accent/50 border-accent' : 'bg-muted/10'
                       }`}
                     >
                       {columns[stage]?.map((investor, index) => (
                         <Draggable key={investor.id} draggableId={investor.id} index={index}>
                           {(provided, snapshot) => (
                             <div
                               ref={provided.innerRef}
                               {...provided.draggableProps}
                               {...provided.dragHandleProps}
                               className={snapshot.isDragging ? 'opacity-90 rotate-1' : ''}
                             >
                               <KanbanCard investor={investor} />
                             </div>
                           )}
                         </Draggable>
                       ))}
                       {(columns[stage]?.length === 0) && !snapshot.isDraggingOver && (
                         <div className="flex h-24 items-center justify-center text-xs text-muted-foreground">
                           No investors in this stage
                         </div>
                       )}
                       {provided.placeholder}
                     </div>
                   )}
                 </Droppable>
               </div>
             ))}
           </div>
         </DragDropContext>
         ```

    IMPORTANT:
    - Use `@hello-pangea/dnd` imports (NOT react-beautiful-dnd)
    - The board must handle the case where investors have a stage not in STAGES — group them under "Other" or skip
    - Optimistic update pattern: save previous state before mutation, revert on error
    - Card Link clicks must still work even with drag handles — hello-pangea/dnd handles this automatically (short clicks pass through, drags are intercepted)
  </action>
  <verify>
    - File exists: `components/investors/investor-kanban-board.tsx`
    - File exists: `components/investors/kanban-card.tsx`
    - @hello-pangea/dnd is in package.json
    - KanbanCard uses React.memo with custom comparison
    - InvestorKanbanBoard uses DragDropContext, Droppable, Draggable
    - handleDragEnd calls updateInvestorField on stage change
    - `npm run build` succeeds
  </verify>
  <done>Kanban board component with drag-and-drop stage transitions and memoized cards created.</done>
</task>

<task type="auto">
  <name>Task 2: Wire kanban board into PipelineViewSwitcher</name>
  <files>
    components/investors/pipeline-view-switcher.tsx
  </files>
  <action>
    1. Update `components/investors/pipeline-view-switcher.tsx`:
       - Import `InvestorKanbanBoard` from './investor-kanban-board'
       - Replace the kanban placeholder in the Board TabsContent with the real kanban board:
         ```tsx
         <TabsContent value="kanban" className="mt-0">
           <InvestorKanbanBoard investors={filteredInvestors} />
         </TabsContent>
         ```
       - The kanban board receives the SAME filtered investors as the table — search and filters apply to both views
       - When a drag-and-drop stage change occurs in kanban view, the local state updates optimistically but the parent's `investors` prop doesn't change until page revalidation. This is acceptable — the kanban manages its own column state internally.

    IMPORTANT: Do NOT modify the filter or search logic. Only replace the placeholder with the real component import and rendering.
  </action>
  <verify>
    - PipelineViewSwitcher imports InvestorKanbanBoard
    - Board tab renders InvestorKanbanBoard with filtered investors
    - No placeholder text remains in Board tab
    - `npm run build` succeeds
    - Dev server: clicking "Board" tab shows kanban columns
    - Dragging a card between columns calls updateInvestorField
  </verify>
  <done>Kanban board fully integrated into PipelineViewSwitcher Board tab. Drag-and-drop stage changes work with optimistic updates.</done>
</task>

</tasks>

<verification>
1. Navigate to /investors and click "Board" tab — kanban board appears with stage columns
2. Each stage column has a header with stage name and investor count
3. Investor cards show firm name, contact, value, stalled badge
4. Clicking a card navigates to investor detail page
5. Dragging a card from one stage to another updates the UI immediately
6. Toast confirms stage change after successful server update
7. Refreshing the page shows the investor in the new stage (persisted)
8. After drag-and-drop, switching to Table tab shows the investor in the new stage (revalidation working)
9. Empty stage columns show "No investors in this stage"
10. Board horizontally scrolls to show all 12 stage columns
11. Applying filters in the filter bar reduces cards shown in kanban
12. Searching reduces cards shown in kanban
</verification>

<success_criteria>
- Kanban board displays 12 stage columns with investor cards
- Drag-and-drop moves cards between stages with optimistic update
- Stage changes persist to database via updateInvestorField
- Failed stage changes revert and show error toast
- Kanban respects same search/filter state as table view
- Cards link to investor detail page
- Empty columns show descriptive message
- Board scrolls horizontally for all 12 columns
- Build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-pipeline-views-and-search/04-02-SUMMARY.md`
</output>
