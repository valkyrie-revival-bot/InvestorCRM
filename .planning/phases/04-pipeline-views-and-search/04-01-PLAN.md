---
phase: 04-pipeline-views-and-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/ui/tabs.tsx
  - components/investors/pipeline-view-switcher.tsx
  - components/investors/investor-list-table.tsx
  - app/(dashboard)/investors/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can switch between Table and Kanban view tabs on /investors page"
    - "User can search pipeline by firm name, contact name, strategy notes, and key objections with instant results"
    - "User can filter pipeline by stage, allocator type, internal conviction, and stalled status"
    - "Filters and search persist when switching between Table and Kanban tabs"
    - "Table view displays filtered/searched results with existing sorting"
  artifacts:
    - path: "components/ui/tabs.tsx"
      provides: "shadcn/ui Tabs component"
      min_lines: 20
    - path: "components/investors/pipeline-view-switcher.tsx"
      provides: "View switching container with search, filters, and tab content"
      min_lines: 80
    - path: "components/investors/investor-list-table.tsx"
      provides: "Refactored table accepting pre-filtered investor data"
      min_lines: 100
    - path: "app/(dashboard)/investors/page.tsx"
      provides: "Server component rendering PipelineViewSwitcher"
      min_lines: 20
  key_links:
    - from: "app/(dashboard)/investors/page.tsx"
      to: "components/investors/pipeline-view-switcher.tsx"
      via: "passes investors array as prop"
      pattern: "<PipelineViewSwitcher"
    - from: "components/investors/pipeline-view-switcher.tsx"
      to: "components/investors/investor-list-table.tsx"
      via: "passes filtered investors to table"
      pattern: "<InvestorListTable"
    - from: "components/investors/pipeline-view-switcher.tsx"
      to: "useTransition"
      via: "non-blocking search filtering"
      pattern: "startTransition"
---

<objective>
Create the pipeline view switcher with enhanced search and filtering. Adds Table/Kanban tabs (kanban content placeholder for Plan 02), a real-time search bar that searches across firm names, contact names, strategy notes, and key objections, and additional filter controls for allocator type, internal conviction, and stalled status.

Purpose: Delivers the core navigation and search infrastructure for the /investors page. Search and filters are shared across both views.
Output: PipelineViewSwitcher component with Tabs, SearchBar, enhanced filters, and refactored InvestorListTable.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pipeline-views-and-search/04-RESEARCH.md

@types/investors.ts
@components/investors/investor-list-table.tsx
@app/(dashboard)/investors/page.tsx
@app/actions/investors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Tabs component and create PipelineViewSwitcher with search and filters</name>
  <files>
    components/ui/tabs.tsx
    components/investors/pipeline-view-switcher.tsx
  </files>
  <action>
    1. Add shadcn/ui Tabs component:
       ```bash
       cd "/Users/RAZER/Documents/projects/sales tracking" && npx shadcn@latest add tabs --yes
       ```

    2. Create `components/investors/pipeline-view-switcher.tsx` as a 'use client' component:
       - Props: `{ investors: InvestorWithContacts[] }` — receives all investors from server component
       - State management:
         - `searchQuery` (string) — search input value
         - `filteredInvestors` (InvestorWithContacts[]) — result of filtering, managed via useTransition for non-blocking updates
         - `filterStage` (string, default 'all')
         - `filterAllocatorType` (string, default 'all')
         - `filterConviction` (string, default 'all')
         - `filterStalled` (string, default 'all') — 'all' | 'yes' | 'no'
       - Search implementation:
         - Use `React.useTransition` for instant, non-blocking search
         - Input onChange: update `searchQuery` immediately (high priority), run filtering in `startTransition` (low priority)
         - Search across: `firm_name`, `primary_contact?.name`, `primary_contact?.email`, `current_strategy_notes`, `key_objection_risk`
         - Case-insensitive `.includes()` matching (client-side, sufficient for <100 records)
         - Show spinning indicator when isPending is true
       - Filter implementation:
         - Derive unique values for stage, allocator_type, internal_conviction from investors array using useMemo
         - Stage filter: shadcn Select with "All Stages" default
         - Allocator Type filter: shadcn Select with "All Types" default
         - Internal Conviction filter: shadcn Select with "All Convictions" default
         - Stalled filter: shadcn Select with "All" / "Stalled" / "Not Stalled" options
         - "Clear filters" button appears when any filter is active
       - Layout structure:
         ```
         <Tabs defaultValue="table">
           <div className="flex items-center justify-between gap-4">
             <TabsList>
               <TabsTrigger value="table"><Table2 icon/> Table</TabsTrigger>
               <TabsTrigger value="kanban"><KanbanSquare icon/> Board</TabsTrigger>
             </TabsList>
             <div className="relative flex-1 max-w-sm">
               <Search icon (absolute left)/>
               <Input placeholder="Search firms, contacts, notes..." className="pl-9" />
               {isPending && <spinner absolute right/>}
             </div>
           </div>

           <div className="flex gap-3 flex-wrap items-center">
             [Stage Select] [Allocator Type Select] [Conviction Select] [Stalled Select]
             {hasActiveFilters && <Clear filters button>}
             <div className="ml-auto">{count} of {total} investors | Total: ${value}</div>
           </div>

           <TabsContent value="table">
             <InvestorListTable investors={filteredInvestors} />
           </TabsContent>
           <TabsContent value="kanban">
             <div className="flex h-[400px] items-center justify-center rounded-lg border border-dashed">
               <p className="text-muted-foreground">Kanban view — coming in next update</p>
             </div>
           </TabsContent>
         </Tabs>
         ```
       - Import icons from lucide-react: Table2, KanbanSquare, Search, X
       - Export: `PipelineViewSwitcher`

    IMPORTANT: The search bar should use `useTransition` NOT debouncing. Input updates immediately, filtering runs as low priority transition.
  </action>
  <verify>
    - File exists: `components/ui/tabs.tsx`
    - File exists: `components/investors/pipeline-view-switcher.tsx`
    - Component exports PipelineViewSwitcher
    - Uses 'use client' directive
    - Contains useTransition for search
    - Contains TabsList with "table" and "kanban" triggers
    - Contains Select components for all 4 filters (stage, allocator type, conviction, stalled)
    - npm run build succeeds (no TypeScript errors)
  </verify>
  <done>PipelineViewSwitcher component created with Tabs, search bar, and 4 filter controls. Kanban tab has placeholder content.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor InvestorListTable and investors page to use PipelineViewSwitcher</name>
  <files>
    components/investors/investor-list-table.tsx
    app/(dashboard)/investors/page.tsx
  </files>
  <action>
    1. Refactor `components/investors/investor-list-table.tsx`:
       - REMOVE all filter state and filter UI (stage, owner, partner selects) — these move to PipelineViewSwitcher
       - REMOVE the filter bar div entirely
       - REMOVE the summary counts (investor count, total value) — these move to PipelineViewSwitcher
       - KEEP all sorting logic (sortField, sortDirection, toggleSort) — sorting stays in table
       - KEEP the table rendering with all columns
       - KEEP helper functions: getStageBadgeColor, formatCurrency, formatPastDate, formatFutureDate
       - The component now receives pre-filtered investors and only handles sorting + display
       - Add search highlight support: accept optional `searchQuery` prop (string)
         - When searchQuery is provided, highlight matching text in firm_name and contact name cells using a `highlightMatch` helper:
           ```typescript
           function highlightMatch(text: string, query: string): React.ReactNode {
             if (!query || !text) return text;
             const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
             const regex = new RegExp(`(${escaped})`, 'gi');
             const parts = text.split(regex);
             return parts.map((part, i) =>
               regex.test(part)
                 ? <mark key={i} className="bg-yellow-500/30 text-foreground rounded-sm px-0.5">{part}</mark>
                 : part
             );
           }
           ```
       - Updated interface:
         ```typescript
         interface InvestorListTableProps {
           investors: InvestorWithContacts[];
           searchQuery?: string;
         }
         ```

    2. Refactor `app/(dashboard)/investors/page.tsx`:
       - Import PipelineViewSwitcher instead of InvestorListTable
       - Pass `investors` to PipelineViewSwitcher (server fetches, client filters)
       - KEEP QuickCreateModal in the header
       - KEEP the empty state when investors.length === 0
       - KEEP error handling
       - Structure:
         ```tsx
         <div className="space-y-6">
           <div className="flex items-center justify-between">
             <div>
               <h1>Investor Pipeline</h1>
               <p>Track and manage your fundraising relationships</p>
             </div>
             <QuickCreateModal />
           </div>

           {investors.length === 0 ? (
             <EmptyState />
           ) : (
             <PipelineViewSwitcher investors={investors} />
           )}
         </div>
         ```
  </action>
  <verify>
    - InvestorListTable no longer contains filter Select components
    - InvestorListTable accepts searchQuery prop
    - investors/page.tsx renders PipelineViewSwitcher
    - `npm run build` succeeds
    - Dev server shows /investors page with tabs, search bar, and filters
  </verify>
  <done>Investors page uses PipelineViewSwitcher with table/kanban tabs, enhanced search, and 4 filter controls. Table view shows filtered results with search highlighting.</done>
</task>

</tasks>

<verification>
1. Navigate to /investors — page shows "Investor Pipeline" header with tabs (Table / Board)
2. Search bar filters results in real-time across firm names, contact names, strategy notes
3. All 4 filter dropdowns (Stage, Allocator Type, Conviction, Stalled) work independently and together
4. "Clear filters" button appears when any filter is active
5. Investor count and total value update dynamically with filters
6. Table tab shows sorted, filtered investor records
7. Board tab shows placeholder message
8. Clicking investor row still navigates to detail page
9. No TypeScript compilation errors
</verification>

<success_criteria>
- PipelineViewSwitcher renders with Table and Board tabs
- Search filters pipeline by firm name, contact name, strategy notes, key objections in real-time (<500ms)
- Stage, Allocator Type, Conviction, and Stalled filters all functional
- Table view maintains all sorting functionality from Phase 3
- Search highlighting marks matching text in firm name and contact name columns
- Build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-pipeline-views-and-search/04-01-SUMMARY.md`
</output>
