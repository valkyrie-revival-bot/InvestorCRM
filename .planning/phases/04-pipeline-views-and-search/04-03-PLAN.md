---
phase: 04-pipeline-views-and-search
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/actions/investors.ts
  - components/investors/investor-activity-timeline.tsx
  - app/(dashboard)/investors/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view chronological activity history on investor detail page"
    - "User can filter activity timeline by activity type (calls, emails, meetings, stage changes, field updates)"
    - "Each activity shows type icon, description, user identity, and relative timestamp"
    - "Field update activities show what changed (old value to new value)"
    - "Timeline displays activities in reverse chronological order (newest first)"
  artifacts:
    - path: "components/investors/investor-activity-timeline.tsx"
      provides: "Activity timeline with type filtering and vertical feed layout"
      min_lines: 80
    - path: "app/actions/investors.ts"
      provides: "getActivities server action for fetching investor activities"
      contains: "getActivities"
    - path: "app/(dashboard)/investors/[id]/page.tsx"
      provides: "Detail page with activity timeline section"
      contains: "InvestorActivityTimeline"
  key_links:
    - from: "app/(dashboard)/investors/[id]/page.tsx"
      to: "app/actions/investors.ts"
      via: "getActivities server action call"
      pattern: "getActivities"
    - from: "app/(dashboard)/investors/[id]/page.tsx"
      to: "components/investors/investor-activity-timeline.tsx"
      via: "renders timeline with activities data"
      pattern: "<InvestorActivityTimeline"
    - from: "components/investors/investor-activity-timeline.tsx"
      to: "types/investors.ts"
      via: "Activity type import"
      pattern: "Activity.*ActivityType"
---

<objective>
Add activity timeline to the investor detail page. Creates a getActivities server action and a vertical timeline component with activity type filtering. Shows chronological history of all interactions and changes for each investor.

Purpose: Delivers PIPE-12 (activity history timeline), giving users visibility into the full history of interactions with each investor.
Output: InvestorActivityTimeline component on the detail page, getActivities server action.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pipeline-views-and-search/04-RESEARCH.md

@types/investors.ts
@app/actions/investors.ts
@app/(dashboard)/investors/[id]/page.tsx
@components/investors/investor-form-sections.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create getActivities server action and InvestorActivityTimeline component</name>
  <files>
    app/actions/investors.ts
    components/investors/investor-activity-timeline.tsx
  </files>
  <action>
    1. Add `getActivities` server action to `app/actions/investors.ts`:
       - Add at the end of the file, in a new section:
         ```typescript
         // ============================================================================
         // ACTIVITIES
         // ============================================================================

         /**
          * Get activities for an investor, ordered by created_at DESC
          * Returns last 50 activities by default
          */
         export async function getActivities(
           investorId: string,
           limit: number = 50
         ): Promise<
           { data: Activity[]; error?: never } | { data?: never; error: string }
         > {
           try {
             const supabase = await createClient();

             const { data: { user }, error: authError } = await supabase.auth.getUser();
             if (authError || !user) {
               return { error: 'Unauthorized' };
             }

             const { data: activities, error } = await supabase
               .from('activities')
               .select('*')
               .eq('investor_id', investorId)
               .order('created_at', { ascending: false })
               .limit(limit);

             if (error) {
               return { error: error.message };
             }

             return { data: activities || [] };
           } catch (error) {
             if (error instanceof Error) {
               return { error: error.message };
             }
             return { error: 'Failed to fetch activities' };
           }
         }
         ```
       - Import `Activity` type at the top of the file (add to existing import from '@/types/investors'):
         Update the import to: `import type { Investor, InvestorWithContacts, Activity } from '@/types/investors';`

    2. Create `components/investors/investor-activity-timeline.tsx`:
       - 'use client' component
       - Props:
         ```typescript
         interface ActivityTimelineProps {
           activities: Activity[];
         }
         ```
       - State: `filterTypes` (string[]) — empty array means show all
       - Activity type icon mapping using lucide-react:
         ```typescript
         import { Phone, Mail, Calendar, FileText, GitCommit, Pencil } from 'lucide-react';

         const activityConfig: Record<string, { icon: LucideIcon; label: string; color: string }> = {
           call: { icon: Phone, label: 'Call', color: 'text-green-400' },
           email: { icon: Mail, label: 'Email', color: 'text-blue-400' },
           meeting: { icon: Calendar, label: 'Meeting', color: 'text-purple-400' },
           note: { icon: FileText, label: 'Note', color: 'text-zinc-400' },
           stage_change: { icon: GitCommit, label: 'Stage Change', color: 'text-amber-400' },
           field_update: { icon: Pencil, label: 'Update', color: 'text-cyan-400' },
         };
         ```
       - Toggle filter logic:
         ```typescript
         const toggleFilter = (type: string) => {
           setFilterTypes(prev =>
             prev.includes(type)
               ? prev.filter(t => t !== type)
               : [...prev, type]
           );
         };
         ```
       - Filtered activities:
         ```typescript
         const filtered = filterTypes.length === 0
           ? activities
           : activities.filter(a => filterTypes.includes(a.activity_type));
         ```
       - Format relative time helper:
         ```typescript
         function formatRelativeTime(timestamp: string): string {
           const date = new Date(timestamp);
           const now = new Date();
           const diffMs = now.getTime() - date.getTime();
           const diffMins = Math.floor(diffMs / (1000 * 60));
           const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
           const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

           if (diffMins < 1) return 'Just now';
           if (diffMins < 60) return `${diffMins}m ago`;
           if (diffHours < 24) return `${diffHours}h ago`;
           if (diffDays === 1) return 'Yesterday';
           if (diffDays < 7) return `${diffDays}d ago`;
           if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;

           return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
         }
         ```
       - Format metadata for field_update activities:
         ```typescript
         function formatFieldChange(metadata: Record<string, unknown> | null): string | null {
           if (!metadata || !metadata.field) return null;
           const field = String(metadata.field).replace(/_/g, ' ');
           const oldVal = metadata.old_value != null ? String(metadata.old_value) : 'empty';
           const newVal = metadata.new_value != null ? String(metadata.new_value) : 'empty';
           return `${field}: ${oldVal} → ${newVal}`;
         }
         ```
       - Layout structure:
         ```tsx
         <div className="space-y-4">
           {/* Type filter buttons */}
           <div className="flex flex-wrap gap-2">
             {Object.entries(activityConfig).map(([type, config]) => {
               const Icon = config.icon;
               const isActive = filterTypes.length === 0 || filterTypes.includes(type);
               return (
                 <button
                   key={type}
                   onClick={() => toggleFilter(type)}
                   className={`inline-flex items-center gap-1.5 rounded-md px-2.5 py-1 text-xs font-medium transition-colors ${
                     isActive
                       ? 'bg-secondary text-secondary-foreground'
                       : 'bg-muted/30 text-muted-foreground hover:bg-muted/50'
                   }`}
                 >
                   <Icon className={`h-3.5 w-3.5 ${isActive ? config.color : ''}`} />
                   {config.label}
                 </button>
               );
             })}
             {filterTypes.length > 0 && (
               <button
                 onClick={() => setFilterTypes([])}
                 className="inline-flex items-center gap-1 rounded-md px-2.5 py-1 text-xs text-muted-foreground hover:text-foreground"
               >
                 <X className="h-3 w-3" /> Clear
               </button>
             )}
           </div>

           {/* Timeline */}
           {filtered.length === 0 ? (
             <div className="flex h-32 items-center justify-center text-sm text-muted-foreground">
               No activities to display
             </div>
           ) : (
             <div className="relative space-y-0 pl-6
               before:absolute before:left-[11px] before:top-3 before:h-[calc(100%-1.5rem)]
               before:w-px before:bg-border">
               {filtered.map((activity) => {
                 const config = activityConfig[activity.activity_type] || activityConfig.note;
                 const Icon = config.icon;
                 const fieldChange = activity.activity_type === 'field_update'
                   ? formatFieldChange(activity.metadata)
                   : null;

                 return (
                   <div key={activity.id} className="relative pb-4">
                     {/* Timeline dot with icon */}
                     <div className={`absolute -left-6 flex h-6 w-6 items-center justify-center
                       rounded-full bg-background ring-2 ring-border`}>
                       <Icon className={`h-3 w-3 ${config.color}`} />
                     </div>

                     {/* Content card */}
                     <div className="ml-2 rounded-lg border bg-card/50 p-3">
                       <div className="flex items-start justify-between gap-2">
                         <div className="flex-1 min-w-0">
                           <p className="text-sm">{activity.description}</p>
                           {fieldChange && (
                             <p className="mt-1 text-xs text-muted-foreground font-mono">
                               {fieldChange}
                             </p>
                           )}
                         </div>
                         <time className="text-xs text-muted-foreground whitespace-nowrap flex-shrink-0">
                           {formatRelativeTime(activity.created_at)}
                         </time>
                       </div>
                     </div>
                   </div>
                 );
               })}
             </div>
           )}
         </div>
         ```
       - Import X from lucide-react for clear button
       - Import type LucideIcon from lucide-react for config typing (or use `typeof Phone` pattern)

    IMPORTANT:
    - Activities are immutable (no edit/delete UI needed)
    - Sort order comes from server (created_at DESC) — do NOT re-sort on client
    - Field change display must handle null old/new values gracefully
    - Use ring-2 ring-border for timeline dot to match dark theme
  </action>
  <verify>
    - `getActivities` function exists in app/actions/investors.ts
    - File exists: `components/investors/investor-activity-timeline.tsx`
    - Component exports InvestorActivityTimeline
    - Uses 'use client' directive
    - Contains filter toggle buttons for all 6 activity types
    - Contains formatRelativeTime helper
    - Contains formatFieldChange helper for metadata display
    - `npm run build` succeeds
  </verify>
  <done>getActivities server action and InvestorActivityTimeline component created with type filtering and vertical timeline layout.</done>
</task>

<task type="auto">
  <name>Task 2: Add activity timeline section to investor detail page</name>
  <files>
    app/(dashboard)/investors/[id]/page.tsx
  </files>
  <action>
    1. Update `app/(dashboard)/investors/[id]/page.tsx`:
       - Import `getActivities` from '@/app/actions/investors'
       - Import `InvestorActivityTimeline` from '@/components/investors/investor-activity-timeline'
       - After fetching investor data, also fetch activities:
         ```typescript
         // Fetch activities for timeline
         const activitiesResult = await getActivities(id);
         const activities = activitiesResult.data || [];
         ```
       - Add activity timeline section AFTER the Contacts section:
         ```tsx
         {/* Activity Timeline */}
         <div className="rounded-lg border bg-card p-6">
           <h2 className="text-lg font-semibold mb-4">Activity History</h2>
           {activities.length === 0 ? (
             <p className="text-sm text-muted-foreground">No activity recorded yet.</p>
           ) : (
             <InvestorActivityTimeline activities={activities} />
           )}
         </div>
         ```

    IMPORTANT:
    - Fetch activities in PARALLEL with investor data if possible, or sequentially after (both are fast for <100 records)
    - The activities fetch should NOT block the page if it fails — show "No activity recorded yet" on error
    - Keep existing page structure intact — only ADD the timeline section
  </action>
  <verify>
    - Detail page imports getActivities and InvestorActivityTimeline
    - Activity timeline section renders below Contacts
    - `npm run build` succeeds
    - Dev server: visiting /investors/[id] shows "Activity History" section
    - Activities display with type icons and relative timestamps
    - Type filter buttons toggle activity visibility
  </verify>
  <done>Investor detail page displays activity timeline with type filtering. Activities show icons, descriptions, timestamps, and field change details.</done>
</task>

</tasks>

<verification>
1. Navigate to /investors/[id] — detail page shows "Activity History" section below Contacts
2. Activities are listed in reverse chronological order (newest first)
3. Each activity shows: type icon (colored), description text, relative timestamp
4. Field update activities show "field: old value → new value" in monospace
5. Filter buttons toggle specific activity types on/off
6. "Clear" button resets filter to show all activities
7. Empty state shows "No activity recorded yet" when no activities exist
8. Timeline vertical line connects activity dots visually
9. No TypeScript compilation errors
</verification>

<success_criteria>
- Activity timeline renders on investor detail page
- Activities show type-specific colored icons (call=green, email=blue, meeting=purple, etc.)
- Field update activities display metadata showing what changed
- Filter buttons toggle activity type visibility
- Relative timestamps show human-readable time (Just now, 5m ago, Yesterday, etc.)
- Empty state handled gracefully
- Build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-pipeline-views-and-search/04-03-SUMMARY.md`
</output>
