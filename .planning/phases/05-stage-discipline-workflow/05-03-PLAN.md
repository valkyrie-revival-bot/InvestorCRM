---
phase: 05-stage-discipline-workflow
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - components/investors/investor-kanban-board.tsx
  - components/investors/kanban-card.tsx
  - app/(dashboard)/investors/page.tsx
  - components/investors/pipeline-view-switcher.tsx
autonomous: false

must_haves:
  truths:
    - "Dragging investor card between stages triggers validation dialog if exit criteria exist"
    - "Invalid transitions show error toast and revert the drag"
    - "Terminal stages (Won/Lost/Passed/Delayed) have no exit criteria so drag proceeds directly"
    - "Override flow works end-to-end from kanban drag"
    - "Stalled investors are visually flagged in both kanban and table views"
    - "Stage entry date displays correctly on investor detail page"
  artifacts:
    - path: "components/investors/investor-kanban-board.tsx"
      provides: "Enhanced kanban board with stage validation on drag-and-drop"
      exports: ["InvestorKanbanBoard"]
    - path: "components/investors/kanban-card.tsx"
      provides: "Kanban card with stalled indicator and days-in-stage"
      exports: ["KanbanCard"]
  key_links:
    - from: "components/investors/investor-kanban-board.tsx"
      to: "lib/stage-definitions.ts"
      via: "imports isValidTransition, getExitCriteria"
      pattern: "import.*from.*lib/stage-definitions"
    - from: "components/investors/investor-kanban-board.tsx"
      to: "components/investors/stage-validation-dialog.tsx"
      via: "renders StageValidationDialog conditionally"
      pattern: "StageValidationDialog"
    - from: "components/investors/investor-kanban-board.tsx"
      to: "app/actions/stage-transitions.ts"
      via: "calls updateInvestorStage for transitions without criteria"
      pattern: "updateInvestorStage"
---

<objective>
Wire stage validation into the kanban board drag-and-drop flow and add stalled investor detection with visual indicators.

Purpose: This plan completes Phase 5 by integrating the validation dialogs (Plan 02) into the existing kanban board (Phase 4), implementing the stalled detection visual cues, and adding a verification checkpoint. This delivers PIPE-05, STAGE-06, and the full end-to-end workflow.

Output: Enhanced kanban board with validation, stalled indicators, visual verification of complete stage discipline workflow.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stage-discipline-workflow/05-RESEARCH.md
@.planning/phases/05-stage-discipline-workflow/05-01-SUMMARY.md
@.planning/phases/05-stage-discipline-workflow/05-02-SUMMARY.md
@components/investors/investor-kanban-board.tsx
@components/investors/kanban-card.tsx
@components/investors/pipeline-view-switcher.tsx
@app/(dashboard)/investors/page.tsx
@lib/stage-definitions.ts
@app/actions/stage-transitions.ts
@components/investors/stage-validation-dialog.tsx
@components/investors/stage-override-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance kanban board with stage validation on drag-and-drop</name>
  <files>components/investors/investor-kanban-board.tsx</files>
  <action>
Modify the existing `InvestorKanbanBoard` component (`components/investors/investor-kanban-board.tsx`) to integrate stage validation:

**State additions:**
- `pendingTransition`: `{ investorId: string, investorName: string, fromStage: string, toStage: string, exitCriteria: ExitCriterion[] } | null` — tracks a drag that needs validation
- `showValidationDialog`: boolean — controls the validation dialog visibility
- `showOverrideDialog`: boolean — controls the override dialog visibility

**Modified `handleDragEnd` logic:**
Replace the current direct `updateInvestorField(draggableId, 'stage', newStage)` call with:

1. Check if `source.droppableId === destination.droppableId` — if same column, just reorder (no validation needed, no server call)
2. Get fromStage and toStage
3. Call `isValidTransition(fromStage, toStage)` — if false, show `toast.error('Cannot move from {fromStage} to {toStage}')` and return (do NOT apply optimistic update)
4. Get exit criteria: `getExitCriteria(fromStage)`
5. If exit criteria exist (non-empty array) AND moving FORWARD (not to a terminal stage from a terminal stage):
   - Apply the optimistic visual update (move card between columns)
   - Set `pendingTransition` with the transition details and open validation dialog
   - Do NOT call server action yet — dialog handles it
6. If no exit criteria (terminal stages, or stages with empty criteria):
   - Apply optimistic update
   - Call `updateInvestorStage(investorId, toStage)` directly
   - On success: toast.success, router.refresh()
   - On error: revert columns, toast.error

**Dialog rendering (at bottom of component JSX):**
- Render `<StageValidationDialog>` when `showValidationDialog` is true, passing `pendingTransition` data
- The dialog's `onOverride` prop should: close validation dialog, open override dialog
- Render `<StageOverrideDialog>` when `showOverrideDialog` is true, passing same transition data
- Both dialogs' `onSuccess` prop should: close dialog, clear pendingTransition, router.refresh()
- Both dialogs' `onOpenChange(false)` / cancel should: revert the optimistic column update (restore previousColumns), clear pendingTransition

**Keep the STAGES array in sync** — Import `STAGE_ORDER` from `@/lib/stage-definitions` and use it instead of the hardcoded STAGES array. This ensures kanban columns match the stage definitions.

**Import additions:**
- `import { STAGE_ORDER, isValidTransition, getExitCriteria } from '@/lib/stage-definitions'`
- `import { updateInvestorStage } from '@/app/actions/stage-transitions'`
- `import { StageValidationDialog } from './stage-validation-dialog'`
- `import { StageOverrideDialog } from './stage-override-dialog'`
- `import type { ExitCriterion } from '@/lib/stage-definitions'`

**Remove** the import of `updateInvestorField` from `@/app/actions/investors` — stage changes now go through `updateInvestorStage`.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Visually verify that the kanban board still renders correctly and the dialog components are included in the JSX.
  </verify>
  <done>
Kanban board validates stage transitions on drag, shows validation dialog for stages with exit criteria, allows override, and auto-logs all transitions. Invalid transitions are blocked with error toast.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add stalled detection and visual indicators</name>
  <files>components/investors/kanban-card.tsx, components/investors/pipeline-view-switcher.tsx, app/(dashboard)/investors/page.tsx</files>
  <action>
**Part A: Enhance KanbanCard with days-in-stage and stalled indicator**

Modify `components/investors/kanban-card.tsx`:
1. Import `computeIsStalled` from `@/lib/stage-definitions`
2. Compute stalled status dynamically: `const isStalled = computeIsStalled(investor.last_action_date, investor.stage)`
3. Replace the existing hardcoded `investor.stalled` badge with the computed `isStalled` value
4. Add a "days in stage" indicator below the firm name if `investor.stage_entry_date` exists:
   - Calculate days: `Math.floor((Date.now() - new Date(investor.stage_entry_date).getTime()) / (1000 * 60 * 60 * 24))`
   - Display as small muted text: "{N}d in stage" (e.g., "15d in stage")
   - If stalled, display in orange/warning color instead of muted
5. Update the `areEqual` memo comparison to include `investor.stage_entry_date` and `investor.last_action_date`

**Part B: Compute stalled status on investor list load**

Modify `app/(dashboard)/investors/page.tsx`:
1. Import `computeIsStalled` from `@/lib/stage-definitions`
2. After fetching investors, compute and overlay the stalled status:
   ```typescript
   const investorsWithStalled = investors.map(inv => ({
     ...inv,
     stalled: computeIsStalled(inv.last_action_date, inv.stage),
   }));
   ```
3. Pass `investorsWithStalled` to the PipelineViewSwitcher instead of raw investors
4. This ensures the "Stalled" filter in PipelineViewSwitcher works correctly with computed stalled status

**Part C: Update pipeline view switcher stalled filter (if needed)**

Check `components/investors/pipeline-view-switcher.tsx` — if the stalled filter already works by checking `investor.stalled`, then Part B is sufficient. No changes needed to the filter logic itself since we're overriding the stalled property on the data.

**Do NOT modify the database `stalled` column** — stalled status is now COMPUTED from `last_action_date` and stage, not persisted. The database column exists for backward compatibility but the computed value takes precedence in the UI.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. The kanban cards should show "Xd in stage" text and compute stalled status dynamically.
  </verify>
  <done>
Stalled status is computed from last_action_date (30+ days inactive, non-terminal stage). Kanban cards display days-in-stage. Stalled filter works with computed status. All visual indicators are dark-theme compatible.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete stage discipline workflow:
1. Stage definitions with exit criteria and allowed transitions
2. Validation dialog shown on kanban drag when exit criteria exist
3. Override dialog with mandatory reason for bypassing criteria
4. Automatic stage_entry_date tracking via PostgreSQL trigger
5. Computed stalled detection (30+ days inactive) with visual indicators
6. Activity logging for all stage changes (normal and override)
  </what-built>
  <how-to-verify>
**IMPORTANT: Before testing, run migration 018 in Supabase SQL Editor.** The file is at `lib/database/migrations/018-stage-entry-date-trigger.sql`.

1. Open the investor pipeline at http://localhost:3000/investors
2. Switch to Board/Kanban view
3. **Test valid transition with exit criteria:**
   - Drag an investor from "Initial Contact" to "First Conversation Held"
   - A validation dialog should appear with exit checklist items
   - Check all items and click "Advance" — investor should move to new stage
   - Check the activity timeline on that investor's detail page — should show "Stage changed from Initial Contact to First Conversation Held"
4. **Test override flow:**
   - Drag another investor forward in the pipeline
   - When validation dialog appears, click "Override"
   - Enter a reason (10+ characters) and check the confirmation checkbox
   - Click "Override and Advance" — investor moves with a warning toast
   - Check activity timeline — should show "OVERRIDE" in the description
5. **Test invalid transition:**
   - Try dragging an investor from "Not Yet Approached" directly to "NDA / Data Room"
   - Should show error toast and card should snap back
6. **Test terminal stage (no criteria):**
   - Drag an investor to "Lost" or "Passed" — should move directly without dialog
7. **Test stalled indicators:**
   - Check kanban cards for "Xd in stage" text
   - Investors with no activity for 30+ days should show orange "Stalled" badge
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. Kanban drag-and-drop triggers validation dialog for stages with exit criteria
3. Invalid transitions are blocked with error feedback
4. Override requires 10+ character reason and confirmation
5. Stage changes appear in activity timeline
6. Stalled status computed dynamically (30+ days inactive)
7. Days-in-stage displayed on kanban cards
8. All visual elements are dark-theme compatible
</verification>

<success_criteria>
- PIPE-05: Drag-and-drop between stages works with validation
- STAGE-01: Stage definitions enforced from Initial Contact through Won/Lost/Delayed
- STAGE-02: Exit checklist required before advancing
- STAGE-03: Premature advancement blocked
- STAGE-04: Override available with explicit confirmation and reason
- STAGE-05: Stage entry date auto-updated by trigger
- STAGE-06: Stalled flagging for 30+ days inactive (computed, not persisted)
</success_criteria>

<output>
After completion, create `.planning/phases/05-stage-discipline-workflow/05-03-SUMMARY.md`
</output>
