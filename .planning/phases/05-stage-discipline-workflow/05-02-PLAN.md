---
phase: 05-stage-discipline-workflow
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/actions/stage-transitions.ts
  - components/investors/stage-validation-dialog.tsx
  - components/investors/stage-override-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Server action validates stage transitions against allowed transitions and exit criteria"
    - "Validation dialog shows exit checklist when criteria not met during stage change"
    - "Override dialog requires explicit reason (min 10 chars) and confirmation before bypassing"
    - "All stage transitions are logged as activities with type stage_change or stage_override"
    - "Stage entry date is automatically updated by database trigger (server action just updates stage)"
  artifacts:
    - path: "app/actions/stage-transitions.ts"
      provides: "Server action for validated stage transitions"
      exports: ["updateInvestorStage"]
    - path: "components/investors/stage-validation-dialog.tsx"
      provides: "Modal dialog with exit checklist for stage advancement"
      exports: ["StageValidationDialog"]
    - path: "components/investors/stage-override-dialog.tsx"
      provides: "Modal dialog for overriding stage validation with reason"
      exports: ["StageOverrideDialog"]
  key_links:
    - from: "app/actions/stage-transitions.ts"
      to: "lib/stage-definitions.ts"
      via: "imports stage validation helpers"
      pattern: "import.*from.*lib/stage-definitions"
    - from: "components/investors/stage-validation-dialog.tsx"
      to: "app/actions/stage-transitions.ts"
      via: "calls updateInvestorStage on checklist completion"
      pattern: "updateInvestorStage"
    - from: "components/investors/stage-override-dialog.tsx"
      to: "app/actions/stage-transitions.ts"
      via: "calls updateInvestorStage with overrideReason"
      pattern: "updateInvestorStage.*overrideReason"
---

<objective>
Build the stage transition validation layer: a server action that enforces stage discipline, and two dialog components for exit checklist and override workflows.

Purpose: This plan implements the core validation logic (STAGE-02, STAGE-03, STAGE-04) and the server-side stage transition action that auto-logs activities (STAGE-05 via trigger). The kanban board integration happens in Plan 03.

Output: Server action for validated stage transitions, exit checklist dialog, override dialog.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stage-discipline-workflow/05-RESEARCH.md
@.planning/phases/05-stage-discipline-workflow/05-01-SUMMARY.md
@lib/stage-definitions.ts
@types/investors.ts
@app/actions/investors.ts
@lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stage transition server action</name>
  <files>app/actions/stage-transitions.ts</files>
  <action>
Create `app/actions/stage-transitions.ts` with 'use server' directive. This action handles ALL stage changes (both from kanban drag-and-drop and any future stage change UI).

**Function: `updateInvestorStage`**

Signature:
```typescript
export async function updateInvestorStage(
  investorId: string,
  newStage: string,
  options?: {
    checklistConfirmed?: boolean;  // User confirmed exit checklist items
    overrideReason?: string;       // User provided override reason
  }
): Promise<
  | { success: true; data: Investor }
  | { success: false; error: string; validationRequired?: true; exitCriteria?: ExitCriterion[]; fromStage?: string; toStage?: string }
>
```

Logic flow:
1. Auth check (get user via createClient)
2. Fetch current investor record
3. Get current stage (fromStage) from investor
4. If fromStage === newStage, return success (no-op)
5. **Transition validation**: Call `isValidTransition(fromStage, newStage)` from stage-definitions. If invalid, return `{ success: false, error: 'Invalid stage transition from X to Y' }`
6. **Exit criteria check**: Call `getExitCriteria(fromStage)`. If criteria exist AND `options?.checklistConfirmed` is NOT true AND `options?.overrideReason` is NOT provided:
   - Return `{ success: false, error: 'Exit criteria not met', validationRequired: true, exitCriteria, fromStage, toStage: newStage }`
   - This signals the UI to show the validation dialog
7. **Perform update**: Update investor stage via supabase `.update({ stage: newStage })`. The DB trigger handles stage_entry_date automatically. Also update `last_action_date` to today.
8. **Log activity**: Insert into activities table:
   - If override: `activity_type: 'stage_change'`, description: `Stage changed from {fromStage} to {newStage} (OVERRIDE)`, metadata: `{ override_reason, from_stage, to_stage, overridden_by: user.id }`
   - If normal: `activity_type: 'stage_change'`, description: `Stage changed from {fromStage} to {newStage}`, metadata: `{ from_stage, to_stage, checklist_confirmed: true }`
   - If no criteria needed (terminal -> active, or stage has no exit criteria): same as normal but metadata `{ from_stage, to_stage }`
9. `revalidatePath('/investors')` and `revalidatePath('/investors/' + investorId)`
10. Return `{ success: true, data: updatedInvestor }`

Import from:
- `@/lib/supabase/server` for createClient
- `@/lib/stage-definitions` for isValidTransition, getExitCriteria, isTerminalStage
- `@/types/investors` for Investor type
- `next/cache` for revalidatePath
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify the file exports `updateInvestorStage` function.
  </verify>
  <done>
Server action exists that validates stage transitions, checks exit criteria, supports override with reason, logs all changes as activities, and lets the DB trigger handle stage_entry_date updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create stage validation dialog with exit checklist</name>
  <files>components/investors/stage-validation-dialog.tsx</files>
  <action>
Create `components/investors/stage-validation-dialog.tsx` as a 'use client' component.

**Props interface:**
```typescript
interface StageValidationDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  investorId: string;
  investorName: string;
  fromStage: string;
  toStage: string;
  exitCriteria: ExitCriterion[];
  onSuccess: () => void;  // Called after successful transition
}
```

**Behavior:**
1. Uses shadcn/ui `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogDescription`, `DialogFooter`
2. Displays the exit criteria as a CHECKLIST (checkboxes). User must check all required items.
3. Header: "Complete Exit Checklist" with description "Confirm the following before advancing from {fromStage} to {toStage}:"
4. Each criterion rendered as a `Checkbox` + `Label` pair using shadcn/ui components
5. Track checked state with `useState` — a `Set<string>` of checked criterion IDs
6. "Advance" button: Disabled until ALL criteria are checked. On click:
   - Call `updateInvestorStage(investorId, toStage, { checklistConfirmed: true })`
   - Show toast.success on success, toast.error on failure
   - Call `onSuccess()` and close dialog
7. "Override" button (secondary/ghost variant): Always visible. Opens the StageOverrideDialog instead.
   - When user clicks Override, close this dialog and signal parent to open override dialog
   - Add an `onOverride: () => void` prop for this
8. "Cancel" button: Closes dialog without action
9. Use `useTransition` for the advance action to show loading state on the button

**Styling:** Dark theme compatible. Use existing shadcn/ui patterns. Checklist items should have clear visual feedback when checked (opacity, strikethrough or checkmark).

Import `ExitCriterion` type from `@/lib/stage-definitions`. Import `updateInvestorStage` from `@/app/actions/stage-transitions`.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Component renders a dialog with checkboxes for exit criteria.
  </verify>
  <done>
Stage validation dialog shows exit checklist, tracks completion, enables advance only when all items checked, provides override escape hatch, and calls server action on confirmation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create stage override dialog with mandatory reason</name>
  <files>components/investors/stage-override-dialog.tsx</files>
  <action>
Create `components/investors/stage-override-dialog.tsx` as a 'use client' component.

**Props interface:**
```typescript
interface StageOverrideDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  investorId: string;
  investorName: string;
  fromStage: string;
  toStage: string;
  onSuccess: () => void;
}
```

**Behavior:**
1. Uses shadcn/ui `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogDescription`, `DialogFooter`
2. Header: "Override Stage Validation" with description "Exit criteria for {fromStage} have not been met. You may override, but a reason is required."
3. A `Textarea` for the override reason (controlled via useState)
4. A `Checkbox` + label: "I confirm this override is necessary and accept responsibility"
5. Validation: Reason must be at least 10 characters. Checkbox must be checked.
6. "Override and Advance" button (variant="destructive"): Disabled until reason >= 10 chars AND checkbox checked. On click:
   - Call `updateInvestorStage(investorId, toStage, { overrideReason: reason })`
   - Show `toast.warning('Stage advanced with override')` on success, `toast.error` on failure
   - Call `onSuccess()` and close dialog
7. "Cancel" button: Closes dialog
8. Use `useTransition` for the override action to show loading state

**Styling:** Warning/destructive tone. The override button should use destructive variant. Dark theme compatible.

Import `updateInvestorStage` from `@/app/actions/stage-transitions`.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Component renders override dialog with textarea, checkbox, and destructive submit button.
  </verify>
  <done>
Override dialog requires minimum 10-character reason and explicit confirmation checkbox before allowing stage bypass. All overrides are logged via the server action with the reason in activity metadata.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `app/actions/stage-transitions.ts` exports `updateInvestorStage` function
3. `components/investors/stage-validation-dialog.tsx` exports `StageValidationDialog` component
4. `components/investors/stage-override-dialog.tsx` exports `StageOverrideDialog` component
5. Server action validates transitions, checks exit criteria, supports override, logs activities
6. Dialog components use shadcn/ui primitives and are dark-theme compatible
</verification>

<success_criteria>
- Stage transition server action enforces allowed transitions and exit criteria
- Validation dialog shows checklist and blocks advancement until all items confirmed
- Override dialog requires reason (10+ chars) and confirmation before bypass
- All transitions logged as activities with appropriate type and metadata
- Components are ready for kanban integration in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/05-stage-discipline-workflow/05-02-SUMMARY.md`
</output>
