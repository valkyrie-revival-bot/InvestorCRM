---
phase: 05-stage-discipline-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stage-definitions.ts
  - lib/database/migrations/018-stage-entry-date-trigger.sql
  - types/investors.ts
autonomous: true

must_haves:
  truths:
    - "Stage definitions are centralized with explicit exit criteria per stage"
    - "Database trigger automatically updates stage_entry_date when stage changes"
    - "Stalled status is computed from last_action_date (30+ days inactive, not in terminal stage)"
  artifacts:
    - path: "lib/stage-definitions.ts"
      provides: "Centralized stage metadata, exit criteria, allowed transitions, stalled threshold"
      exports: ["STAGE_DEFINITIONS", "STAGE_ORDER", "getExitCriteria", "isTerminalStage", "computeIsStalled"]
    - path: "lib/database/migrations/018-stage-entry-date-trigger.sql"
      provides: "PostgreSQL trigger for auto-updating stage_entry_date on stage change"
      contains: "CREATE TRIGGER"
    - path: "types/investors.ts"
      provides: "Updated type with stage_entry_date field"
      contains: "stage_entry_date"
  key_links:
    - from: "lib/stage-definitions.ts"
      to: "types/investors.ts"
      via: "InvestorStage type import"
      pattern: "import.*InvestorStage.*from.*types/investors"
---

<objective>
Create the foundational stage discipline configuration and database infrastructure for Phase 5.

Purpose: All stage validation, kanban enhancement, and stalled detection depend on a centralized stage definitions module and a database trigger for automatic timestamp tracking. This plan establishes both.

Output: Stage definitions config file, database migration for stage_entry_date trigger, updated TypeScript types.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stage-discipline-workflow/05-RESEARCH.md
@types/investors.ts
@lib/validations/investor-schema.ts
@lib/database/migrations/007_create_investors.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create centralized stage definitions module</name>
  <files>lib/stage-definitions.ts</files>
  <action>
Create `lib/stage-definitions.ts` with:

1. **STAGE_DEFINITIONS** — A const object keyed by stage name (matching existing 12 stages in `INVESTOR_STAGES` from `lib/validations/investor-schema.ts`). Each stage entry contains:
   - `label`: Display name (same as key)
   - `order`: Numeric order (1-5, terminal stages share order 5)
   - `exitCriteria`: Array of `{ id: string, label: string, description: string }` objects. These are CHECKLIST ITEMS the user must confirm (not database fields). For example:
     - "Initial Contact" exit: "First outreach completed", "Contact information confirmed"
     - "First Conversation Held" exit: "Initial call or meeting completed", "Key contact identified"
     - "Materials Shared" exit: "Pitch deck or fund materials sent", "LP confirmed receipt"
     - "NDA / Data Room" exit: "NDA fully executed", "Data room access granted"
     - "Active Due Diligence" exit: "DD process formally initiated", "At least 2 DD meetings held"
     - "LPA / Legal" exit: "LPA reviewed by LP counsel", "Key terms agreed"
     - Terminal stages (Won, Committed, Lost, Passed, Delayed) have no exit criteria (they are endpoints)
   - `allowedTransitions`: Array of stage names this stage can transition TO. Generally forward progression plus terminal stages from any active stage. Allow some flexibility:
     - "Not Yet Approached" -> "Initial Contact"
     - "Initial Contact" -> "First Conversation Held", "Lost", "Passed"
     - "First Conversation Held" -> "Materials Shared", "Lost", "Passed"
     - "Materials Shared" -> "NDA / Data Room", "Lost", "Passed", "Delayed"
     - "NDA / Data Room" -> "Active Due Diligence", "Lost", "Passed", "Delayed"
     - "Active Due Diligence" -> "LPA / Legal", "Lost", "Passed", "Delayed"
     - "LPA / Legal" -> "Won", "Committed", "Lost", "Passed", "Delayed"
     - Terminal stages (Won, Committed, Lost, Passed, Delayed) -> allow moving back to any active stage (re-engagement)

2. **STAGE_ORDER** — Ordered array of stage names for display consistency.

3. **Helper functions:**
   - `getExitCriteria(stage: string)` — Returns exit criteria array for a stage (empty array if terminal)
   - `getAllowedTransitions(fromStage: string)` — Returns allowed target stages
   - `isTerminalStage(stage: string)` — Returns true for Won/Committed/Lost/Passed/Delayed
   - `isValidTransition(from: string, to: string)` — Checks if transition is allowed
   - `computeIsStalled(lastActionDate: string | null, stage: string, thresholdDays?: number)` — Returns boolean. Default threshold 30 days. Returns false for terminal stages. Computes from current date minus lastActionDate.

4. **Type exports:**
   - `StageDefinition` interface
   - `ExitCriterion` interface
   - Re-export `InvestorStage` from types

Import `InvestorStage` from `@/types/investors` for type safety. Use `as const satisfies Record<string, StageDefinition>` for the definitions object.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify file exports STAGE_DEFINITIONS, STAGE_ORDER, and all helper functions by checking the file exists and has correct structure.
  </verify>
  <done>
Stage definitions module exists at `lib/stage-definitions.ts` with all 12 stages, exit criteria as checklist items, allowed transitions, terminal stage detection, stalled computation, and proper TypeScript types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database migration and update TypeScript types</name>
  <files>lib/database/migrations/018-stage-entry-date-trigger.sql, types/investors.ts</files>
  <action>
**Part A: Database migration** — Create `lib/database/migrations/018-stage-entry-date-trigger.sql`:

```sql
-- Migration 018: Add stage_entry_date column and auto-update trigger
-- Run in Supabase SQL Editor

-- Add stage_entry_date column (defaults to entry_date for existing records)
ALTER TABLE public.investors
ADD COLUMN IF NOT EXISTS stage_entry_date date DEFAULT CURRENT_DATE;

-- Backfill existing records: set stage_entry_date to entry_date if available
UPDATE public.investors
SET stage_entry_date = COALESCE(entry_date, created_at::date)
WHERE stage_entry_date IS NULL OR stage_entry_date = CURRENT_DATE;

-- Create trigger function to auto-update stage_entry_date on stage change
CREATE OR REPLACE FUNCTION public.update_stage_entry_date()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.stage IS DISTINCT FROM OLD.stage THEN
    NEW.stage_entry_date = CURRENT_DATE;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Attach trigger (drop first if exists to make idempotent)
DROP TRIGGER IF EXISTS investors_stage_entry_date ON public.investors;
CREATE TRIGGER investors_stage_entry_date
  BEFORE UPDATE ON public.investors
  FOR EACH ROW
  EXECUTE FUNCTION public.update_stage_entry_date();
```

**Part B: Update TypeScript types** — In `types/investors.ts`:

1. Add `stage_entry_date: string | null;` to the `Investor` interface, placed after the `entry_date` field. Add a comment: `// ISO date string — auto-updated by DB trigger on stage change`

This is the ONLY change to types. Do not modify any other types or interfaces.
  </action>
  <verify>
Run `npx tsc --noEmit` — type checking passes with the new field. Verify the migration SQL file exists and contains the trigger function.
  </verify>
  <done>
Migration file exists with stage_entry_date column, backfill query, and BEFORE UPDATE trigger. TypeScript `Investor` interface includes `stage_entry_date` field. Migration is ready for manual execution in Supabase SQL Editor (follows established project pattern).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `lib/stage-definitions.ts` exports STAGE_DEFINITIONS with all 12 stages
3. `lib/stage-definitions.ts` exports helper functions: getExitCriteria, getAllowedTransitions, isTerminalStage, isValidTransition, computeIsStalled
4. `lib/database/migrations/018-stage-entry-date-trigger.sql` exists with valid SQL
5. `types/investors.ts` contains `stage_entry_date` field in Investor interface
</verification>

<success_criteria>
- Stage definitions are centralized in a single module used by all Phase 5 plans
- Database migration is ready for manual execution (follows project pattern)
- TypeScript types are updated to include stage_entry_date
- No type errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/05-stage-discipline-workflow/05-01-SUMMARY.md`
</output>
