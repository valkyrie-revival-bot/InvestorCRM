---
phase: 06-activity-strategy-management
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - lib/database/migrations/019-strategy-history.sql
  - app/actions/investors.ts
  - components/investors/strategy-history-viewer.tsx
  - components/investors/investor-form-sections.tsx
  - app/(dashboard)/investors/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "When user updates current_strategy_notes, the previous strategy is automatically archived with its date"
    - "User can view strategy history showing all previous strategy versions with dates"
    - "User can enter and edit key objections/risks in a dedicated field"
    - "Strategy section on investor detail page shows current strategy with expandable history"
    - "User can initiate a focused strategy review that clearly separates strategic thinking from operational updates"
  artifacts:
    - path: "lib/database/migrations/019-strategy-history.sql"
      provides: "Strategy history table and auto-archive trigger"
      contains: "strategy_history"
    - path: "components/investors/strategy-history-viewer.tsx"
      provides: "Collapsible strategy history display"
      min_lines: 50
    - path: "components/investors/investor-form-sections.tsx"
      provides: "Enhanced strategy section with history viewer and review mode"
      contains: "StrategyHistoryViewer"
  key_links:
    - from: "components/investors/investor-form-sections.tsx"
      to: "components/investors/strategy-history-viewer.tsx"
      via: "StrategyHistoryViewer component import and render"
      pattern: "StrategyHistoryViewer"
    - from: "components/investors/investor-form-sections.tsx"
      to: "app/actions/investors.ts"
      via: "getStrategyHistory server action for full history"
      pattern: "getStrategyHistory"
    - from: "lib/database/migrations/019-strategy-history.sql"
      to: "public.investors"
      via: "AFTER UPDATE trigger on investors table"
      pattern: "strategy_history_trigger"
---

<objective>
Build the strategy management system with automatic archiving, full version history, and a dedicated strategy review experience that separates strategic thinking from operational updates.

Purpose: Satisfies STRAT-01 (strategy notes), STRAT-02 (auto-archive to last strategy), STRAT-03 (strategy history), STRAT-04 (strategy review mode), STRAT-05 (key objections/risks). This enables institutional learning — the team can see how strategy evolved over time.
Output: Database migration for strategy history, getStrategyHistory server action, StrategyHistoryViewer component, enhanced strategy section with review mode.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-activity-a-strategy-management/06-RESEARCH.md
@.planning/phases/06-activity-a-strategy-management/06-01-SUMMARY.md

Key existing files to reference:
@app/actions/investors.ts — Server action patterns, will extend with getStrategyHistory
@components/investors/investor-form-sections.tsx — Strategy section (Section 3) with InlineEditField components
@components/investors/inline-edit-field.tsx — Auto-save on blur pattern
@lib/database/migrations/007_create_investors.sql — Investors table schema (has current/last strategy fields)
@types/investors.ts — Investor type (has strategy fields already defined)
@app/(dashboard)/investors/[id]/page.tsx — Detail page layout
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for strategy history and server action</name>
  <files>
    lib/database/migrations/019-strategy-history.sql
    app/actions/investors.ts
  </files>
  <action>
  **1. Create `lib/database/migrations/019-strategy-history.sql`:**

  This migration does TWO things:
  - Creates a `strategy_history` table for full version history (STRAT-03)
  - Creates a BEFORE UPDATE trigger on `investors` table that auto-archives strategy (STRAT-02) and logs to history

  ```sql
  -- Migration 019: Strategy History System
  -- Creates strategy_history table and auto-archive trigger
  -- Run in Supabase SQL Editor

  -- 1. Create strategy_history table for full version tracking
  CREATE TABLE IF NOT EXISTS public.strategy_history (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    investor_id uuid NOT NULL REFERENCES public.investors(id) ON DELETE RESTRICT,
    strategy_notes text NOT NULL,
    strategy_date date,
    created_at timestamptz DEFAULT now(),
    created_by uuid REFERENCES auth.users(id)
  );

  -- Index for efficient history queries (most recent first per investor)
  CREATE INDEX IF NOT EXISTS idx_strategy_history_investor_date
    ON public.strategy_history(investor_id, created_at DESC);

  -- RLS policies for strategy_history (same as investors - authenticated users)
  ALTER TABLE public.strategy_history ENABLE ROW LEVEL SECURITY;

  CREATE POLICY "Authenticated users can view strategy history"
    ON public.strategy_history
    FOR SELECT
    TO authenticated
    USING (true);

  CREATE POLICY "Authenticated users can insert strategy history"
    ON public.strategy_history
    FOR INSERT
    TO authenticated
    WITH CHECK (true);

  -- 2. Create trigger function for automatic strategy archiving
  CREATE OR REPLACE FUNCTION public.archive_strategy_on_update()
  RETURNS TRIGGER
  LANGUAGE plpgsql
  SECURITY DEFINER
  AS $$
  BEGIN
    -- Only archive if current_strategy_notes actually changed and had content
    IF OLD.current_strategy_notes IS DISTINCT FROM NEW.current_strategy_notes
       AND OLD.current_strategy_notes IS NOT NULL
       AND OLD.current_strategy_notes != '' THEN

      -- Move old current strategy -> last strategy fields (two-field pattern)
      NEW.last_strategy_notes := OLD.current_strategy_notes;
      NEW.last_strategy_date := OLD.current_strategy_date;

      -- Set current strategy date to today
      NEW.current_strategy_date := CURRENT_DATE;

      -- Also insert into full history table for complete audit trail
      INSERT INTO public.strategy_history (
        investor_id,
        strategy_notes,
        strategy_date,
        created_by
      ) VALUES (
        OLD.id,
        OLD.current_strategy_notes,
        OLD.current_strategy_date,
        NEW.created_by  -- May be NULL if updated by trigger/system
      );
    END IF;

    RETURN NEW;
  END;
  $$;

  -- 3. Attach trigger to investors table (BEFORE UPDATE so we can modify NEW)
  -- Drop first in case it already exists from a previous attempt
  DROP TRIGGER IF EXISTS strategy_archive_trigger ON public.investors;

  CREATE TRIGGER strategy_archive_trigger
    BEFORE UPDATE ON public.investors
    FOR EACH ROW
    EXECUTE FUNCTION public.archive_strategy_on_update();
  ```

  IMPORTANT: This trigger uses BEFORE UPDATE to modify the NEW record (setting last_strategy fields) and also inserts into strategy_history. The `IS DISTINCT FROM` operator handles NULL comparisons correctly. Uses SECURITY DEFINER to ensure the INSERT into strategy_history works even through RLS.

  **2. Add `getStrategyHistory` server action to `app/actions/investors.ts`:**

  Add this new export function after the `createActivity` function (added in 06-01):

  ```typescript
  export async function getStrategyHistory(investorId: string): Promise<
    { data: StrategyHistoryEntry[]; error?: never } | { data?: never; error: string }
  > {
    // Auth check
    // Query strategy_history table WHERE investor_id = investorId ORDER BY created_at DESC
    // Return array of { id, strategy_notes, strategy_date, created_at }
  }
  ```

  Also add the `StrategyHistoryEntry` type definition at the top of the file (or import from types):

  ```typescript
  interface StrategyHistoryEntry {
    id: string;
    investor_id: string;
    strategy_notes: string;
    strategy_date: string | null;
    created_at: string;
    created_by: string | null;
  }
  ```

  Follow the exact same pattern as `getActivities`: auth check, supabase query, error handling, return `{ data }` or `{ error }`.

  IMPORTANT: Do NOT modify any existing functions. Only ADD the new function and type.
  </action>
  <verify>
  Run `npx tsc --noEmit` — no type errors.
  Verify the SQL file is valid by reviewing syntax (CREATE TABLE, CREATE FUNCTION, CREATE TRIGGER).
  Verify getStrategyHistory server action compiles and follows existing patterns.
  </verify>
  <done>
  - `strategy_history` table migration ready to execute in Supabase SQL Editor
  - BEFORE UPDATE trigger on investors table auto-archives strategy notes when changed
  - Trigger writes to both last_strategy fields AND strategy_history table
  - `getStrategyHistory` server action fetches full version history for an investor
  - IS DISTINCT FROM handles NULL comparisons, empty string check prevents archiving blank notes
  </done>
</task>

<task type="auto">
  <name>Task 2: Strategy history viewer and enhanced strategy section</name>
  <files>
    components/investors/strategy-history-viewer.tsx
    components/investors/investor-form-sections.tsx
    app/(dashboard)/investors/[id]/page.tsx
  </files>
  <action>
  **1. Create `components/investors/strategy-history-viewer.tsx`:**

  Build a component that displays strategy version history:

  ```
  'use client';
  ```

  Props: `{ investorId: string; lastStrategy: string | null; lastStrategyDate: string | null }`

  The component has two modes:
  - **Collapsed (default):** Shows a clickable "View strategy history" link with History icon if lastStrategy exists. If no history, renders nothing.
  - **Expanded:** Shows the last strategy in a muted card, plus a "Load full history" button that fetches from server.

  Implementation:
  - Use `Collapsible` from `@/components/ui/collapsible` for expand/collapse
  - On expand, immediately show `lastStrategy` (already in props, no fetch needed)
  - Show "Load full history" button at bottom
  - When "Load full history" is clicked, call `getStrategyHistory(investorId)` and display all entries in reverse chronological order
  - Each history entry shows: strategy_date formatted as "Mon DD, YYYY", strategy_notes in a bordered card with muted background
  - Use `History` icon from lucide-react for the trigger
  - Loading state while fetching: show "Loading..." text
  - Style entries with `bg-muted/30 border rounded-lg p-4` consistent with dark theme
  - Each entry card shows the date as a small label above the strategy text

  **2. Modify `components/investors/investor-form-sections.tsx`:**

  Enhance the Strategy section (Section 3) to:

  a. **Import** `StrategyHistoryViewer` and `Dialog/DialogContent/DialogHeader/DialogTitle/DialogTrigger` from shadcn/ui, `Button` from shadcn/ui, `BookOpen` icon from lucide-react.

  b. **Add a "Review Strategy" button** next to the Strategy section title. This satisfies STRAT-04 (strategy review mode).
     - In the CollapsibleTrigger row for Strategy section, add a button (outside the CollapsibleTrigger, in a wrapper div):
       ```
       <div className="flex w-full items-center justify-between px-6 py-4">
         <CollapsibleTrigger className="flex items-center gap-2 hover:bg-accent/50 transition-colors">
           <h2>Strategy</h2>
           <ChevronDown />
         </CollapsibleTrigger>
         <Dialog>
           <DialogTrigger asChild>
             <Button variant="outline" size="sm" onClick={(e) => e.stopPropagation()}>
               <BookOpen className="h-4 w-4 mr-2" />
               Review Strategy
             </Button>
           </DialogTrigger>
           <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
             ... strategy review dialog content ...
           </DialogContent>
         </Dialog>
       </div>
       ```

  c. **Strategy Review Dialog content** (STRAT-04):
     - DialogHeader with DialogTitle "Strategy Review — {investor.firm_name}"
     - Current Strategy section: Display current_strategy_notes in a prominent card with current_strategy_date
     - Key Objection/Risk section: Display key_objection_risk in a separate card
     - Last Strategy section: Display last_strategy_notes with last_strategy_date in muted card (if exists)
     - All text in read-only display (not editable in review mode — editing happens in the inline fields)
     - Show "Edit in place" text hint at bottom pointing user to inline fields for editing

  d. **Add StrategyHistoryViewer** below the Last Strategy inline edit fields in the Strategy CollapsibleContent. Place it after the last_strategy_date field:
     ```
     <div className="md:col-span-2">
       <StrategyHistoryViewer
         investorId={investor.id}
         lastStrategy={investor.last_strategy_notes}
         lastStrategyDate={investor.last_strategy_date}
       />
     </div>
     ```

  e. **Remove the spacer divs** (`<div></div> {/* Spacer */}`) from the strategy section — they're unnecessary and waste space.

  **3. Modify `app/(dashboard)/investors/[id]/page.tsx`:**

  No changes needed — the StrategyHistoryViewer and Review button are contained within InvestorFormSections which already receives the full investor object. However, verify that the Dialog component is already available in `components/ui/dialog.tsx` (it is — confirmed from UI components list).
  </action>
  <verify>
  Run `npx tsc --noEmit` — no type errors.
  Run `npm run build` — build succeeds.
  Visually verify by running dev server: navigate to investor detail page, confirm:
  1. Strategy section shows "Review Strategy" button in section header
  2. Clicking "Review Strategy" opens dialog with current strategy, key objections, and last strategy
  3. "View strategy history" link appears below Last Strategy fields (if last strategy exists)
  4. Clicking history link expands to show last strategy card
  5. "Load full history" button works (will need migration executed first to populate history table)
  </verify>
  <done>
  - StrategyHistoryViewer shows last strategy with expandable full history
  - Strategy section has "Review Strategy" button opening focused read-only dialog
  - Strategy review dialog shows current strategy, key objections, and last strategy in clear layout
  - Strategy history loads on demand from server action
  - Auto-archive trigger (019 migration) ready for user to execute in Supabase SQL Editor
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Execute strategy history migration in Supabase</name>
  <what-built>Strategy history database migration (019-strategy-history.sql) with strategy_history table, BEFORE UPDATE trigger on investors for auto-archiving, and RLS policies. UI components for strategy history viewing and review mode.</what-built>
  <how-to-verify>
  1. Open Supabase Dashboard SQL Editor
  2. Copy the contents of `lib/database/migrations/019-strategy-history.sql`
  3. Execute the SQL
  4. Verify success — no errors
  5. Test the trigger: Go to investor detail page, edit Current Strategy Notes field with new text, blur to save
  6. Check that Last Strategy Notes and Last Strategy Date fields automatically populated with old values
  7. Click "View strategy history" link — should show the archived entry
  8. Click "Review Strategy" button — dialog should show current and previous strategy
  </how-to-verify>
  <resume-signal>Type "migration executed" after running the SQL and verifying the trigger works, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. Navigate to investor detail page — Strategy section shows "Review Strategy" button
2. Click "Review Strategy" — dialog opens with current strategy, key objections, last strategy (all read-only)
3. Edit current_strategy_notes with new text, blur to save — auto-save triggers
4. After save, Last Strategy Notes and Last Strategy Date automatically show the old strategy values
5. "View strategy history" link appears below Last Strategy fields
6. Click "View strategy history" — expands to show previous strategy card
7. Click "Load full history" — fetches and displays all historical strategy versions
8. Key Objection/Risk field is editable in the inline form and displayed in Review Strategy dialog
9. strategy_history table contains entries for each strategy change
</verification>

<success_criteria>
- Strategy auto-archiving works: editing current_strategy_notes automatically preserves old value in last_strategy_notes/last_strategy_date
- Full strategy history persisted in strategy_history table and viewable via UI
- Strategy Review dialog provides focused read-only view of strategic position
- Key objections/risks documented in dedicated field (already existed, now highlighted in review mode)
- No data loss on strategy updates — all versions preserved
- Trigger handles NULL and empty string edge cases correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-activity-a-strategy-management/06-02-SUMMARY.md`
</output>
