---
phase: 06-activity-strategy-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/validations/activity-schema.ts
  - app/actions/investors.ts
  - components/investors/quick-add-activity-modal.tsx
  - app/(dashboard)/investors/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can open a quick-add dialog from the investor detail page to log an activity"
    - "User can select activity type (call, email, meeting, note) and enter a description"
    - "Activity appears in the existing Activity History timeline after creation"
    - "Investor last_action_date is automatically updated when a new activity is logged"
    - "User can optionally set next action and target date from within the activity modal"
  artifacts:
    - path: "lib/validations/activity-schema.ts"
      provides: "Zod validation schema for activity creation"
      contains: "activityCreateSchema"
    - path: "components/investors/quick-add-activity-modal.tsx"
      provides: "Dialog modal for logging activities with form"
      min_lines: 80
    - path: "app/actions/investors.ts"
      provides: "createActivity server action"
      contains: "createActivity"
  key_links:
    - from: "components/investors/quick-add-activity-modal.tsx"
      to: "app/actions/investors.ts"
      via: "createActivity server action call"
      pattern: "createActivity"
    - from: "app/(dashboard)/investors/[id]/page.tsx"
      to: "components/investors/quick-add-activity-modal.tsx"
      via: "QuickAddActivityModal component import and render"
      pattern: "QuickAddActivityModal"
---

<objective>
Build the activity quick-add system enabling users to rapidly log operational updates (calls, emails, meetings, notes) from the investor detail page via a dialog modal, with optional next action setting.

Purpose: Satisfies PIPE-10 (activity logging with timestamps) and PIPE-11 (next action and target date). This is the core operational workflow for day-to-day CRM usage.
Output: Zod validation schema, createActivity server action, QuickAddActivityModal component, integration into investor detail page.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-activity-a-strategy-management/06-RESEARCH.md

Key existing files to reference:
@app/actions/investors.ts — Server action patterns (createInvestor, updateInvestorField, getActivities)
@lib/validations/investor-schema.ts — Zod schema patterns
@components/investors/investor-activity-timeline.tsx — Activity types and timeline rendering
@app/(dashboard)/investors/[id]/page.tsx — Detail page layout
@types/investors.ts — Activity, ActivityType, ActivityInsert types
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activity Zod schema and createActivity server action</name>
  <files>
    lib/validations/activity-schema.ts
    app/actions/investors.ts
  </files>
  <action>
  **1. Create `lib/validations/activity-schema.ts`:**

  Define Zod validation schema for user-created activities:

  ```typescript
  import { z } from 'zod';

  // User-creatable activity types (exclude system types: stage_change, field_update)
  export const USER_ACTIVITY_TYPES = ['note', 'call', 'email', 'meeting'] as const;

  export const activityCreateSchema = z.object({
    investor_id: z.string().uuid('Invalid investor ID'),
    activity_type: z.enum(USER_ACTIVITY_TYPES, {
      errorMap: () => ({ message: 'Select an activity type' }),
    }),
    description: z.string().min(1, 'Description is required').max(2000, 'Description must be 2000 characters or less'),
    metadata: z.record(z.unknown()).optional(),
    // Optional next action fields
    set_next_action: z.boolean().optional().default(false),
    next_action: z.string().max(500).optional().nullable(),
    next_action_date: z.string().optional().nullable(),
  });

  export type ActivityCreateInput = z.infer<typeof activityCreateSchema>;
  ```

  **2. Add `createActivity` server action to `app/actions/investors.ts`:**

  Add this new export function after the existing `getActivities` function. Follow the exact same patterns as `createInvestor`:

  - Validate input with `activityCreateSchema.parse(input)`
  - Auth check with `supabase.auth.getUser()`
  - Insert activity into `activities` table with `investor_id`, `activity_type`, `description`, `metadata`, `created_by`
  - Update investor's `last_action_date` to today's date (ISO date string YYYY-MM-DD)
  - If `set_next_action` is true AND `next_action` is provided, also update the investor's `next_action` and `next_action_date` fields
  - Call `revalidatePath(\`/investors/${validated.investor_id}\`)` to refresh the detail page
  - Return `{ data: activity }` on success, `{ error: string }` on failure
  - Import `activityCreateSchema` and `ActivityCreateInput` from `@/lib/validations/activity-schema`

  IMPORTANT: Do NOT modify any existing functions. Only ADD the new createActivity function and its imports.
  </action>
  <verify>
  Run `npx tsc --noEmit` from project root — no type errors related to activity-schema.ts or createActivity.
  Verify the import of activityCreateSchema resolves correctly.
  </verify>
  <done>
  - `activityCreateSchema` exports with investor_id, activity_type (enum of 4 user types), description, metadata, set_next_action, next_action, next_action_date fields
  - `createActivity` server action validates, authenticates, inserts activity, updates last_action_date, optionally sets next_action, revalidates page, returns result
  </done>
</task>

<task type="auto">
  <name>Task 2: Build QuickAddActivityModal and integrate into detail page</name>
  <files>
    components/investors/quick-add-activity-modal.tsx
    app/(dashboard)/investors/[id]/page.tsx
  </files>
  <action>
  **1. Create `components/investors/quick-add-activity-modal.tsx`:**

  Build a controlled Dialog modal component:

  ```
  'use client';
  ```

  Props: `{ investorId: string; currentNextAction?: string | null; currentNextActionDate?: string | null }`

  Component structure:
  - Use `useState` for `open` state to control Dialog open/close
  - Use `react-hook-form` with `zodResolver(activityCreateSchema)` for form management
  - Use `useState` for `isSubmitting` loading state
  - Default values: `activity_type: 'note'`, `description: ''`, `set_next_action: false`

  Form layout inside DialogContent:
  1. **Activity Type** — row of 4 toggle buttons (not a dropdown), one for each USER_ACTIVITY_TYPES:
     - note (FileText icon), call (Phone icon), email (Mail icon), meeting (Calendar icon)
     - Use button group styling: selected button gets `bg-primary text-primary-foreground`, others `bg-muted text-muted-foreground`
     - On click, `form.setValue('activity_type', type)`
     - Use icons from lucide-react (already used in timeline)

  2. **Description** — `<textarea>` with 3 rows, placeholder "What happened?", auto-focus when modal opens

  3. **Set Next Action** — Collapsible section triggered by a checkbox labeled "Set next action"
     - When checked, show:
       - Text input for next_action, placeholder "What's the next step?"
       - Native `<input type="date">` for next_action_date
     - Pre-fill with current next action values from props if they exist

  4. **Submit button** — Full width, "Log Activity" text, shows loading spinner (use `Loader2` icon with `animate-spin` from lucide-react) when submitting, disabled during submission

  On submit:
  - Call `createActivity(data)` server action
  - On success: `toast.success('Activity logged')`, `form.reset()`, `setOpen(false)`, call `router.refresh()` to update the page
  - On error: `toast.error(result.error)`

  DialogTrigger: A Button with `variant="outline"` size="sm", shows `<Plus className="h-4 w-4 mr-2" />` and text "Log Activity"

  Styling: Follow dark theme patterns. Use `space-y-4` for form field spacing. Activity type buttons use `gap-2` flex row.

  Import `useRouter` from `next/navigation` for `router.refresh()`.

  **2. Modify `app/(dashboard)/investors/[id]/page.tsx`:**

  Add the QuickAddActivityModal to the Activity History section. Specifically:

  - Import `QuickAddActivityModal` from `@/components/investors/quick-add-activity-modal`
  - In the Activity History section header, change the layout to flex with justify-between:
    ```
    <div className="flex items-center justify-between mb-4">
      <h2 className="text-lg font-semibold">Activity History</h2>
      <QuickAddActivityModal
        investorId={investor.id}
        currentNextAction={investor.next_action}
        currentNextActionDate={investor.next_action_date}
      />
    </div>
    ```
  - Remove the existing `<h2>` that's standalone above the timeline

  This places the "Log Activity" button in the header row of the Activity History section, making it easily discoverable and contextual.
  </action>
  <verify>
  Run `npx tsc --noEmit` — no type errors.
  Run `npm run build` — build succeeds.
  Visually verify by running dev server: navigate to any investor detail page, confirm "Log Activity" button appears in Activity History section header, click it to open the dialog, verify form fields render correctly (4 activity type buttons, description textarea, next action checkbox).
  </verify>
  <done>
  - QuickAddActivityModal renders as a dialog triggered by "Log Activity" button
  - Form has 4 activity type toggle buttons with icons, description textarea, optional next action section
  - Submitting creates activity via server action, shows success toast, closes modal, refreshes page
  - Activity appears in existing timeline after page refresh
  - "Log Activity" button is positioned in the Activity History section header on investor detail page
  </done>
</task>

</tasks>

<verification>
1. Navigate to investor detail page — "Log Activity" button visible in Activity History section
2. Click "Log Activity" — dialog opens with activity type buttons, description field
3. Select "Call" type, enter description "Spoke with partner about timeline" — form validates
4. Click "Log Activity" button — activity created, toast shows success, modal closes
5. Activity History section shows new "Call" activity with description and timestamp
6. Investor's last_action_date updated to today
7. Check "Set next action" — next action fields appear
8. Enter next action "Follow up on materials" with date — submits and updates investor record
9. Next Steps section on detail page shows updated next action and date
</verification>

<success_criteria>
- User can log call, email, meeting, and note activities from investor detail page
- Activities appear in existing timeline with correct type icons after creation
- Investor last_action_date auto-updates on activity creation
- Optional next action setting works from within the modal
- All form validation works (required description, activity type selection)
- Toast notifications show on success/error
- Modal closes on successful submission and reopens clean
</success_criteria>

<output>
After completion, create `.planning/phases/06-activity-a-strategy-management/06-01-SUMMARY.md`
</output>
