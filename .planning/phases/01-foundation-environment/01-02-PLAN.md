---
phase: 01-foundation-environment
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - lib/supabase/client.ts
  - lib/supabase/server.ts
  - lib/supabase/middleware.ts
  - middleware.ts
  - .env.local
  - .env.example
  - app/(auth)/login/page.tsx
  - app/(dashboard)/layout.tsx
  - app/(dashboard)/page.tsx
  - components/providers/theme-provider.tsx
autonomous: true
user_setup:
  - service: supabase
    why: "Database and authentication backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> Project API keys -> anon/public"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> Project API keys -> service_role (secret)"
    dashboard_config:
      - task: "Create new Supabase project (if not already created)"
        location: "Supabase Dashboard -> New Project"
  - service: anthropic
    why: "AI BDR agent powered by Claude"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key"

must_haves:
  truths:
    - "Supabase client utilities exist for both server and browser contexts"
    - "Middleware refreshes auth sessions on every request"
    - "Environment variables are structured with proper NEXT_PUBLIC_ prefixes"
    - "App Router route groups separate auth pages from dashboard pages"
    - "Theme provider enables dark mode support"
  artifacts:
    - path: "lib/supabase/server.ts"
      provides: "Server-side Supabase client with cookie handling"
      exports: ["createClient"]
    - path: "lib/supabase/client.ts"
      provides: "Browser-side Supabase client"
      exports: ["createClient"]
    - path: "middleware.ts"
      provides: "Auth session refresh and route protection"
      contains: "createServerClient"
    - path: ".env.example"
      provides: "Documentation of all required environment variables"
      contains: "NEXT_PUBLIC_SUPABASE_URL"
    - path: "app/(dashboard)/layout.tsx"
      provides: "Dashboard layout wrapper for authenticated routes"
      contains: "export default function DashboardLayout"
    - path: "components/providers/theme-provider.tsx"
      provides: "Dark mode theme provider using next-themes"
      contains: "ThemeProvider"
  key_links:
    - from: "middleware.ts"
      to: "lib/supabase/middleware.ts"
      via: "imports updateSession helper"
      pattern: "import.*updateSession.*middleware"
    - from: "lib/supabase/server.ts"
      to: ".env.local"
      via: "reads NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY"
      pattern: "process\\.env\\.NEXT_PUBLIC_SUPABASE"
    - from: "app/layout.tsx"
      to: "components/providers/theme-provider.tsx"
      via: "wraps children in ThemeProvider"
      pattern: "ThemeProvider"
---

<objective>
Configure Supabase client utilities for server and browser contexts, set up authentication middleware, create environment variable structure, and establish App Router route groups for authenticated vs public routes.

Purpose: Provides the data access layer and authentication infrastructure that every subsequent phase depends on. Without properly configured Supabase clients and middleware, no database operations or auth flows can work.

Output: Supabase server/browser clients, auth middleware, environment variable template, route group structure, and theme provider.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-environment/01-RESEARCH.md
@.planning/phases/01-foundation-environment/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase client utilities and auth middleware</name>
  <files>
    lib/supabase/client.ts
    lib/supabase/server.ts
    lib/supabase/middleware.ts
    middleware.ts
    .env.local
    .env.example
  </files>
  <action>
    Create Supabase client utilities following the official @supabase/ssr patterns from the research doc.

    1. Create `lib/supabase/client.ts` (browser client):
       ```typescript
       import { createBrowserClient } from '@supabase/ssr';

       export function createClient() {
         return createBrowserClient(
           process.env.NEXT_PUBLIC_SUPABASE_URL!,
           process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
         );
       }
       ```
       NOTE: Do NOT add 'use client' directive here. The browser client is imported by Client Components which already have it.

    2. Create `lib/supabase/server.ts` (server client):
       ```typescript
       import { createServerClient } from '@supabase/ssr';
       import { cookies } from 'next/headers';

       export async function createClient() {
         const cookieStore = await cookies();

         return createServerClient(
           process.env.NEXT_PUBLIC_SUPABASE_URL!,
           process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
           {
             cookies: {
               getAll() {
                 return cookieStore.getAll();
               },
               setAll(cookiesToSet) {
                 try {
                   cookiesToSet.forEach(({ name, value, options }) =>
                     cookieStore.set(name, value, options)
                   );
                 } catch {
                   // setAll is called from Server Component where cookies can't be set.
                   // This is expected in Server Components. Middleware handles the refresh.
                 }
               }
             }
           }
         );
       }
       ```
       NOTE: `cookies()` returns a Promise in Next.js 16 -- must use `await cookies()`.

    3. Create `lib/supabase/middleware.ts` (middleware helper):
       ```typescript
       import { createServerClient } from '@supabase/ssr';
       import { NextResponse, type NextRequest } from 'next/server';

       export async function updateSession(request: NextRequest) {
         let supabaseResponse = NextResponse.next({
           request,
         });

         const supabase = createServerClient(
           process.env.NEXT_PUBLIC_SUPABASE_URL!,
           process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
           {
             cookies: {
               getAll() {
                 return request.cookies.getAll();
               },
               setAll(cookiesToSet) {
                 cookiesToSet.forEach(({ name, value }) =>
                   request.cookies.set(name, value)
                 );
                 supabaseResponse = NextResponse.next({
                   request,
                 });
                 cookiesToSet.forEach(({ name, value, options }) =>
                   supabaseResponse.cookies.set(name, value, options)
                 );
               },
             },
           }
         );

         // IMPORTANT: Do NOT use supabase.auth.getSession() -- it doesn't refresh.
         // Always use getUser() which contacts the Supabase Auth server.
         const {
           data: { user },
         } = await supabase.auth.getUser();

         // Redirect unauthenticated users trying to access dashboard
         if (
           !user &&
           request.nextUrl.pathname.startsWith('/dashboard')
         ) {
           const url = request.nextUrl.clone();
           url.pathname = '/login';
           return NextResponse.redirect(url);
         }

         // IMPORTANT: Return the supabaseResponse, not a new NextResponse.
         // Failing to do so loses session cookie updates.
         return supabaseResponse;
       }
       ```

    4. Create `middleware.ts` at project root:
       ```typescript
       import { type NextRequest } from 'next/server';
       import { updateSession } from '@/lib/supabase/middleware';

       export async function middleware(request: NextRequest) {
         return await updateSession(request);
       }

       export const config = {
         matcher: [
           '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
         ],
       };
       ```

    5. Create `.env.local` with placeholder values (so dev server doesn't crash):
       ```
       # Supabase
       NEXT_PUBLIC_SUPABASE_URL=https://placeholder.supabase.co
       NEXT_PUBLIC_SUPABASE_ANON_KEY=placeholder-anon-key

       # Server-only (never prefixed with NEXT_PUBLIC_)
       SUPABASE_SERVICE_ROLE_KEY=placeholder-service-role-key
       ANTHROPIC_API_KEY=placeholder-anthropic-key

       # Google APIs (configured later in Phase 7)
       # GOOGLE_CLIENT_ID=
       # GOOGLE_CLIENT_SECRET=
       ```

    6. Create `.env.example` (committed to git, documents required vars):
       ```
       # Supabase - Get from: Supabase Dashboard -> Project Settings -> API
       NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
       NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

       # Server-only secrets - NEVER prefix with NEXT_PUBLIC_
       SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
       ANTHROPIC_API_KEY=your-anthropic-api-key

       # Google APIs (Phase 7)
       # GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
       # GOOGLE_CLIENT_SECRET=your-secret
       ```

    AVOID: Do NOT use `supabase.auth.getSession()` in middleware -- it reads from cookie without refreshing. Always use `getUser()`. Do NOT prefix server secrets with NEXT_PUBLIC_. Do NOT commit .env.local to git.
  </action>
  <verify>
    - `ls lib/supabase/client.ts lib/supabase/server.ts lib/supabase/middleware.ts middleware.ts` shows all files exist
    - `grep "createBrowserClient" lib/supabase/client.ts` confirms browser client pattern
    - `grep "createServerClient" lib/supabase/server.ts` confirms server client pattern
    - `grep "getUser" lib/supabase/middleware.ts` confirms using getUser (not getSession)
    - `grep "updateSession" middleware.ts` confirms middleware imports helper
    - `cat .env.example` shows all required environment variables documented
    - `grep ".env.local" .gitignore` confirms .env.local is gitignored
    - `npx tsc --noEmit` compiles without TypeScript errors
  </verify>
  <done>
    Supabase client utilities created for server (async cookie handling), browser, and middleware contexts. Auth middleware refreshes sessions on every request and redirects unauthenticated users. Environment variable structure established with .env.local (gitignored) and .env.example (committed).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create route groups, theme provider, and project structure</name>
  <files>
    app/(auth)/login/page.tsx
    app/(dashboard)/layout.tsx
    app/(dashboard)/page.tsx
    app/layout.tsx
    components/providers/theme-provider.tsx
  </files>
  <action>
    Set up the App Router route group structure and theme provider that all subsequent phases will build upon.

    1. Create `components/providers/theme-provider.tsx` (Client Component):
       ```typescript
       'use client';

       import * as React from 'react';
       import { ThemeProvider as NextThemesProvider } from 'next-themes';

       export function ThemeProvider({
         children,
         ...props
       }: React.ComponentProps<typeof NextThemesProvider>) {
         return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
       }
       ```

    2. Update `app/layout.tsx` to wrap children in ThemeProvider:
       ```tsx
       import type { Metadata } from "next";
       import { ThemeProvider } from "@/components/providers/theme-provider";
       import "./globals.css";

       export const metadata: Metadata = {
         title: "Prytaneum Investor CRM",
         description: "M&A investor pipeline management platform",
       };

       export default function RootLayout({
         children,
       }: Readonly<{
         children: React.ReactNode;
       }>) {
         return (
           <html lang="en" suppressHydrationWarning>
             <body className="antialiased">
               <ThemeProvider
                 attribute="class"
                 defaultTheme="dark"
                 enableSystem
                 disableTransitionOnChange
               >
                 {children}
               </ThemeProvider>
             </body>
           </html>
         );
       }
       ```
       NOTE: `suppressHydrationWarning` on html is required for next-themes to avoid hydration mismatch. Default theme is "dark" to match Valkyrie's dark/authoritative aesthetic.

    3. Create `app/(auth)/login/page.tsx` (placeholder login page):
       ```tsx
       import { Button } from "@/components/ui/button";
       import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";

       export default function LoginPage() {
         return (
           <div className="flex min-h-screen items-center justify-center">
             <Card className="w-[400px]">
               <CardHeader className="text-center">
                 <CardTitle className="text-2xl">Prytaneum Investor CRM</CardTitle>
                 <CardDescription>Sign in with your Google Workspace account</CardDescription>
               </CardHeader>
               <CardContent>
                 <Button className="w-full" size="lg">
                   Sign in with Google
                 </Button>
               </CardContent>
             </Card>
           </div>
         );
       }
       ```
       This is a placeholder -- actual Google OAuth integration happens in Phase 2.

    4. Create `app/(dashboard)/layout.tsx` (dashboard layout wrapper):
       ```tsx
       export default function DashboardLayout({
         children,
       }: {
         children: React.ReactNode;
       }) {
         return (
           <div className="min-h-screen bg-background">
             <header className="border-b">
               <div className="container mx-auto flex h-16 items-center px-4">
                 <h1 className="text-lg font-semibold">Prytaneum Investor CRM</h1>
               </div>
             </header>
             <main className="container mx-auto py-6 px-4">
               {children}
             </main>
           </div>
         );
       }
       ```

    5. Create `app/(dashboard)/page.tsx` (dashboard home placeholder):
       ```tsx
       import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";

       export default function DashboardPage() {
         return (
           <div className="space-y-6">
             <div>
               <h2 className="text-3xl font-bold tracking-tight">Dashboard</h2>
               <p className="text-muted-foreground">Investor pipeline overview</p>
             </div>
             <div className="grid gap-4 md:grid-cols-3">
               <Card>
                 <CardHeader>
                   <CardTitle>Total Investors</CardTitle>
                   <CardDescription>Active pipeline</CardDescription>
                 </CardHeader>
                 <CardContent>
                   <p className="text-3xl font-bold">0</p>
                 </CardContent>
               </Card>
               <Card>
                 <CardHeader>
                   <CardTitle>Active Conversations</CardTitle>
                   <CardDescription>In progress</CardDescription>
                 </CardHeader>
                 <CardContent>
                   <p className="text-3xl font-bold">0</p>
                 </CardContent>
               </Card>
               <Card>
                 <CardHeader>
                   <CardTitle>Next Actions Due</CardTitle>
                   <CardDescription>Upcoming tasks</CardDescription>
                 </CardHeader>
                 <CardContent>
                   <p className="text-3xl font-bold">0</p>
                 </CardContent>
               </Card>
             </div>
           </div>
         );
       }
       ```

    6. Update `app/page.tsx` (root route) to redirect to dashboard:
       ```tsx
       import { redirect } from "next/navigation";

       export default function Home() {
         redirect("/dashboard");
       }
       ```

    AVOID: Do NOT mark Server Components with 'use client'. Only ThemeProvider and future interactive components need it. Do NOT remove the (auth) and (dashboard) parentheses from route group names -- they are intentional Next.js route groups that don't affect URL paths.
  </action>
  <verify>
    - `ls app/\(auth\)/login/page.tsx app/\(dashboard\)/layout.tsx app/\(dashboard\)/page.tsx` shows route group structure exists
    - `grep "'use client'" components/providers/theme-provider.tsx` confirms Client Component
    - `grep "ThemeProvider" app/layout.tsx` confirms theme provider wrapping
    - `grep "suppressHydrationWarning" app/layout.tsx` confirms hydration fix
    - `npm run dev` starts without errors
    - Visiting localhost:3000 redirects to /dashboard and shows dashboard placeholder with styled cards
    - Visiting localhost:3000/login shows login card with Google sign-in button
    - `npx tsc --noEmit` compiles without TypeScript errors
  </verify>
  <done>
    Route group structure created: (auth) for login/callback, (dashboard) for authenticated routes. ThemeProvider wraps app with dark mode default. Login page shows Google sign-in placeholder. Dashboard shows pipeline overview with stat cards. Root route redirects to /dashboard.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. localhost:3000 redirects to /dashboard showing styled dashboard with cards
3. localhost:3000/login shows login card with Google sign-in button
4. `npx tsc --noEmit` reports no TypeScript errors
5. `ls lib/supabase/client.ts lib/supabase/server.ts lib/supabase/middleware.ts middleware.ts` all exist
6. `cat .env.example` documents all required environment variables
7. Dark theme is active by default
</verification>

<success_criteria>
- Supabase server, browser, and middleware clients created with proper cookie handling
- Auth middleware refreshes sessions and protects /dashboard routes
- Environment variables structured with .env.local and .env.example
- Route groups (auth) and (dashboard) established
- ThemeProvider with dark mode default wraps the application
- Login and dashboard placeholder pages render correctly with shadcn/ui components
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-environment/01-02-SUMMARY.md`
</output>
