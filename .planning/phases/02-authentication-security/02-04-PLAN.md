---
phase: 02-authentication-security
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - app/(dashboard)/audit-logs/page.tsx
  - app/(dashboard)/settings/users/page.tsx
  - components/audit/audit-log-table.tsx
  - components/admin/user-management-table.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can view global audit log page with searchable, filterable log entries"
    - "Member can view audit log page in read-only mode"
    - "Admin can view user management page showing all team members and their roles"
    - "Admin can change a user's role from the user management page"
    - "Member cannot access user management page"
    - "Full auth flow works end-to-end: login -> dashboard -> audit logs -> sign out"
  artifacts:
    - path: "app/(dashboard)/audit-logs/page.tsx"
      provides: "Global audit log page"
      min_lines: 30
    - path: "app/(dashboard)/settings/users/page.tsx"
      provides: "Admin-only user management page"
      min_lines: 30
    - path: "components/audit/audit-log-table.tsx"
      provides: "Audit log display with search and filter"
      min_lines: 50
    - path: "components/admin/user-management-table.tsx"
      provides: "User list with role assignment"
      min_lines: 40
  key_links:
    - from: "app/(dashboard)/audit-logs/page.tsx"
      to: "app_audit_log table"
      via: "Supabase query for audit entries"
      pattern: "from.*app_audit_log"
    - from: "app/(dashboard)/settings/users/page.tsx"
      to: "requireAdmin"
      via: "Server-side admin check before rendering"
      pattern: "requireAdmin"
    - from: "components/admin/user-management-table.tsx"
      to: "user_roles table"
      via: "Supabase query for role management"
      pattern: "from.*user_roles"
---

<objective>
Build the audit log viewer page (accessible to all authenticated users, read-only for members) and admin-only user management page (role assignment). Then verify the complete auth flow end-to-end with a human checkpoint.

Purpose: Completes AUTH-05 (audit logging UI) and AUTH-04 (role management UI). Provides the admin tools needed for user and security management. The checkpoint verifies the entire Phase 2 auth system works as a cohesive whole.
Output: Audit log page, user management page, verified end-to-end auth flow.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-security/02-RESEARCH.md
@.planning/phases/02-authentication-security/02-CONTEXT.md
@.planning/phases/02-authentication-security/02-03-SUMMARY.md
@types/auth.ts
@lib/supabase/auth-helpers.ts
@components/auth/role-guard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build audit log page and audit log table component</name>
  <files>
    app/(dashboard)/audit-logs/page.tsx
    components/audit/audit-log-table.tsx
  </files>
  <action>
    **Create audit log table component** (components/audit/audit-log-table.tsx):
    - 'use client'
    - Props: { entries: AuditLogEntry[] } (import from types/auth.ts)
    - Use shadcn/ui Table component (Table, TableBody, TableCell, TableHead, TableHeader, TableRow)
    - Columns: Timestamp (formatted), User Email, Event Type, Action, Resource Type, Resource ID, Details (expandable)
    - Add search input at top: filters entries client-side by user_email, event_type, action, resource_type (case-insensitive)
    - Add filter dropdowns: Event Type (all types from data), Action (create/update/delete/login/logout/etc.)
    - Use useState for search term and active filters
    - Format timestamps with Intl.DateTimeFormat for human-readable display
    - Details column: show old_data/new_data as expandable JSON (use a simple toggle or Collapsible from shadcn)
    - Empty state: "No audit log entries found" with subtle icon
    - Style with dark theme (zinc borders, subtle hover states)
    - Pagination: show 50 entries per page with simple prev/next controls

    **Create audit log page** (app/(dashboard)/audit-logs/page.tsx):
    - Server Component (default, no 'use client')
    - Import requireAuth from '@/lib/supabase/auth-helpers'
    - Call requireAuth() to ensure user is authenticated
    - Create server Supabase client
    - Query app_audit_log table: SELECT * ORDER BY created_at DESC LIMIT 200
    - Also query auth.audit_log_entries for recent auth events (logins, logouts): SELECT created_at, payload, ip_address FROM auth.audit_log_entries ORDER BY created_at DESC LIMIT 50
    - NOTE: auth.audit_log_entries may not be accessible via client. If not, query only app_audit_log and note that auth events from Supabase are viewable in Supabase Dashboard. Try the query; if it fails due to permissions, gracefully skip auth events.
    - Merge and sort both sources by timestamp
    - Pass entries to AuditLogTable component
    - Page title: "Audit Logs" with subtitle "All system activity and data changes"
    - Both admins and members can view (RLS policy allows SELECT for all authenticated)
    - Members see same data but cannot export (future: add export button gated with RoleGuard for admin only)
  </action>
  <verify>
    - app/(dashboard)/audit-logs/page.tsx exists, uses requireAuth, queries app_audit_log
    - components/audit/audit-log-table.tsx exists, renders Table with search and filter
    - Audit log table has search input and filter dropdowns
    - Timestamps are formatted for readability
    - Empty state handled gracefully
    - `npx tsc --noEmit` passes
  </verify>
  <done>Audit log page displays all system events with search and filtering. Both admins and members can view logs (AUTH-05).</done>
</task>

<task type="auto">
  <name>Task 2: Build admin-only user management page</name>
  <files>
    app/(dashboard)/settings/users/page.tsx
    components/admin/user-management-table.tsx
  </files>
  <action>
    **Create user management table component** (components/admin/user-management-table.tsx):
    - 'use client'
    - Props: { users: Array<{ id: string; email: string; role: AppRole; lastSignIn: string | null; createdAt: string }> }
    - Use shadcn/ui Table component
    - Columns: Email, Role (with badge), Last Sign In, Joined, Actions
    - Role column: show Badge with "Admin" (blue) or "Member" (gray)
    - Actions column: Role toggle button (admin-only action)
      - "Make Admin" button if user is member
      - "Make Member" button if user is admin
      - Use a Server Action or client-side Supabase mutation to update user_roles table
      - Confirm before role change with a simple confirm dialog
    - After role change: call logAuditEvent with event_type 'role_change'
    - Style with dark theme consistent with app

    **Create user management page** (app/(dashboard)/settings/users/page.tsx):
    - Server Component
    - Import requireAdmin from '@/lib/supabase/auth-helpers' (admin-only page)
    - Call requireAdmin() - redirects non-admins to /dashboard
    - Create server Supabase client
    - Query users: JOIN auth.users with public.user_roles to get email, role, last_sign_in_at, created_at
    - NOTE: auth.users may not be directly queryable from client. Alternative approach:
      - Query public.user_roles to get user_ids and roles
      - For each user_id, the email can be stored in user_roles table (add email column) OR use Supabase admin API
      - Simplest approach: Query user_roles and use supabase.auth.admin.listUsers() with service_role key if available
      - FALLBACK: If admin API not available from client, query user_roles joined with a profiles table. Since we don't have profiles yet, store email in user_roles or create a minimal profiles table.
      - PRACTICAL APPROACH: Create the UI with user_roles data. Email display will work once users have signed in and their data is in auth.users. Use server client with service role key to query auth.users if available.
    - Page title: "User Management" with subtitle "Manage team members and roles"
    - Show team size: "{N} team members"
    - Include "Add User" note: "New users are added automatically when they sign in with Google Workspace. Assign their role here."
  </action>
  <verify>
    - app/(dashboard)/settings/users/page.tsx exists, uses requireAdmin
    - components/admin/user-management-table.tsx exists, shows users with role badges
    - Role change functionality exists (even if untestable without real users)
    - Non-admin redirect works (requireAdmin redirects to /dashboard)
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
  </verify>
  <done>Admin-only user management page shows team members with role assignment. Non-admins are redirected. Role changes are audit logged.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete authentication flow end-to-end</name>
  <what-built>
    Complete Phase 2 authentication system:
    1. Branded login page with Google OAuth (Prytaneum/Valkyrie branding)
    2. Google OAuth PKCE flow with callback handler
    3. Session management with sliding expiration
    4. Auth provider with role-based access control
    5. Session expiry modal for re-authentication
    6. Audit log viewer page
    7. Admin-only user management page
    8. Sign-out functionality
  </what-built>
  <how-to-verify>
    **Prerequisites:** Before testing, ensure:
    1. SQL migrations (001-005) have been run in Supabase SQL Editor
    2. Auth Hook configured in Supabase Dashboard (Authentication > Hooks)
    3. Google OAuth configured in Supabase Dashboard (Authentication > Providers > Google)
    4. Google OAuth client created in Google Cloud Console with correct redirect URI

    **Test the flow:**
    1. Start dev server: `npm run dev`
    2. Visit http://localhost:3000 - should redirect to /login
    3. Verify login page shows: "Prytaneum Partners / Valkyrie Revival Fund Investor CRM Powered by VALHROS"
    4. Click "Sign in with Google" - should redirect to Google OAuth
    5. Complete Google sign-in - should redirect back to /dashboard
    6. Verify dashboard header shows user email and sign-out button
    7. Navigate to /audit-logs - page should load (may be empty initially)
    8. Navigate to /settings/users - should load for admin, redirect for member
    9. Click sign-out - should return to /login
    10. Try accessing /dashboard directly while logged out - should redirect to /login

    **Visual checks:**
    - Login page has dark Valkyrie aesthetic
    - Both Prytaneum and Valkyrie branding visible
    - Dashboard header is clean and professional
    - Audit log page has search and filter controls
  </how-to-verify>
  <resume-signal>Type "approved" to confirm Phase 2 auth is working, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
- Audit log page loads and displays entries from app_audit_log
- Audit log search filters entries in real-time
- User management page is admin-only (requireAdmin enforced)
- Role changes update user_roles table and create audit log entry
- Full flow verified: login -> dashboard -> audit logs -> settings -> sign out -> login redirect
</verification>

<success_criteria>
- AUTH-05 (audit logging): Global audit log page with search and filter, accessible to all authenticated users
- AUTH-04 (RBAC): User management page admin-only, role assignment functional
- End-to-end auth flow verified by human checkpoint
- All 5 AUTH requirements covered across Phase 2 plans:
  - AUTH-01: Google Workspace SSO (Plan 02)
  - AUTH-02: OAuth token management with re-consent (Plan 02 - access_type: offline, prompt: consent)
  - AUTH-03: Session persistence (Plan 02 middleware + Plan 03 session expiry modal)
  - AUTH-04: Role-based access control (Plan 01 DB + Plan 03 hooks + Plan 04 UI)
  - AUTH-05: Audit logging (Plan 01 DB + Plan 04 UI)
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-security/02-04-SUMMARY.md`
</output>
