---
phase: 02-authentication-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(auth)/login/page.tsx
  - app/(auth)/auth/callback/route.ts
  - lib/supabase/middleware.ts
  - app/(dashboard)/layout.tsx
autonomous: true
user_setup:
  - service: google-oauth
    why: "Google Workspace SSO authentication"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
    dashboard_config:
      - task: "Create Google OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add Supabase callback URL to Authorized redirect URIs"
        location: "Google Cloud Console -> Credentials -> OAuth Client -> Authorized redirect URIs. URL format: https://<project-ref>.supabase.co/auth/v1/callback"
      - task: "Set OAuth consent screen to Internal (Google Workspace only)"
        location: "Google Cloud Console -> APIs & Services -> OAuth consent screen"
      - task: "Configure Google provider in Supabase with Client ID and Secret"
        location: "Supabase Dashboard -> Authentication -> Providers -> Google"

must_haves:
  truths:
    - "Login page displays branded card with both Prytaneum and Valkyrie branding and full application title"
    - "Clicking Google sign-in button initiates OAuth redirect flow"
    - "After Google authentication, user is redirected back to app via callback route"
    - "Authenticated users are redirected away from login page to dashboard"
    - "Unauthenticated users accessing dashboard are redirected to login"
    - "User can sign out and is returned to login page"
  artifacts:
    - path: "app/(auth)/login/page.tsx"
      provides: "Branded login page with Google OAuth button"
      min_lines: 30
    - path: "app/(auth)/auth/callback/route.ts"
      provides: "OAuth callback handler for PKCE code exchange"
      exports: ["GET"]
    - path: "lib/supabase/middleware.ts"
      provides: "Enhanced middleware with login redirect and auth redirect"
  key_links:
    - from: "app/(auth)/login/page.tsx"
      to: "supabase.auth.signInWithOAuth"
      via: "Button click handler"
      pattern: "signInWithOAuth.*google"
    - from: "app/(auth)/auth/callback/route.ts"
      to: "supabase.auth.exchangeCodeForSession"
      via: "PKCE code exchange on callback"
      pattern: "exchangeCodeForSession"
    - from: "lib/supabase/middleware.ts"
      to: "supabase.auth.getUser"
      via: "Session validation on every request"
      pattern: "getUser"
---

<objective>
Implement the complete Google OAuth login flow: branded login page with Prytaneum/Valkyrie identity, PKCE-based OAuth redirect flow, callback handler for code exchange, middleware enhancements for authenticated/unauthenticated redirects, and sign-out functionality.

Purpose: Users must be able to authenticate with their Google Workspace accounts. This is the user-facing entry point to the application (AUTH-01, AUTH-03).
Output: Working Google OAuth login/logout flow with branded login page.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-security/02-RESEARCH.md
@.planning/phases/02-authentication-security/02-CONTEXT.md
@.planning/phases/01-foundation-environment/01-02-SUMMARY.md
@app/(auth)/login/page.tsx
@lib/supabase/middleware.ts
@lib/supabase/client.ts
@app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build branded login page with Google OAuth and callback route</name>
  <files>
    app/(auth)/login/page.tsx
    app/(auth)/auth/callback/route.ts
  </files>
  <action>
    **Replace the placeholder login page** (app/(auth)/login/page.tsx) with the branded version:
    - Mark as 'use client' (needs onClick handler for OAuth)
    - Import createClient from '@/lib/supabase/client'
    - Import Button, Card, CardContent, CardHeader, CardTitle, CardDescription from shadcn/ui
    - Display both **Prytaneum** and **Valkyrie** branding prominently
    - Full application title: "Prytaneum Partners / Valkyrie Revival Fund Investor CRM Powered by VALHROS"
    - Centered card layout (w-[450px]) with Google sign-in button
    - handleGoogleLogin function that calls supabase.auth.signInWithOAuth:
      - provider: 'google'
      - redirectTo: `${window.location.origin}/auth/callback`
      - queryParams: { access_type: 'offline', prompt: 'consent' } (ensures refresh token from Google)
    - Show error state if OAuth initiation fails (use useState for error message)
    - Include subtle tagline: "REVIVE. SCALE. THRIVE." below the title
    - Dark mode styling consistent with Valkyrie aesthetic (dark background, zinc/slate card)
    - Add a Google icon or "G" badge on the sign-in button for visual clarity
    - Handle `error` query parameter from callback failures: show error toast/message if ?error=auth_failed

    **Create OAuth callback route** (app/(auth)/auth/callback/route.ts):
    - Export GET handler
    - Extract `code` and `next` from URL search params
    - If code exists, create Supabase server client (use async cookies() pattern from Phase 1)
    - Call supabase.auth.exchangeCodeForSession(code)
    - On success: redirect to `next` parameter if it starts with '/' (prevent open redirect), otherwise redirect to '/dashboard'
    - On failure: redirect to '/login?error=auth_failed'
    - If no code present: redirect to '/login?error=auth_failed'

    Use redirect-based PKCE flow (NOT popup). This is the security best practice per research.
  </action>
  <verify>
    - app/(auth)/login/page.tsx exists, is 'use client', contains signInWithOAuth call with 'google' provider
    - app/(auth)/auth/callback/route.ts exists, exports GET, calls exchangeCodeForSession
    - Login page displays application title "Prytaneum Partners / Valkyrie Revival Fund Investor CRM Powered by VALHROS"
    - Callback validates `next` parameter starts with '/' to prevent open redirect
    - `npx tsc --noEmit` passes
  </verify>
  <done>Login page shows branded UI with Google OAuth button. Callback route exchanges PKCE code for session and redirects to dashboard.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance middleware and add sign-out to dashboard layout</name>
  <files>
    lib/supabase/middleware.ts
    app/(dashboard)/layout.tsx
  </files>
  <action>
    **Enhance middleware** (lib/supabase/middleware.ts):
    - Keep existing logic (getUser() for session refresh, redirect unauthenticated from /dashboard)
    - ADD: Redirect authenticated users away from /login to /dashboard (if user exists and path is /login, redirect to /dashboard)
    - ADD: Support for `next` parameter preservation: when redirecting to /login, include `?next={original_path}` so user returns to their intended page after login
    - Keep the IMPORTANT comment about getUser() vs getSession()
    - Ensure all protected routes under (dashboard) are covered (pathname.startsWith('/dashboard') OR pathname.startsWith('/audit-logs') OR pathname.startsWith('/settings'))
    - Actually, since these are all under the (dashboard) route group, they map to /dashboard/*, /audit-logs, /settings/users -- wait, route groups don't affect URLs. Check: if audit-logs is at app/(dashboard)/audit-logs/page.tsx, the URL is /audit-logs. Need to protect ALL routes except /login, /auth/callback, and static files. Simplify: protect everything except explicitly public routes.
    - Updated approach: Instead of checking pathname.startsWith('/dashboard'), check if path is NOT one of the public paths (/login, /auth/callback). If user is not authenticated and path is not public, redirect to /login.

    **Update dashboard layout** (app/(dashboard)/layout.tsx):
    - Import createClient from '@/lib/supabase/server' (server component)
    - Fetch user with getUser() at top of layout
    - If no user, redirect to /login (belt-and-suspenders with middleware)
    - Add sign-out button in the header (requires a client component or server action)
    - Create an inline sign-out form using a Server Action that calls supabase.auth.signOut() and redirects to /login
    - OR create a small client component for the sign-out button
    - Display user email in header next to sign-out button
    - Update header title to "Prytaneum Partners / Valkyrie CRM" (shorter for nav bar)
  </action>
  <verify>
    - Middleware redirects unauthenticated users from protected routes to /login
    - Middleware redirects authenticated users from /login to /dashboard
    - Dashboard layout shows user email and sign-out button in header
    - Sign-out button calls supabase.auth.signOut() and redirects to /login
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds
  </verify>
  <done>Middleware handles bidirectional auth redirects. Dashboard header shows user identity and sign-out. Full login-to-dashboard-to-logout flow works.</done>
</task>

</tasks>

<verification>
- Login page renders with branded Prytaneum/Valkyrie design
- Google sign-in button triggers OAuth redirect (will fail without Google OAuth configured in Supabase, but code path is correct)
- Callback route properly exchanges code for session
- Middleware redirects work in both directions (unauth -> login, auth -> dashboard)
- Sign-out clears session and returns to login
- No open redirect vulnerability in callback
- TypeScript compiles without errors
- Next.js build succeeds
</verification>

<success_criteria>
- AUTH-01 (Google Workspace SSO): Login page with Google OAuth button, PKCE flow, callback handler
- AUTH-03 (session persistence): Middleware refreshes session via getUser(), cookie-based sessions survive refresh
- Branded login page with full application title per CONTEXT.md decisions
- Sign-out functionality accessible from dashboard header
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-security/02-02-SUMMARY.md`
</output>
