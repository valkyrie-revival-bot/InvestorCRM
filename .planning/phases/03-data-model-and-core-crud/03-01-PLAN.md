---
phase: 03-data-model-and-core-crud
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/database/migrations/007_create_investors.sql
  - lib/database/migrations/008_create_contacts.sql
  - lib/database/migrations/009_create_activities.sql
  - lib/database/migrations/010_investor_rls_policies.sql
  - lib/database/migrations/011_investor_indexes.sql
  - types/investors.ts
autonomous: true

must_haves:
  truths:
    - "Investors table exists in Supabase PostgreSQL with all 20 data fields"
    - "Contacts table exists with foreign key to investors"
    - "Activities table exists with foreign key to investors and created_by to auth.users"
    - "RLS policies allow authenticated CRUD while hiding soft-deleted records from SELECT"
    - "TypeScript types for Investor, Contact, and Activity are importable"
  artifacts:
    - path: "lib/database/migrations/007_create_investors.sql"
      provides: "Investors table with 20 fields, timestamps, soft delete"
      contains: "create table public.investors"
    - path: "lib/database/migrations/008_create_contacts.sql"
      provides: "Contacts table with FK to investors"
      contains: "references public.investors"
    - path: "lib/database/migrations/009_create_activities.sql"
      provides: "Activities table with FK to investors and auth.users"
      contains: "references auth.users"
    - path: "lib/database/migrations/010_investor_rls_policies.sql"
      provides: "RLS policies for all three tables"
      contains: "enable row level security"
    - path: "types/investors.ts"
      provides: "TypeScript types for Investor, Contact, Activity, stage enum"
      exports: ["Investor", "Contact", "Activity", "InvestorStage"]
  key_links:
    - from: "types/investors.ts"
      to: "lib/database/migrations/007_create_investors.sql"
      via: "TypeScript types mirror database columns exactly"
      pattern: "firm_name.*string"
---

<objective>
Create the three-table database schema (investors, contacts, activities) with RLS policies, foreign key indexes, and TypeScript types.

Purpose: This is the foundational data layer for the entire investor pipeline CRM. All subsequent CRUD operations, views, and features depend on these tables existing with proper constraints.
Output: 5 SQL migration files and 1 TypeScript types file, ready for execution in Supabase SQL Editor.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-data-model-and-core-crud/03-CONTEXT.md
@.planning/phases/03-data-model-and-core-crud/03-RESEARCH.md
@types/auth.ts
@lib/database/migrations/001_create_user_roles.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQL migrations for investors, contacts, and activities tables</name>
  <files>
    lib/database/migrations/007_create_investors.sql
    lib/database/migrations/008_create_contacts.sql
    lib/database/migrations/009_create_activities.sql
  </files>
  <action>
Create three SQL migration files following the existing migration naming convention (007, 008, 009).

**007_create_investors.sql** - Create `public.investors` table with these exact columns:
- `id` uuid primary key default gen_random_uuid()
- `firm_name` text NOT NULL
- `relationship_owner` text NOT NULL
- `stage` text NOT NULL (free text, not enum - stages may change)
- `partner_source` text (nullable)
- `est_value` numeric(12, 2) (nullable)
- `entry_date` date (nullable)
- `last_action_date` date (nullable)
- `stalled` boolean default false
- `allocator_type` text (nullable)
- `internal_conviction` text (nullable)
- `internal_priority` text (nullable)
- `investment_committee_timing` text (nullable)
- `next_action` text (nullable)
- `next_action_date` date (nullable)
- `current_strategy_notes` text (nullable)
- `current_strategy_date` date (nullable)
- `last_strategy_notes` text (nullable)
- `last_strategy_date` date (nullable)
- `key_objection_risk` text (nullable)
- `created_at` timestamptz default now()
- `updated_at` timestamptz default now()
- `deleted_at` timestamptz (nullable - soft delete)
- `created_by` uuid references auth.users(id) (nullable - for tracking who created)

Add an `updated_at` trigger: Create a function `update_updated_at_column()` (if not exists) that sets `updated_at = now()` on UPDATE. Apply trigger to investors table.

**008_create_contacts.sql** - Create `public.contacts` table:
- `id` uuid primary key default gen_random_uuid()
- `investor_id` uuid NOT NULL references public.investors(id) ON DELETE RESTRICT
- `name` text NOT NULL
- `email` text (nullable)
- `phone` text (nullable)
- `title` text (nullable)
- `notes` text (nullable)
- `is_primary` boolean default false
- `created_at` timestamptz default now()
- `updated_at` timestamptz default now()
- `deleted_at` timestamptz (nullable - soft delete)

ON DELETE RESTRICT because we use soft delete - never hard delete investors. Apply same `updated_at` trigger.

**009_create_activities.sql** - Create `public.activities` table:
- `id` uuid primary key default gen_random_uuid()
- `investor_id` uuid NOT NULL references public.investors(id) ON DELETE RESTRICT
- `activity_type` text NOT NULL (values: 'note', 'call', 'email', 'meeting', 'stage_change', 'field_update')
- `description` text NOT NULL
- `metadata` jsonb (nullable - stores field changes, previous values)
- `created_by` uuid references auth.users(id)
- `created_at` timestamptz default now()

No `updated_at` or `deleted_at` on activities - they are immutable audit records.
  </action>
  <verify>
Read all three files and verify: (1) All 20 investor fields present, (2) Foreign keys use correct references syntax, (3) NOT NULL on required fields only (firm_name, relationship_owner, stage), (4) updated_at trigger created
  </verify>
  <done>Three SQL migration files exist with correct table definitions, constraints, and updated_at trigger</done>
</task>

<task type="auto">
  <name>Task 2: Create RLS policies, indexes, and TypeScript types</name>
  <files>
    lib/database/migrations/010_investor_rls_policies.sql
    lib/database/migrations/011_investor_indexes.sql
    types/investors.ts
  </files>
  <action>
**010_investor_rls_policies.sql** - RLS policies for all three tables:

Enable RLS on investors, contacts, activities.

For `investors`:
- SELECT: `to authenticated using (deleted_at is null)` — hides soft-deleted from normal queries
- INSERT: `to authenticated with check (true)`
- UPDATE: `to authenticated using (true) with check (true)` — CRITICAL: must use `using (true)` not `using (deleted_at is null)` so soft delete UPDATE operations work (see RESEARCH.md Pitfall 1)
- DELETE: `to authenticated using (true)` — allow hard delete as fallback (soft delete is app-level)

For `contacts`:
- SELECT: `to authenticated using (deleted_at is null)` — hide soft-deleted contacts
- INSERT: `to authenticated with check (true)`
- UPDATE: `to authenticated using (true) with check (true)` — same permissive pattern for soft delete
- DELETE: `to authenticated using (true)`

For `activities`:
- SELECT: `to authenticated using (true)` — all activities always visible
- INSERT: `to authenticated with check (true)`
- No UPDATE or DELETE policies — activities are immutable

**011_investor_indexes.sql** - Create performance indexes:
- `idx_contacts_investor_id` on contacts(investor_id)
- `idx_activities_investor_id` on activities(investor_id)
- `idx_activities_created_at` on activities(created_at DESC)
- `idx_investors_stage` on investors(stage) — for pipeline views
- `idx_investors_deleted_at` on investors(deleted_at) — for soft delete filtering
- `idx_investors_firm_name` on investors(firm_name) — for search
- `idx_contacts_is_primary` on contacts(investor_id, is_primary) WHERE is_primary = true — for quick primary contact lookup

**types/investors.ts** - TypeScript types mirroring the database schema:

Define these types:
- `InvestorStage` as a union type of stage strings: 'Not Yet Approached' | 'Initial Contact' | 'First Conversation Held' | 'Materials Shared' | 'NDA / Data Room' | 'Active Due Diligence' | 'LPA / Legal' | 'Won' | 'Committed' | 'Lost' | 'Passed' | 'Delayed'
- `AllocatorType` as a union type: 'Family Office' | 'HNWI' | 'Endowment' | 'Foundation' | 'Pension' | 'Fund of Funds' | 'Sovereign Wealth' | 'Insurance' | 'Other'
- `ActivityType` as a union type: 'note' | 'call' | 'email' | 'meeting' | 'stage_change' | 'field_update'
- `Investor` interface with all 20 fields + id, created_at, updated_at, deleted_at, created_by
- `Contact` interface with all fields + id, investor_id, created_at, updated_at, deleted_at
- `Activity` interface with all fields + id, investor_id, created_by, created_at
- `InvestorWithContacts` extending Investor with `contacts: Contact[]` and `primary_contact: Contact | null`
- `InvestorInsert` as Omit<Investor, 'id' | 'created_at' | 'updated_at' | 'deleted_at'> with firm_name, stage, relationship_owner required and all else optional
- `InvestorUpdate` as Partial<InvestorInsert>

Use string types for date fields (ISO format from Supabase), number | null for est_value. Do NOT import from Supabase generated types — define manually for clarity.
  </action>
  <verify>
Read types/investors.ts and verify: (1) InvestorStage has all stage values from CONTEXT.md, (2) Investor interface has exactly 20 data fields + meta fields, (3) InvestorInsert has correct required/optional split. Read SQL files and verify: (4) RLS UPDATE policy uses `using (true)` not `using (deleted_at is null)`, (5) Foreign key indexes exist.
  </verify>
  <done>RLS policies enable authenticated CRUD with soft delete support, indexes cover all foreign keys and common queries, TypeScript types are importable and match database schema exactly</done>
</task>

</tasks>

<verification>
- All 5 SQL migration files follow the existing naming convention (007-011)
- Investors table has exactly 20 data fields plus id, timestamps, soft delete, created_by
- Foreign keys reference correct tables with ON DELETE RESTRICT
- RLS UPDATE policies use `using (true)` (not filtered by deleted_at)
- Indexes cover all foreign keys and common query patterns
- TypeScript types match database columns 1:1
- types/investors.ts exports all necessary types for use by server actions and components
</verification>

<success_criteria>
- SQL migrations are ready to execute in Supabase SQL Editor (valid PostgreSQL syntax)
- TypeScript types compile without errors (`npx tsc --noEmit`)
- InvestorStage includes all stages from the stage definitions in PROJECT.md
- RLS policies protect all three tables while allowing soft delete operations
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-model-and-core-crud/03-01-SUMMARY.md`
</output>
