---
phase: 03-data-model-and-core-crud
plan: 05
type: execute
wave: 4
depends_on: ["03-03", "03-04"]
files_modified:
  - components/investors/delete-confirmation.tsx
  - app/(dashboard)/investors/[id]/page.tsx
  - app/(dashboard)/investors/page.tsx
  - app/layout.tsx
  - lib/scripts/migrate-excel.ts
  - package.json
autonomous: false

must_haves:
  truths:
    - "User can delete an investor with confirmation prompt"
    - "After deletion, undo toast appears for 10 seconds"
    - "Clicking undo restores the investor immediately"
    - "Deleted investors no longer appear in the investors list"
    - "Existing Excel data has been migrated into the database"
  artifacts:
    - path: "components/investors/delete-confirmation.tsx"
      provides: "Alert dialog for delete confirmation"
      contains: "AlertDialog"
    - path: "lib/scripts/migrate-excel.ts"
      provides: "One-time Excel migration script"
      contains: "XLSX"
  key_links:
    - from: "components/investors/delete-confirmation.tsx"
      to: "app/actions/investors.ts"
      via: "Calls softDeleteInvestor and restoreInvestor"
      pattern: "softDeleteInvestor|restoreInvestor"
    - from: "lib/scripts/migrate-excel.ts"
      to: "PRYTANEUM LP CRM.xlsx"
      via: "Reads Excel file and inserts into Supabase"
      pattern: "PRYTANEUM LP CRM"
---

<objective>
Implement delete confirmation with undo toast, set up Sonner toast provider, create the Excel migration script, and do a visual verification of the complete CRUD flow.

Purpose: Delete with undo completes the CRUD lifecycle. Migration script brings existing investor data into the system. Visual verification ensures the entire flow works end-to-end for non-technical users.
Output: Complete delete/restore flow, toast infrastructure, migration script, and verified CRUD operations.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-data-model-and-core-crud/03-CONTEXT.md
@.planning/phases/03-data-model-and-core-crud/03-RESEARCH.md
@.planning/phases/03-data-model-and-core-crud/03-03-SUMMARY.md
@.planning/phases/03-data-model-and-core-crud/03-04-SUMMARY.md
@app/actions/investors.ts
@app/(dashboard)/investors/[id]/page.tsx
@components/investors/investor-list-table.tsx
@app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement delete confirmation, undo toast, and Sonner setup</name>
  <files>
    components/investors/delete-confirmation.tsx
    app/(dashboard)/investors/[id]/page.tsx
    app/layout.tsx
  </files>
  <action>
Install shadcn/ui components:
```bash
npx shadcn@latest add sonner alert-dialog
```

**app/layout.tsx** — Add Sonner Toaster to root layout:
- Import `Toaster` from `@/components/ui/sonner` (shadcn/ui installs this)
- Add `<Toaster />` component inside the body, after children
- Position: bottom-right, theme: system (auto dark/light)
- This makes toast available across the entire app

**components/investors/delete-confirmation.tsx** — Client component ('use client'):

Props: `investorId: string`, `firmName: string`

Build a delete button + AlertDialog confirmation flow:

1. **Delete button**: Red-tinted ghost button with trash icon (lucide-react Trash2), shown in the detail page header
2. **Confirmation dialog** (shadcn/ui AlertDialog):
   - Title: "Delete {firmName}?"
   - Description: "This investor record will be moved to trash. You can undo this action within 10 seconds."
   - Cancel button: "Cancel"
   - Confirm button: "Delete" (red/destructive variant)
3. **On confirm**:
   - Call `softDeleteInvestor(investorId)` server action
   - Navigate to /investors using router.push()
   - Show toast via Sonner:
     ```
     toast.success(`"${firmName}" deleted`, {
       action: {
         label: 'Undo',
         onClick: async () => {
           await restoreInvestor(investorId);
           toast.success(`"${firmName}" restored`);
           router.push(`/investors/${investorId}`);
         },
       },
       duration: 10000, // 10 second window
     });
     ```
4. **Loading state**: Disable confirm button during deletion, show spinner

**app/(dashboard)/investors/[id]/page.tsx** — Update to include delete button:
- Add `DeleteConfirmation` component in the page header, next to the back link
- Pass investorId and firmName as props
- Keep the rest of the page unchanged (from Plan 04)
  </action>
  <verify>
Read all files. Verify: (1) Toaster component in root layout, (2) AlertDialog with confirmation text, (3) softDeleteInvestor called on confirm, (4) Toast with undo action shown after delete, (5) restoreInvestor called on undo click, (6) 10-second toast duration. Run `npx tsc --noEmit`.
  </verify>
  <done>Delete button shows confirmation dialog, performs soft delete, shows undo toast for 10 seconds, undo restores investor and navigates back to detail page</done>
</task>

<task type="auto">
  <name>Task 2: Create Excel migration script</name>
  <files>
    lib/scripts/migrate-excel.ts
    package.json
  </files>
  <action>
Install xlsx:
```bash
npm install xlsx
```

Add migration script to package.json:
```json
"scripts": {
  "migrate:excel": "npx tsx lib/scripts/migrate-excel.ts"
}
```
Also install tsx as dev dependency if not present: `npm install -D tsx`

**lib/scripts/migrate-excel.ts** — One-time migration script:

This is a Node.js script (not a server action). It reads the Excel file and inserts data into Supabase using the service role key.

1. **Read environment variables** from `.env.local` using dotenv or manual parsing:
   ```typescript
   import * as dotenv from 'dotenv';
   dotenv.config({ path: '.env.local' });
   ```
   Install dotenv: `npm install dotenv`

2. **Create Supabase admin client** using SUPABASE_SERVICE_ROLE_KEY (bypasses RLS)

3. **Read Excel file**: `XLSX.readFile('./PRYTANEUM LP CRM.xlsx')`, get first sheet, convert to JSON with `XLSX.utils.sheet_to_json()`

4. **Map Excel columns to database fields** — Column names from the Excel may not match exactly. Handle common variations:
   - 'Firm Name' or 'Firm' -> firm_name
   - 'Primary Contact' or 'Contact' -> primary contact name (separate entity)
   - 'Relationship Owner' or 'Owner' -> relationship_owner
   - 'Partner / Source' or 'Partner/Source' or 'Source' -> partner_source
   - 'Est. value' or 'Est Value' or 'Estimated Value' -> est_value
   - 'Stage' -> stage
   - 'Entry Date' -> entry_date
   - 'Last Action Date' -> last_action_date
   - 'Stalled' -> stalled (parse: 'Yes'|'TRUE'|true -> true, else false)
   - 'Allocator Type' -> allocator_type
   - 'Internal Conviction' -> internal_conviction
   - 'Internal Priority' -> internal_priority
   - 'Investment Committee Timing' -> investment_committee_timing
   - 'Next Action' -> next_action
   - 'Next Action Date' -> next_action_date
   - 'Current strategy notes' -> current_strategy_notes
   - 'Current strategy date' -> current_strategy_date
   - 'Last strategy notes' -> last_strategy_notes
   - 'Last strategy date' -> last_strategy_date
   - 'Key Objection / Risk' or 'Key Objection' -> key_objection_risk

5. **Handle Excel date values**: Excel dates may come as serial numbers (e.g., 44927). Use XLSX date utility or convert: `new Date((serialDate - 25569) * 86400 * 1000)`. Check if value is a number before converting. Validate result is a reasonable date (year between 2000-2030).

6. **Required field defaults** (best-effort import):
   - firm_name: fallback to 'Unknown Firm' if missing
   - stage: fallback to 'Initial Contact' if missing
   - relationship_owner: fallback to 'Unassigned' if missing

7. **For each row**:
   - Insert into investors table
   - If 'Primary Contact' column has a name: create a contact record with `is_primary: true` and just the name field

8. **Summary output**: Log success count, failure count, and details of any failures

9. **Idempotency check**: Before inserting, check if an investor with the same firm_name already exists. Skip if duplicate (prevents double-import).

Script should be safe to run multiple times without creating duplicates.
  </action>
  <verify>
Read the migration script. Verify: (1) Uses service role key for admin access, (2) Reads PRYTANEUM LP CRM.xlsx, (3) Maps all 20 Excel columns, (4) Handles Excel date serial numbers, (5) Has required field defaults, (6) Creates contact records for Primary Contact, (7) Has duplicate detection, (8) Logs summary. Check package.json has "migrate:excel" script.
  </verify>
  <done>Migration script can be run with `npm run migrate:excel` to import existing investor data from Excel file with error handling and duplicate prevention</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete CRUD lifecycle for investor records:
1. Database schema with 3 tables (investors, contacts, activities)
2. Quick create modal with 3 required fields
3. Investor list page with navigation
4. Detail page with inline editing for all 20 fields
5. Delete with confirmation and 10-second undo toast
6. Excel migration script for existing data
  </what-built>
  <how-to-verify>
**Pre-flight: Execute database migrations**
1. Open Supabase Dashboard -> SQL Editor
2. Execute migrations 007-011 in order (files in lib/database/migrations/)
3. Verify tables exist: `SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('investors', 'contacts', 'activities');`

**Run migration (if Excel file exists):**
4. Run `npm run migrate:excel` in terminal
5. Verify output shows successful imports and no errors

**Test CRUD flow:**
6. Start dev server: `npm run dev`
7. Navigate to http://localhost:3000/investors
8. Verify: Empty state OR migrated investor records visible in table
9. Click "New Investor" button -> modal should open
10. Fill in: Firm Name="Test Investor", Stage="Initial Contact", Relationship Owner="Test Owner"
11. Submit -> should redirect to detail page
12. Verify all 20 fields visible in 4 collapsible sections
13. Click on "Partner / Source" field -> should transform to input
14. Type "Test Source", click away -> should auto-save (check for saving indicator)
15. Refresh page -> edited value should persist
16. Click delete button -> confirmation dialog should appear
17. Confirm delete -> should redirect to /investors with undo toast
18. Click "Undo" within 10 seconds -> investor should be restored
19. Navigate back to /investors -> investor should be visible again

**Visual quality check:**
20. Is the interface clean and professional? (dark theme, consistent spacing)
21. Would a non-technical person understand how to use it?
22. Are collapsible sections labeled clearly?
  </how-to-verify>
  <resume-signal>Type "approved" to proceed to Phase 4, or describe any issues that need fixing</resume-signal>
</task>

</tasks>

<verification>
- Delete button triggers AlertDialog confirmation
- Soft delete sets deleted_at, removes from list
- Undo toast appears for 10 seconds and restores on click
- Toaster component exists in root layout
- Excel migration script runs without errors
- Migration handles date conversion and duplicate prevention
- Complete CRUD flow works end-to-end: create, read, edit, delete, restore
</verification>

<success_criteria>
- User can delete investor with confirmation and undo within 10 seconds
- Excel migration imports existing data with best-effort validation
- All 6 success criteria from Phase 3 are met (except export — deferred to Phase 7)
- Visual quality meets investor-grade standard for non-technical users
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-model-and-core-crud/03-05-SUMMARY.md`
</output>
