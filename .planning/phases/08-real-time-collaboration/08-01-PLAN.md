---
phase: 08-real-time-collaboration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/database/migrations/024-realtime-version-column.sql
  - lib/database/migrations/025-replica-identity-full.sql
  - types/investors.ts
  - types/realtime.ts
autonomous: true

must_haves:
  truths:
    - "Investor records have a version column with default value 1 for optimistic locking"
    - "Supabase Realtime receives full old/new records on investor UPDATE events"
    - "TypeScript types include version field and real-time payload types"
  artifacts:
    - path: "lib/database/migrations/024-realtime-version-column.sql"
      provides: "Version column for optimistic locking"
      contains: "ADD COLUMN version"
    - path: "lib/database/migrations/025-replica-identity-full.sql"
      provides: "Full replica identity for real-time old record tracking"
      contains: "REPLICA IDENTITY FULL"
    - path: "types/investors.ts"
      provides: "Updated Investor type with version field"
      contains: "version"
    - path: "types/realtime.ts"
      provides: "TypeScript types for real-time payloads and presence"
      contains: "PresenceState"
  key_links:
    - from: "types/investors.ts"
      to: "lib/database/migrations/024-realtime-version-column.sql"
      via: "version field alignment"
      pattern: "version.*number"
---

<objective>
Add database foundation for real-time collaboration: version column for optimistic locking, REPLICA IDENTITY FULL for change tracking, and TypeScript types for real-time payloads.

Purpose: Enable conflict detection and full change data capture that the real-time hooks (Plan 02) and UI wiring (Plan 03) depend on.
Output: SQL migration files ready for manual execution, updated investor types, new real-time types.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-real-time-collaboration/08-RESEARCH.md
@types/investors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migrations for version column and replica identity</name>
  <files>
    lib/database/migrations/024-realtime-version-column.sql
    lib/database/migrations/025-replica-identity-full.sql
  </files>
  <action>
    Create two SQL migration files:

    **024-realtime-version-column.sql:**
    - Add `version INTEGER NOT NULL DEFAULT 1` to investors table
    - Initialize existing rows: `UPDATE investors SET version = 1 WHERE version IS NULL;` (safety net)
    - Create composite index: `CREATE INDEX idx_investors_version ON investors(id, version);`
    - Add comment explaining optimistic locking pattern

    **025-replica-identity-full.sql:**
    - `ALTER TABLE investors REPLICA IDENTITY FULL;`
    - `ALTER TABLE activities REPLICA IDENTITY FULL;`
    - Add comment explaining that this enables full old/new record data in Supabase Realtime UPDATE/DELETE events
    - Note: With RLS, DELETE events still only return primary keys in payload.old (known limitation)

    Follow the existing migration naming convention (see lib/database/migrations/ for examples).
    These will be executed manually in Supabase SQL Editor (consistent with project pattern).
  </action>
  <verify>
    - Files exist at correct paths
    - SQL syntax is valid (no syntax errors visible)
    - Migration 024 adds version column with NOT NULL DEFAULT 1 and index
    - Migration 025 sets REPLICA IDENTITY FULL on investors and activities tables
  </verify>
  <done>Two migration files ready for manual execution in Supabase SQL Editor</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types for real-time collaboration</name>
  <files>
    types/investors.ts
    types/realtime.ts
  </files>
  <action>
    **types/investors.ts:**
    - Add `version: number;` field to the Investor interface (after `deleted_at`)
    - Ensure InvestorUpdate type excludes `version` from partial updates (version is managed by optimistic locking logic, not manual updates)

    **types/realtime.ts (new file):**
    Create TypeScript types for real-time payloads:
    ```typescript
    import type { Investor } from './investors'

    // Supabase Realtime payload types
    export type RealtimeEventType = 'INSERT' | 'UPDATE' | 'DELETE'

    export interface RealtimePayload<T> {
      eventType: RealtimeEventType
      new: T
      old: Partial<T>  // May only contain id for DELETE with RLS
      schema: string
      table: string
      commit_timestamp: string
    }

    // Presence state for tracking who is viewing/editing
    export interface PresenceState {
      user_id: string
      username: string
      avatar_url?: string
      viewing_record_id: string | null
      editing_field: string | null  // Which field is being edited
      online_at: string
    }

    // Connection status for UI indicators
    export type ConnectionStatus = 'connecting' | 'connected' | 'error' | 'closed'

    // Optimistic update result
    export interface OptimisticUpdateResult<T> {
      success: boolean
      conflict: boolean
      data?: T
      error?: string
    }
    ```

    Use the existing project patterns: export interfaces, JSDoc comments where helpful, no default exports.
  </action>
  <verify>
    - `types/investors.ts` contains `version: number` in Investor interface
    - `types/realtime.ts` exists with PresenceState, ConnectionStatus, OptimisticUpdateResult types
    - InvestorUpdate type excludes version field
    - No TypeScript compilation errors: `npx tsc --noEmit --pretty 2>&1 | head -30`
  </verify>
  <done>Investor type has version field, real-time types defined, no type errors</done>
</task>

</tasks>

<verification>
- Two migration SQL files exist in lib/database/migrations/
- types/investors.ts has version field in Investor interface
- types/realtime.ts exports PresenceState, ConnectionStatus, OptimisticUpdateResult
- `npx tsc --noEmit` passes (or only shows pre-existing errors)
</verification>

<success_criteria>
Database migrations are ready for manual execution. TypeScript types fully define the version column, real-time payloads, presence state, and optimistic update contracts needed by Plans 02 and 03.
</success_criteria>

<output>
After completion, create `.planning/phases/08-real-time-collaboration/08-01-SUMMARY.md`
</output>
