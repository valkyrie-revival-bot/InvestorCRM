---
phase: 08-real-time-collaboration
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - app/(dashboard)/investors/page.tsx
  - components/investors/pipeline-view-switcher.tsx
  - components/investors/realtime-investor-wrapper.tsx
  - app/(dashboard)/investors/[id]/page.tsx
  - components/investors/investor-detail-realtime.tsx
  - components/investors/presence-avatars.tsx
  - components/investors/connection-status-indicator.tsx
  - components/investors/inline-edit-field.tsx
autonomous: false

must_haves:
  truths:
    - "User sees live updates when teammate edits investor record (updates within 1 second)"
    - "User sees live updates when teammate moves investor in kanban view"
    - "System shows which users are currently viewing/editing each record"
    - "System prevents conflicting edits with optimistic locking mechanism"
  artifacts:
    - path: "components/investors/realtime-investor-wrapper.tsx"
      provides: "Client wrapper that connects real-time hooks to pipeline views"
      contains: "useRealtimeInvestors"
    - path: "components/investors/investor-detail-realtime.tsx"
      provides: "Client wrapper for investor detail with presence and optimistic locking"
      contains: "usePresence"
    - path: "components/investors/presence-avatars.tsx"
      provides: "Avatar row showing who is viewing/editing a record"
      contains: "PresenceState"
    - path: "components/investors/connection-status-indicator.tsx"
      provides: "Visual indicator for real-time connection status"
      contains: "ConnectionStatus"
  key_links:
    - from: "components/investors/realtime-investor-wrapper.tsx"
      to: "lib/hooks/use-realtime-investors.ts"
      via: "hook import and usage"
      pattern: "useRealtimeInvestors"
    - from: "components/investors/investor-detail-realtime.tsx"
      to: "lib/hooks/use-presence.ts"
      via: "presence tracking on detail page"
      pattern: "usePresence"
    - from: "components/investors/inline-edit-field.tsx"
      to: "lib/hooks/use-optimistic-update.ts"
      via: "version-checked field updates"
      pattern: "useOptimisticUpdate|version"
    - from: "app/(dashboard)/investors/page.tsx"
      to: "components/investors/realtime-investor-wrapper.tsx"
      via: "Server Component passes initial data to Client wrapper"
      pattern: "RealtimeInvestorWrapper"
---

<objective>
Wire real-time hooks into existing UI: pipeline page gets live investor updates, detail page gets presence indicators and optimistic locking, inline edit fields check version before saving.

Purpose: Satisfy all four COLLAB requirements by connecting the hooks (Plan 02) to the existing UI components.
Output: Live-updating pipeline views, presence avatars on detail pages, conflict-safe inline editing.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-real-time-collaboration/08-RESEARCH.md
@.planning/phases/08-real-time-collaboration/08-01-SUMMARY.md
@.planning/phases/08-real-time-collaboration/08-02-SUMMARY.md
@app/(dashboard)/investors/page.tsx
@app/(dashboard)/investors/[id]/page.tsx
@components/investors/pipeline-view-switcher.tsx
@components/investors/inline-edit-field.tsx
@components/investors/investor-kanban-board.tsx
@lib/hooks/use-realtime-investors.ts
@lib/hooks/use-presence.ts
@lib/hooks/use-optimistic-update.ts
@types/realtime.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire real-time updates into pipeline page and kanban view</name>
  <files>
    app/(dashboard)/investors/page.tsx
    components/investors/realtime-investor-wrapper.tsx
    components/investors/connection-status-indicator.tsx
  </files>
  <action>
    The pipeline page (app/(dashboard)/investors/page.tsx) is a Server Component that fetches investors and passes them to PipelineViewSwitcher. To add real-time, insert a Client Component wrapper between them.

    **components/investors/realtime-investor-wrapper.tsx (new):**
    - 'use client' directive
    - Import useRealtimeInvestors from lib/hooks/use-realtime-investors
    - Accept `initialInvestors: InvestorWithContacts[]` prop
    - Call `const { investors, connectionStatus } = useRealtimeInvestors(initialInvestors)`
    - Render `<ConnectionStatusIndicator status={connectionStatus} />` above the pipeline view
    - Render `<PipelineViewSwitcher investors={investors} />` with real-time investors
    - This means the PipelineViewSwitcher (and its child InvestorKanbanBoard) automatically receive live updates

    **components/investors/connection-status-indicator.tsx (new):**
    - 'use client' directive
    - Small status dot in the header area showing real-time connection state
    - 'connected': green dot with "Live" text (subtle, not prominent)
    - 'connecting': yellow dot with "Connecting..." text
    - 'error': red dot with "Offline" text
    - 'closed': gray dot with "Disconnected" text
    - Use Tailwind classes matching the dark theme (bg-emerald-500, bg-yellow-500, bg-red-500, bg-zinc-500)
    - Small component: a flex row with a 2x2 rounded-full dot and text-xs label

    **app/(dashboard)/investors/page.tsx (modify):**
    - Replace direct `<PipelineViewSwitcher investors={investorsWithStalled} />` with `<RealtimeInvestorWrapper initialInvestors={investorsWithStalled} />`
    - Import RealtimeInvestorWrapper from '@/components/investors/realtime-investor-wrapper'
    - The Server Component still fetches initial data (fast SSR), Client Component enhances with real-time

    This satisfies COLLAB-01 (live updates on edits) and COLLAB-02 (live updates on kanban moves) because:
    - When any user updates an investor (including stage changes via drag-and-drop), the database change triggers a postgres_changes event
    - useRealtimeInvestors receives the event and updates local state
    - PipelineViewSwitcher re-renders with updated data
    - InvestorKanbanBoard re-groups columns based on new stage values
  </action>
  <verify>
    - RealtimeInvestorWrapper exists with 'use client' directive
    - ConnectionStatusIndicator shows connection state
    - Investors page renders RealtimeInvestorWrapper instead of PipelineViewSwitcher directly
    - `npx tsc --noEmit --pretty 2>&1 | head -20` (no new type errors)
    - `npm run build 2>&1 | tail -20` (builds successfully)
  </verify>
  <done>Pipeline page shows live investor updates from all team members, with connection status indicator. Both table and kanban views reflect real-time changes.</done>
</task>

<task type="auto">
  <name>Task 2: Add presence indicators and optimistic locking to detail page</name>
  <files>
    app/(dashboard)/investors/[id]/page.tsx
    components/investors/investor-detail-realtime.tsx
    components/investors/presence-avatars.tsx
    components/investors/inline-edit-field.tsx
  </files>
  <action>
    **components/investors/presence-avatars.tsx (new):**
    - 'use client' directive
    - Accept `users: PresenceState[]` and optional `currentUserId: string` props
    - Render a row of small avatar circles (32x32) for each user viewing/editing the record
    - Exclude current user from display (don't show yourself)
    - Each avatar: first letter of username, colored background using a deterministic color based on user_id (hash to one of 6 Tailwind colors)
    - If user has editing_field set, show a small pencil icon on their avatar
    - Show tooltip on hover with username and "Viewing" or "Editing [field]"
    - Use Tooltip component from @/components/ui/tooltip
    - Animate presence with transition-opacity for smooth join/leave
    - If no other users present, render nothing (null)

    **components/investors/investor-detail-realtime.tsx (new):**
    - 'use client' directive
    - Wraps the detail page content with presence tracking
    - Accept props: `investorId: string`, `children: React.ReactNode`, `userId: string`
    - Call `usePresence(investorId)` to track who is viewing this record
    - Render `<PresenceAvatars users={onlineUsers} currentUserId={userId} />` at the top
    - Pass `onlineUsers` context down via React Context or just render avatars above children

    **app/(dashboard)/investors/[id]/page.tsx (modify):**
    - Wrap the detail content with `<InvestorDetailRealtime investorId={id} userId={user?.id || ''}>` ... `</InvestorDetailRealtime>`
    - Import InvestorDetailRealtime from '@/components/investors/investor-detail-realtime'
    - The presence avatars appear below the header, above the form sections

    **components/investors/inline-edit-field.tsx (modify):**
    - Add optional `version?: number` prop to InlineEditFieldProps
    - When version is provided AND useOptimisticUpdate is available:
      - On save (blur/Enter), if version prop exists, use the optimistic update hook's updateInvestor function instead of the server action directly
      - If conflict detected: show toast "This record was modified by another user. Please refresh." via sonner
      - Import toast from sonner
    - If version is NOT provided, fall back to existing updateInvestorField behavior (backward compatible)
    - Import useOptimisticUpdate from '@/lib/hooks/use-optimistic-update'
    - Since InlineEditField is already a 'use client' component, the hook can be used directly

    **Passing version to inline fields:**
    - The InvestorFormSections component passes investor data to InlineEditField
    - The investor object now includes `version` field (from Plan 01 type update)
    - Update InvestorFormSections to pass `version={investor.version}` to each InlineEditField
    - When optimistic update succeeds, the returned data includes the new version number â€” but since the real-time subscription will push the update, no manual version tracking is needed on the client

    This satisfies COLLAB-03 (presence indicators) and COLLAB-04 (optimistic locking).
  </action>
  <verify>
    - PresenceAvatars renders user avatars for other viewers
    - InvestorDetailRealtime wraps detail page with presence tracking
    - InlineEditField accepts version prop and uses optimistic locking when provided
    - Detail page shows presence avatars and uses version-checked updates
    - `npx tsc --noEmit --pretty 2>&1 | head -20`
    - `npm run build 2>&1 | tail -20` (builds successfully)
  </verify>
  <done>Detail page shows who else is viewing/editing, inline edits use version-checked updates that detect conflicts</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete real-time collaboration system:
    1. Live investor updates across all pipeline views (table + kanban)
    2. Presence indicators showing who is viewing/editing records
    3. Optimistic locking preventing conflicting edits
    4. Connection status indicator showing real-time link health
  </what-built>
  <how-to-verify>
    PREREQUISITE: Execute migrations 024 and 025 in Supabase SQL Editor first.

    1. Open the app in two different browser tabs (or two browsers if possible)
    2. Navigate to /investors in both tabs
    3. Verify connection status shows "Live" (green dot) in both tabs
    4. In Tab 1: Edit an investor's stage by dragging in kanban view
    5. In Tab 2: Verify the investor moves to the new stage within ~1 second (COLLAB-01, COLLAB-02)
    6. In Tab 1: Navigate to an investor detail page
    7. In Tab 2: Navigate to the SAME investor detail page
    8. Verify presence avatars show both users on the page (COLLAB-03)
    9. In Tab 1: Edit a field (e.g., est_value)
    10. In Tab 2: Try to edit the SAME field simultaneously
    11. One should succeed, the other should show a conflict message (COLLAB-04)
  </how-to-verify>
  <resume-signal>Type "approved" if real-time features work correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- Pipeline page uses RealtimeInvestorWrapper with useRealtimeInvestors hook
- Connection status indicator visible on pipeline page
- Detail page shows presence avatars for concurrent viewers
- Inline edit fields use version-checked updates when version prop provided
- All four COLLAB requirements verified:
  - COLLAB-01: Live updates on investor edits
  - COLLAB-02: Live updates on kanban stage changes
  - COLLAB-03: Presence indicators per record
  - COLLAB-04: Optimistic locking prevents conflicts
- `npm run build` succeeds
</verification>

<success_criteria>
All four COLLAB requirements are satisfied. Team members see live updates within 1 second, presence avatars show who is viewing each record, and optimistic locking prevents conflicting edits with clear user feedback.
</success_criteria>

<output>
After completion, create `.planning/phases/08-real-time-collaboration/08-03-SUMMARY.md`
</output>
